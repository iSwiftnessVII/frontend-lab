<div class="liba-theme container insumos-page">

    <!-- Catálogo de insumos -->
    <h2>Crear nuevo insumo en catálogo</h2>
    <section>
        <form class="form-grid" (submit)="crearCatalogo($event)">
            <div>
                <label for="catNombre">Nombre</label>
                <input id="catNombre" [(ngModel)]="catNombre" name="catNombre" required
                    placeholder="Ej: Guantes de nitrilo" />
            </div>
            <div>
                <label for="catItem">Item</label>
                <input id="catItem" type="number" min="1" step="1" [(ngModel)]="catItem" name="catItem" required placeholder="Ej: 1001" />
            </div>
            <div>
                <label for="catImagen">Imagen (opcional)</label>
                <input id="catImagen" type="file" accept="image/*" (change)="onCatImagenChange($event)" />
            </div>
            <div class="full-row">
                <label for="catDescripcion">Descripción</label>
                <textarea id="catDescripcion" [(ngModel)]="catDescripcion" name="catDescripcion" rows="2"></textarea>
            </div>
            <div class="actions"><button class="btn-compact" type="submit">Agregar al catálogo</button></div>
        </form>
        <p *ngIf="catalogoMsg" aria-live="polite" role="status">{{ catalogoMsg }}</p>
    </section>

    <h2>Catálogo de insumos</h2>
    <section>
        <div>
            <div class="filters-grid catalogo-filters">
                <div>
                    <label for="catalogoItemQ">Filtrar por item</label>
                    <input id="catalogoItemQ" [(ngModel)]="itemFiltro" (input)="filtrarCatalogoPorCampos()"
                        placeholder="Ej: 001" />
                </div>
                <div>
                    <label for="catalogoNombreQ">Filtrar por nombre</label>
                    <input id="catalogoNombreQ" [(ngModel)]="nombreFiltro" (input)="filtrarCatalogoPorCampos()"
                        placeholder="Ej: Guantes" />
                </div>
                <div class="reset-cell">
                    <button type="button" class="btn-reset-filtros" (click)="resetCatalogoPaginado()"
                        aria-label="Reiniciar filtros">Reiniciar filtros</button>
                </div>
            </div>

            <div class="cards-container">
                <p *ngIf="catalogoCargando">Cargando catálogo...</p>
                <div class="catalogo-stats" *ngIf="!catalogoCargando && catalogoResultados.length">
                    <span>Mostrando {{ catalogoResultados.length }} de {{ catalogoTotal || catalogoBase.length }}
                        insumos</span>
                </div>
                <div class="catalogo-cards">
                    <article class="catalog-card" *ngFor="let c of catalogoResultados; trackBy: trackByCatalogo"
                             (click)="onCatalogCardClick(c)" role="button" tabindex="0"
                             (keyup.enter)="onCatalogCardClick(c)" (keyup.space)="onCatalogCardClick(c)">
                        <div class="catalog-card-media">
                            <img [src]="getCatalogoImagenUrl(c.item)" alt="Imagen {{ c.nombre }}" (error)="onImgError($event)" />
                        </div>
                        <div class="card-name" [title]="c.nombre">
                            <span [innerHTML]="highlightField(c.nombre, 'nombre')"></span>
                            <span class="meta">Item: <strong>{{ c.item }}</strong></span>
                        </div>
                        <div class="card-desc" *ngIf="c.descripcion">{{ c.descripcion }}</div>
                    </article>
                </div>
                <div class="reset-cell" *ngIf="catalogoResultados.length < (catalogoTotal || 0)">
                    <button type="button" class="btn-load-more" (click)="cargarMasCatalogo()">Cargar más</button>
                </div>
                <p *ngIf="!catalogoCargando && !catalogoResultados.length">No hay elementos en el catálogo.</p>
            </div>
        </div>
    </section>

    <!-- Inventario de insumos -->
    <h2 *ngIf="item_catalogo != null">Inventario de insumos</h2>
    <section *ngIf="item_catalogo != null" #insumoFormSection>
    <form class="form-grid" (submit)="crearInsumo($event)">
            <div>
                <label for="item_catalogo">Item catálogo</label>
                <input #itemCatalogoInput id="item_catalogo" [(ngModel)]="item_catalogo" name="item_catalogo" required />
            </div>
            <div>
                <label for="nombre">Nombre</label>
                <input id="nombre" [(ngModel)]="nombre" name="nombre" required />
            </div>
            <div>
                <label for="cantidad_adquirida">Cantidad adquirida</label>
                <input id="cantidad_adquirida" type="number" [(ngModel)]="cantidad_adquirida" name="cantidad_adquirida"
                    required />
            </div>
            <div>
                <label for="cantidad_existente">Cantidad existente</label>
                <input id="cantidad_existente" type="number" [(ngModel)]="cantidad_existente" name="cantidad_existente"
                    required />
            </div>
            <div>
                <label for="presentacion">Presentación</label>
                <input id="presentacion" [(ngModel)]="presentacion" name="presentacion" />
            </div>
            <div>
                <label for="marca">Marca</label>
                <input id="marca" [(ngModel)]="marca" name="marca" />
            </div>
            <div>
                <label for="referencia">Referencia</label>
                <input id="referencia" [(ngModel)]="referencia" name="referencia" />
            </div>
            <div>
                <label for="ubicacion">Ubicación</label>
                <input id="ubicacion" [(ngModel)]="ubicacion" name="ubicacion" />
            </div>
            <div>
                <label for="fecha_adquisicion">Fecha de adquisición</label>
                <input id="fecha_adquisicion" type="date" [(ngModel)]="fecha_adquisicion" name="fecha_adquisicion" />
            </div>
            <div class="full-row">
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" [(ngModel)]="descripcion" name="descripcion" rows="2"></textarea>
            </div>

            <div class="full-row">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" [(ngModel)]="observaciones" name="observaciones" rows="2"></textarea>
            </div>
            <div class="actions">
                <button class="btn-compact" type="submit">Crear insumo</button>
            </div>
        </form>
        <p *ngIf="insumoMsg">{{ insumoMsg }}</p>
    </section>

    <h2>Lista de Insumos</h2>
    <!-- Tabla y detalles de insumos -->
    <section>
        <div class="filters-row insumos-filters">
            <div>
                <label for="insItemQ">Item catálogo</label>
                <input id="insItemQ" [(ngModel)]="insumosItemQ" (input)="filtrarInsumos()" />
            </div>
            <div>
                <label for="insNombreQ">Nombre</label>
                <input id="insNombreQ" [(ngModel)]="insumosNombreQ" (input)="filtrarInsumos()" />
            </div>
        </div>

        <div class="insumo-cards">
            <article class="insumo-card" *ngFor="let i of insumosFiltrados"
                     (click)="toggleInsumoCard(i)" role="button" tabindex="0"
                     (keyup.enter)="toggleInsumoCard(i)" (keyup.space)="toggleInsumoCard(i)">
                <button *ngIf="canDelete()" type="button" class="insumo-delete-btn" aria-label="Eliminar"
                        (click)="onDeleteInsumo(i, $event)">×</button>
                <div class="insumo-card-media">
                    <img [src]="getCatalogoImagenUrl(i.item_catalogo)" alt="Imagen {{ i.nombre }}" (error)="onImgError($event)" />
                </div>
                <div class="insumo-card-body">
                    <div class="insumo-title">{{ i.nombre }}</div>
                    <div class="insumo-meta">
                        <span class="meta">Item: {{ i.item_catalogo }}</span>
                        <span class="meta" *ngIf="i.marca">Marca: {{ i.marca }}</span>
                    </div>
                    <div class="insumo-stats">
                        <span class="chip chip-neutral" title="Cantidad adquirida">Adquirida: <strong>{{ i.cantidad_adquirida }}</strong></span>
                        <span class="chip chip-good" title="Cantidad existente">Existente: <strong>{{ i.cantidad_existente }}</strong></span>
                    </div>
                    <div class="insumo-progress" *ngIf="i.cantidad_adquirida">
                        <div class="insumo-progress-bar" [ngClass]="getExistenteClass(i)" [style.width.%]="getExistentePct(i)" aria-hidden="true"></div>
                    </div>
                    <div class="insumo-progress-legend" *ngIf="i.cantidad_adquirida">
                        <span>{{ getExistentePct(i) | number:'1.0-0' }}% disponible</span>
                    </div>

                    <div class="insumo-details" [class.open]="isInsumoExpanded(i)">
                        <div class="insumo-details-grid">
                            <div *ngIf="i.presentacion"><strong>Presentación:</strong> {{ i.presentacion }}</div>
                            <div *ngIf="i.referencia"><strong>Referencia:</strong> {{ i.referencia }}</div>
                            <div *ngIf="i.descripcion"><strong>Descripción:</strong> {{ i.descripcion }}</div>
                            <div *ngIf="i.ubicacion"><strong>Ubicación:</strong> {{ i.ubicacion }}</div>
                            <div *ngIf="i.fecha_adquisicion"><strong>Fecha de adquisición:</strong> {{ formatearFecha(i.fecha_adquisicion) }}</div>
                            <div *ngIf="i.observaciones"><strong>Observaciones:</strong> {{ i.observaciones }}</div>
                        </div>
                    </div>
                </div>
            </article>
        </div>
        <p *ngIf="!insumos?.length">No hay insumos cargados.</p>

        <!-- Panel de detalles adicionales -->
        <div *ngIf="mostrarDetalles" class="detalles-panel">
            <div class="detalles-header">
                <h3>Detalles del insumo</h3>
                <button type="button" (click)="mostrarDetalles = false">×</button>
            </div>
            <div class="detalles-content" *ngIf="insumoSeleccionado">
                <p><strong>Item:</strong> {{ insumoSeleccionado.item }}</p>
                <p><strong>Nombre:</strong> {{ insumoSeleccionado.nombre }}</p>
                <p><strong>Cantidad adquirida:</strong> {{ insumoSeleccionado.cantidad_adquirida }}</p>
                <p><strong>Cantidad existente:</strong> {{ insumoSeleccionado.cantidad_existente }}</p>
                <p><strong>Presentación:</strong> {{ insumoSeleccionado.presentacion }}</p>
                <p><strong>Marca:</strong> {{ insumoSeleccionado.marca }}</p>
                <p><strong>Descripción:</strong> {{ insumoSeleccionado.descripcion }}</p>
                <p><strong>Fecha de adquisición:</strong> {{ formatearFecha(insumoSeleccionado.fecha_adquisicion) }}</p>
                <p><strong>Ubicación:</strong> {{ insumoSeleccionado.ubicacion }}</p>
                <p *ngIf="insumoSeleccionado.observaciones"><strong>Observaciones:</strong> {{
                    insumoSeleccionado.observaciones }}</p>
            </div>
        </div>