<div class="liba-theme container insumos-page">
  <h1>
    <i class="fas fa-boxes"></i>
    | Gestión de Insumos
  </h1>

  <div class="dashboard-cards">
    <div class="action-card" (click)="toggleFormulario('crear')" [class.active]="formularioActivo === 'crear'">
      <i class="fas fa-plus-circle"></i>
      <span>Registrar Insumo</span>
    </div>
  </div>

  @if (formularioActivo === 'crear' && !esAuxiliar) {
    <div class="form-section">
      <h2>
        <i class="fas fa-plus-circle"></i>
        | Registrar Insumo
      </h2>
      <section>
        <form class="form-grid" (submit)="crearInsumo($event)">
          <div>
            <label for="ins_nombre">Nombre *</label>
            <input id="ins_nombre" name="ins_nombre" [(ngModel)]="nombre" required placeholder="Ej: Guantes nitrilo" />
          </div>

          <div>
            <label for="ins_presentacion">Presentación</label>
            <input id="ins_presentacion" name="ins_presentacion" [(ngModel)]="presentacion" placeholder="Ej: caja" />
          </div>

          <div>
            <label for="ins_cant_adq">Cantidad adquirida *</label>
            <input id="ins_cant_adq" name="ins_cant_adq" type="number" min="0" step="1" [(ngModel)]="cantidad_adquirida" required placeholder="Ej: 10" />
          </div>

          <div>
            <label for="ins_cant_exist">Cantidad existente *</label>
            <input id="ins_cant_exist" name="ins_cant_exist" type="number" min="0" step="1" [(ngModel)]="cantidad_existente" required placeholder="Ej: 7" />
          </div>

          <div>
            <label for="ins_marca">Marca</label>
            <input id="ins_marca" name="ins_marca" [(ngModel)]="marca" placeholder="Ej: 3M" />
          </div>

          <div>
            <label for="ins_referencia">Referencia</label>
            <input id="ins_referencia" name="ins_referencia" [(ngModel)]="referencia" placeholder="Ej: REF-001" />
          </div>

          <div>
            <label for="ins_fecha">Fecha de adquisición</label>
            <input id="ins_fecha" name="ins_fecha" type="date" [(ngModel)]="fecha_adquisicion" />
          </div>

          <div>
            <label for="ins_ubicacion">Ubicación</label>
            <input id="ins_ubicacion" name="ins_ubicacion" [(ngModel)]="ubicacion" placeholder="Ej: Almacén 1 / Estante A" />
          </div>

          <div>
            <label for="ins_imagen">Imagen</label>
            <input id="ins_imagen" name="ins_imagen" type="file" accept="image/*" (change)="onImagenChange($event)" />
            @if (imagenPreviewUrl) {
              <div class="image-preview">
                <img [src]="imagenPreviewUrl" alt="Vista previa" />
              </div>
            }
          </div>

          <div class="full-row">
            <label for="ins_descripcion">Descripción</label>
            <textarea id="ins_descripcion" name="ins_descripcion" rows="2" [(ngModel)]="descripcion"></textarea>
          </div>

          <div class="full-row">
            <label for="ins_observaciones">Observaciones</label>
            <textarea id="ins_observaciones" name="ins_observaciones" rows="2" [(ngModel)]="observaciones"></textarea>
          </div>

          <div class="actions">
            <button class="btn-compact" type="submit">Registrar</button>
          </div>
        </form>
      </section>
    </div>
  }

  <div class="list-section">
    <div class="list-top">
      <div class="search">
        <label for="ins_q">Buscar</label>
        <input id="ins_q" name="ins_q" [(ngModel)]="insumosQ" placeholder="Nombre, marca, referencia, ubicación..." />
      </div>
      <div class="actions">
        <button class="btn-compact" type="button" (click)="cargar()" [disabled]="cargando()">Recargar</button>
      </div>
    </div>

    @if (cargando()) {
      <div class="loading">Cargando…</div>
    } @else {
      @if (insumosFiltrados().length === 0) {
        <div class="empty">Sin registros</div>
      } @else {
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Existente</th>
                <th>Presentación</th>
                <th>Marca</th>
                <th>Referencia</th>
                <th>Ubicación</th>
                <th>Adquisición</th>
              </tr>
            </thead>
            <tbody>
              @for (i of insumosFiltrados(); track (i?.id ?? i)) {
                <tr>
                  <td>{{ i?.nombre }}</td>
                  <td>{{ i?.cantidad_existente }}</td>
                  <td>{{ i?.presentacion || '-' }}</td>
                  <td>{{ i?.marca || '-' }}</td>
                  <td>{{ i?.referencia || '-' }}</td>
                  <td>{{ i?.ubicacion || '-' }}</td>
                  <td>{{ i?.fecha_adquisicion || '-' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    }
  </div>
</div>
