<div class="liba-theme container insumos-page" (click)="onGlobalClick($event)">
<h1>
    <i class="fas fa-boxes"></i>
    | Insumos
  </h1>
    <!-- Catálogo de insumos -->
    <h2>Crear nuevo insumo en catálogo</h2>
    <section>
        <form class="form-grid" (submit)="crearCatalogo($event)">
            <div>


                <label for="catNombre">Nombre</label>
                <input id="catNombre" [(ngModel)]="catNombre" name="catNombre" required
                    placeholder="Ej: Guantes de nitrilo" />
            </div>
            <div>
                <label for="catItem">Item</label>
                <input id="catItem" type="number" min="1" step="1" [(ngModel)]="catItem" name="catItem" required placeholder="Ej: 1001" />
            </div>
                        <div>
                                                <label for="catImagen">Imagen
                                                    <span class="hint-icon" tabindex="0" data-tooltip="Peso máximo: 5 MB.">?</span>
                                                </label>
                                <input id="catImagen" type="file" accept="image/*" (change)="onCatImagenChange($event)" />
                        </div>
            <div class="full-row">
                <label for="catDescripcion">Descripción</label>
                <textarea id="catDescripcion" [(ngModel)]="catDescripcion" name="catDescripcion" rows="2"></textarea>
            </div>
            <div class="actions"><button class="btn-compact" type="submit">Agregar al catálogo</button></div>
        </form>
    
    </section>

    <h2>Catálogo de insumos</h2>
    <section>
        <div>
            <div class="filters-grid catalogo-filters">
                <div>
                    <label for="catalogoItemQ">Filtrar por item</label>
                    <input id="catalogoItemQ" [(ngModel)]="itemFiltro" (input)="filtrarCatalogoPorCampos()"
                        placeholder="Ej: 001" />
                </div>
                <div>
                    <label for="catalogoNombreQ">Filtrar por nombre</label>
                    <input id="catalogoNombreQ" [(ngModel)]="nombreFiltro" (input)="filtrarCatalogoPorCampos()"
                        placeholder="Ej: Guantes" />
                </div>
                <div class="reset-cell">
                    <button type="button" class="btn-reset-filtros" (click)="resetCatalogoPaginado()"
                        aria-label="Reiniciar filtros">Reiniciar filtros</button>
                </div>
            </div>

            <div class="cards-container">
                                @if (catalogoCargando) {
                                    <div class="catalogo-cards">
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                        <article class="catalog-card skeleton-card">
                                            <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                            <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                            <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                                        </article>
                                    </div>
                                }
                                @if (!catalogoCargando && catalogoResultados.length) {
                                    <div class="catalogo-stats">
                                        <span>Mostrando {{ catalogoResultados.length }} de {{ catalogoTotal || catalogoBase.length }} insumos</span>
                                    </div>
                                }
                                                <div class="catalogo-cards">
                                                    @for (c of catalogoResultados; track c.item) {
                                        <article class="catalog-card"
                                                        (contextmenu)="onCatalogContextMenu($event, c)"
                                                        (click)="onCatalogCardClick(c)" role="button" tabindex="0"
                                                        (keyup.enter)="onCatalogCardClick(c)" (keyup.space)="onCatalogCardClick(c)">
                                            <div class="catalog-card-media">
                                                <img [src]="getCatalogoImagenUrl(c.item)" alt="Imagen {{ c.nombre }}" (error)="onImgError($event)" />
                                            </div>
                                            <div class="card-name" [title]="c.nombre">
                                                <span [innerHTML]="highlightField(c.nombre, 'nombre')"></span>
                                                <span class="meta">Item: <strong>{{ c.item }}</strong></span>
                                            </div>
                                            @if (c.descripcion) {
                                                <div class="card-desc">{{ c.descripcion }}</div>
                                            }
                                        </article>
                                    }
                                </div>
                                
                                @if (!catalogoCargando && !catalogoResultados.length) {
                                    <p>No hay elementos en el catálogo.</p>
                                }
            </div>
        </div>
    </section>

    <!-- Inventario de insumos -->
        @if (item_catalogo != null) {
            <h2>Crear nuevo insumo</h2>
        }
        @if (item_catalogo != null) {
        <section #insumoFormSection>
    <form class="form-grid" (submit)="crearInsumo($event)">
            <div>
                <label for="item_catalogo">Item catálogo</label>
                <input #itemCatalogoInput id="item_catalogo" [(ngModel)]="item_catalogo" name="item_catalogo" required />
            </div>
            <div>
                <label for="nombre">Nombre</label>
                <input id="nombre" [(ngModel)]="nombre" name="nombre" required />
            </div>
            <div>
                <label for="cantidad_adquirida">Cantidad adquirida</label>
                <input id="cantidad_adquirida" type="number" [(ngModel)]="cantidad_adquirida" name="cantidad_adquirida"
                    required />
            </div>
            <div>
                <label for="cantidad_existente">Cantidad existente</label>
                <input id="cantidad_existente" type="number" [(ngModel)]="cantidad_existente" name="cantidad_existente"
                    required />
            </div>
            <div>
                <label for="presentacion">Presentación</label>
                <input id="presentacion" [(ngModel)]="presentacion" name="presentacion" />
            </div>
            <div>
                <label for="marca">Marca</label>
                <input id="marca" [(ngModel)]="marca" name="marca" />
            </div>
            <div>
                <label for="referencia">Referencia</label>
                <input id="referencia" [(ngModel)]="referencia" name="referencia" />
            </div>
            <div>
                <label for="ubicacion">Ubicación</label>
                <input id="ubicacion" [(ngModel)]="ubicacion" name="ubicacion" />
            </div>
            <div>
                <label for="fecha_adquisicion">Fecha de adquisición</label>
                <input id="fecha_adquisicion" type="date" [(ngModel)]="fecha_adquisicion" name="fecha_adquisicion" />
            </div>
            <div class="full-row">
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" [(ngModel)]="descripcion" name="descripcion" rows="2"></textarea>
            </div>

            <div class="full-row">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" [(ngModel)]="observaciones" name="observaciones" rows="2"></textarea>
            </div>
            <div class="actions">
                <button class="btn-compact" type="submit">Crear insumo</button>
            </div>
        </form>
        
    </section>
    }

        <!-- ===== Listado de insumos (tarjetas) al final de la página ===== -->
    <div>
        <h2>Listado de insumos</h2>
        <section>
            <div class="cards-container">
                
                <div class="filters-grid">
                    <div>
                        <label for="invItemQ">Filtrar por item</label>
                        <input id="invItemQ" [(ngModel)]="invItemFiltro" (input)="filtrarInsumosPorCampos()" placeholder="Ej: 001" />
                    </div>
                    <div>
                        <label for="invNombreQ">Filtrar por nombre</label>
                        <input id="invNombreQ" [(ngModel)]="invNombreFiltro" (input)="filtrarInsumosPorCampos()" placeholder="Ej: Guantes" />
                    </div>
                </div>
                @if (insumosCargando) {
                    <div class="catalogo-cards">
                        @for (s of skeletonInsumos; track $index) {
                            <article class="catalog-card skeleton-card">
                                <div class="catalog-card-media"><div class="skeleton-box"></div></div>
                                <div class="card-name"><span class="skeleton-line w-70"></span><span class="skeleton-line w-30"></span></div>
                                <div class="card-desc"><div class="skeleton-line w-90"></div></div>
                            </article>
                        }
                    </div>
                }
                @if (!insumosCargando && insumosList.length) {
                    <div class="catalogo-cards">
                                                  @for (ins of insumosList; track $index) {
                                                    <article class="catalog-card" role="button" tabindex="0" [class.open]="isOpen(ins)"
                                                                     (contextmenu)="onCatalogContextMenu($event, ins)"
                                                                     (click)="toggleOpen(ins)" (keyup.enter)="toggleOpen(ins)" (keyup.space)="toggleOpen(ins)">
                                <div class="catalog-card-media" *ngIf="ins.item_catalogo as ic">
                                    <img [src]="getCatalogoImagenUrl(ic)" alt="Imagen catálogo" (error)="onImgError($event)" />
                                </div>
                                <div class="card-name" [title]="ins.nombre">
                                    <span>{{ ins.nombre }}</span>
                                    <span class="meta">Item: <strong>{{ ins.item_catalogo }}</strong></span>
                                </div>
                                        <!-- Cantidad disponible arriba de los campos -->
                                        <div class="card-meta">
                                            <span class="meta">Cantidad disponible: <strong>{{ ins.cantidad_existente }}</strong></span>
                                        </div>
                                        <!-- Fila con número y botón Quitar -->
                                                        <div class="insumo-actions-row" (click)="$event.stopPropagation()">
                                            <input type="number" min="1" step="1"
                                                         [ngModel]="getRemoveQty(ins.id)"
                                                         (ngModelChange)="setRemoveQty(ins.id, $event)"
                                                         placeholder="Cantidad" />
                                                            <button type="button" class="btn-compact btn-remove"
                                                            [disabled]="isBusy(ins.id) || !isValidQty(getRemoveQty(ins.id))"
                                                                            (click)="$event.stopPropagation(); quitar(ins)">Quitar</button>
                                        </div>
                                                                        @if (isOpen(ins)) {
                                                            <div class="insumo-details-panel">
                                                                <div class="detail-row"><strong>Adquirida:</strong> {{ ins.cantidad_adquirida }}</div>
                                                                @if (ins.presentacion) { <div class="detail-row"><strong>Presentación:</strong> {{ ins.presentacion }}</div> }
                                                                @if (ins.marca) { <div class="detail-row"><strong>Marca:</strong> {{ ins.marca }}</div> }
                                                                @if (ins.referencia) { <div class="detail-row"><strong>Referencia:</strong> {{ ins.referencia }}</div> }
                                                                @if (ins.ubicacion) { <div class="detail-row"><strong>Ubicación:</strong> {{ ins.ubicacion }}</div> }
                                                                  @if (ins.fecha_adquisicion) { <div class="detail-row"><strong>Fecha adquisición:</strong> {{ ins.fecha_adquisicion | date:'yyyy-MM-dd' }}</div> }
                                                                @if (ins.descripcion) { <div class="detail-row"><strong>Descripción:</strong> {{ ins.descripcion }}</div> }
                                                                @if (ins.observaciones) { <div class="detail-row"><strong>Observaciones:</strong> {{ ins.observaciones }}</div> }
                                                                                                <div class="panel-actions">
                                                                                                    <button type="button" class="btn-delete"
                                                                                                                    [disabled]="isBusy(ins.id)"
                                                                                                                    (click)="$event.stopPropagation(); eliminar(ins)">
                                                                                                        Eliminar
                                                                                                    </button>
                                                                                                </div>
                                                            </div>
                                                        }
                            </article>
                        }
                    </div>
                }
                @if (!insumosCargando && !insumosList.length) {
                    <p>No hay insumos registrados.</p>
                }
            </div>
        </section>
    </div>

    <!-- Menú contextual (click derecho) para catálogo de insumos -->
    @if (contextMenuVisible) {
        <div class="context-menu" [style.left.px]="contextMenuX" [style.top.px]="contextMenuY" (click)="$event.stopPropagation()" (contextmenu)="$event.preventDefault()">
            <button type="button" class="ctx-item delete" (click)="onContextMenuEliminar()">Eliminar</button>
        </div>
    }
