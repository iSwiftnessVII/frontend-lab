<div class="liba-theme container insumos-page">
  @if (!esAuxiliar) {
    <div class="dashboard-cards">
      <div class="action-card" (click)="toggleFormulario('crear')" [class.active]="formularioActivo === 'crear'">
        <i class="fas fa-plus-circle"></i>
        <span>Registrar Insumo</span>
      </div>
    </div>
  }

  @if (formularioActivo === 'crear' && !esAuxiliar) {
    <div class="form-section">
      <section>
        <form class="form-grid" (submit)="crearInsumo($event)">
          <div>
            <label for="ins_nombre">Nombre *</label>
            <input id="ins_nombre" name="ins_nombre" [(ngModel)]="nombre" required placeholder="Ej: Guantes nitrilo" />
          </div>

          <div>
            <label for="ins_presentacion">Presentación</label>
            <input id="ins_presentacion" name="ins_presentacion" [(ngModel)]="presentacion" placeholder="Ej: caja" />
          </div>

          <div>
            <label for="ins_cant_adq">Cantidad adquirida *</label>
            <input id="ins_cant_adq" name="ins_cant_adq" type="number" min="0" step="1" [(ngModel)]="cantidad_adquirida" required placeholder="Ej: 10" />
          </div>

          <div>
            <label for="ins_cant_exist">Cantidad existente *</label>
            <input id="ins_cant_exist" name="ins_cant_exist" type="number" min="0" step="1" [(ngModel)]="cantidad_existente" required placeholder="Ej: 7" />
          </div>

          <div>
            <label for="ins_marca">Marca</label>
            <input id="ins_marca" name="ins_marca" [(ngModel)]="marca" placeholder="Ej: 3M" />
          </div>

          <div>
            <label for="ins_referencia">Referencia</label>
            <input id="ins_referencia" name="ins_referencia" [(ngModel)]="referencia" placeholder="Ej: REF-001" />
          </div>

          <div>
            <label for="ins_fecha">Fecha de adquisición</label>
            <input id="ins_fecha" name="ins_fecha" type="date" [(ngModel)]="fecha_adquisicion" />
          </div>

          <div>
            <label for="ins_ubicacion">Ubicación</label>
            <input id="ins_ubicacion" name="ins_ubicacion" [(ngModel)]="ubicacion" placeholder="Ej: Almacén 1 / Estante A" />
          </div>

          <div>
            <label for="ins_imagen">Imagen</label>
            <input id="ins_imagen" name="ins_imagen" type="file" accept="image/*" (change)="onImagenChange($event)" />
            @if (imagenPreviewUrl) {
              <div class="image-preview">
                <img [src]="imagenPreviewUrl" alt="Vista previa" />
              </div>
            }
          </div>

          <div class="full-row">
            <label for="ins_descripcion">Descripción</label>
            <textarea id="ins_descripcion" name="ins_descripcion" rows="2" [(ngModel)]="descripcion"></textarea>
          </div>

          <div class="full-row">
            <label for="ins_observaciones">Observaciones</label>
            <textarea id="ins_observaciones" name="ins_observaciones" rows="2" [(ngModel)]="observaciones"></textarea>
          </div>

          <div class="actions">
            <button class="btn-compact" type="submit">Registrar</button>
          </div>
        </form>
      </section>
    </div>
  }

  <div class="list-section">
    <div class="list-top">
      <div class="search">
        <label for="ins_q">Buscar</label>
        <input id="ins_q" name="ins_q" [(ngModel)]="insumosQ" placeholder="Nombre, marca, referencia, ubicación..." />
      </div>
      <div class="actions">
        <button class="btn-compact" type="button" (click)="cargar()" [disabled]="cargando()">Recargar</button>
      </div>
    </div>

    @if (cargando()) {
      <div class="sin-equipos">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando insumos...</p>
      </div>
    } @else {
      @if (insumosFiltrados().length === 0) {
        <p class="sin-equipos">No hay insumos para mostrar</p>
      } @else {
        <div class="equipos-grid">
          <div class="fade-in">
            @for (i of insumosFiltrados(); track insumoKey(i, $index)) {
              @let key = insumoKey(i, $index);
              @let img = resolveInsumoImageUrl(i);
              <article
                class="equipo-card insumo-card"
                (click)="toggleInsumoDetails(key)"
                [attr.aria-expanded]="detallesVisibles[key] ? 'true' : 'false'"
                tabindex="0"
              >
                <div class="insumo-card-row">
                  <div class="insumo-card-image">
                    @if (img) {
                      <img [src]="img" [alt]="'Imagen de ' + (i?.nombre || 'insumo')" (error)="onInsumoImgError(i, img)" />
                    } @else {
                      <div class="insumo-card-image-fallback" aria-hidden="true">
                        <i class="fas fa-image"></i>
                      </div>
                    }
                  </div>

                  <div class="insumo-card-main">
                    <div class="card-top">
                      <div class="tags">
                        <span class="tag"><strong>ID:</strong> {{ key }}</span>
                        <span class="tag"><strong>Existente:</strong> {{ i?.cantidad_existente ?? '—' }}</span>
                        <span class="tag"><strong>Presentación:</strong> {{ i?.presentacion || '—' }}</span>
                        <span class="tag"><strong>Marca:</strong> {{ i?.marca || '—' }}</span>
                        <span class="tag"><strong>Referencia:</strong> {{ i?.referencia || '—' }}</span>
                      </div>
                      <div class="pdf-actions">
                        @if (canDelete()) {
                          <button type="button" class="pdf-btn edit"
                                  title="Editar insumo"
                                  aria-label="Editar insumo"
                                  (click)="$event.stopPropagation(); editInsumo(i)">
                            <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Z" fill="currentColor" />
                              <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z" fill="currentColor" />
                            </svg>
                          </button>
                          <button type="button" class="pdf-btn delete"
                                  title="Eliminar insumo"
                                  aria-label="Eliminar insumo"
                                  (click)="$event.stopPropagation(); deleteInsumo(i)">
                            <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                              <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            </svg>
                          </button>
                        }
                      </div>
                    </div>

                    <div class="card-name">
                      <div class="name-line">{{ i?.nombre || '—' }}</div>
                      <div class="meta-line">
                        <span class="chip">Ubicación: {{ i?.ubicacion || '—' }}</span>
                        <span class="chip">Adquisición: {{ limpiarFecha(i?.fecha_adquisicion) }}</span>
                      </div>
                      @if (canEditInsumos) {
                        <div class="card-right-controls" (click)="$event.stopPropagation()">
                          <div class="qty-field">
                            <input class="qty-input" type="number" min="1" step="1" [(ngModel)]="reduceCantidadByKey[key]" placeholder="0" />
                            <button type="button" class="pdf-btn delete qty-reduce-btn" [disabled]="isReduciendo(key)"
                                    (click)="reducirExistencias(i, key, $event)"
                                    title="Reducir existencias" aria-label="Reducir existencias">
                              <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
                                <rect x="3" y="3" width="18" height="18" rx="6" fill="none" stroke="currentColor" stroke-width="1.6"></rect>
                                <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                      }
                      <span class="toggle-icon" [class.open]="detallesVisibles[key]" aria-hidden="true">▾</span>
                    </div>

                    @if (detallesVisibles[key]) {
                      <div class="equipo-detalles" (click)="$event.stopPropagation()">
                        <div class="detalle-grid-compacto">
                          <div class="detalle-item">
                            <div class="detalle-label">Cantidad adquirida</div>
                            <span>{{ i?.cantidad_adquirida ?? '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Cantidad existente</div>
                            <span>{{ i?.cantidad_existente ?? '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Presentación</div>
                            <span>{{ i?.presentacion || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Marca</div>
                            <span>{{ i?.marca || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Referencia</div>
                            <span>{{ i?.referencia || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Ubicación</div>
                            <span>{{ i?.ubicacion || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Fecha adquisición</div>
                            <span>{{ limpiarFecha(i?.fecha_adquisicion) }}</span>
                          </div>
                          <div class="detalle-item detalle-item-full">
                            <div class="detalle-label">Descripción</div>
                            <span>{{ i?.descripcion || '—' }}</span>
                          </div>
                          <div class="detalle-item detalle-item-full">
                            <div class="detalle-label">Observaciones</div>
                            <span>{{ i?.observaciones || '—' }}</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </article>
            }
          </div>
        </div>
      }
    }
  </div>
</div>

@if (editInsumoModalOpen || editInsumoModalClosing) {
  <div class="modal-overlay" [class.closing]="editInsumoModalClosing" (click)="closeEditInsumoModal()">
    <div class="edit-modal" [class.closing]="editInsumoModalClosing" (click)="$event.stopPropagation()">
      <h3>Editar insumo #{{ editInsumoId }}</h3>

      <div class="edit-modal-body">
        <div class="form-grid">
          <div>
            <label>Nombre *</label>
            <input [(ngModel)]="editNombre" />
          </div>
          <div>
            <label>Presentación</label>
            <input [(ngModel)]="editPresentacion" />
          </div>
          <div>
            <label>Cantidad adquirida *</label>
            <input type="number" min="0" step="1" [(ngModel)]="editCantidadAdquirida" />
          </div>
          <div>
            <label>Marca</label>
            <input [(ngModel)]="editMarca" />
          </div>
          <div>
            <label>Referencia</label>
            <input [(ngModel)]="editReferencia" />
          </div>
          <div>
            <label>Fecha de adquisición</label>
            <input type="date" [(ngModel)]="editFechaAdquisicion" />
          </div>
          <div>
            <label>Ubicación</label>
            <input [(ngModel)]="editUbicacion" />
          </div>
          <div>
            <label>Imagen</label>
            <input type="file" accept="image/*" (change)="onEditImagenChange($event)" />
            @if (editImagenPreviewUrl) {
              <div class="image-preview">
                <img [src]="editImagenPreviewUrl" alt="Vista previa" />
              </div>
            }
          </div>
          <div class="full-row">
            <label>Descripción</label>
            <textarea rows="2" [(ngModel)]="editDescripcion"></textarea>
          </div>
          <div class="full-row">
            <label>Observaciones</label>
            <textarea rows="2" [(ngModel)]="editObservaciones"></textarea>
          </div>
        </div>
      </div>

      <div class="edit-modal-actions">
        <button type="button" class="btn-compact" (click)="saveEditInsumo()">Guardar</button>
        <button type="button" class="btn-compact" (click)="closeEditInsumoModal()">Cancelar</button>
      </div>
    </div>
  </div>
}
