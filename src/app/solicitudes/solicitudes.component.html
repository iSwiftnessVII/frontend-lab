<div class="liba-theme container equipos-page">
  <h1>
    <i class="fas fa-clipboard-list"></i>
    | Solicitudes
  </h1>
  
  <h2>Agregar cliente</h2>
  
  <!-- SECCI√ìN: Agregar cliente -->
  <section>
    <form (submit)="createCliente($event)">
      <div class="form-grid">

        <!-- Nombre -->
        <div class="form-field">
          <label for="clienteNombre">Nombre:</label>
          <input id="clienteNombre" [(ngModel)]="clienteNombre" name="clienteNombre" required
            [class.error]="clienteErrors['nombre']" placeholder="Ej: Juan P√©rez" />
          @if (clienteErrors['nombre']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['nombre'] }}
            </small>
          }
        </div>

        <!-- N√∫mero -->
        <div class="form-field">
          <label for="clienteNumero">Consecutivo:</label>
          <input id="clienteNumero" type="number" [(ngModel)]="clienteNumero" name="clienteNumero"
            [class.error]="clienteErrors['numero']" placeholder="Ej: 101" readonly aria-readonly="true" title="Asignado autom√°ticamente" />
          @if (clienteErrors['numero']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['numero'] }}
            </small>
          }
        </div>

        <!-- Fecha vinculaci√≥n -->
        <div class="form-field">
          <label for="clienteFechaVinc">Fecha vinculaci√≥n:</label>
          <input id="clienteFechaVinc" type="date" [(ngModel)]="clienteFechaVinc" name="clienteFechaVinc"
            [class.error]="clienteErrors['fechaVinc']" placeholder="Ej: 2025-11-24" />
          @if (clienteErrors['fechaVinc']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['fechaVinc'] }}
            </small>
          }
        </div>

        <!-- Tipo usuario -->
        <div class="form-field">
          <label for="clienteTipoUsuario">Tipo cliente:</label>
          <select id="clienteTipoUsuario" [(ngModel)]="clienteTipoUsuario" name="clienteTipoUsuario"
            [class.error]="clienteErrors['tipoUsuario']">
            <option value="">Seleccionar tipo de cliente</option>
            @for (tipo of tiposCliente; track tipo) {
              <option [value]="tipo">{{ tipo }}</option>
            }
          </select>
          @if (clienteErrors['tipoUsuario']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['tipoUsuario'] }}
            </small>
          }
        </div>

        <!-- Raz√≥n social -->
        <div class="form-field">
          <label for="clienteRazonSocial">Raz√≥n social:</label>
          <input id="clienteRazonSocial" [(ngModel)]="clienteRazonSocial" name="clienteRazonSocial"
            [class.error]="clienteErrors['razonSocial']" placeholder="Ej: Industrias SENA S.A.S." />
          @if (clienteErrors['razonSocial']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['razonSocial'] }}
            </small>
          }
        </div>

        <!-- NIT -->
        <div class="form-field">
          <label for="clienteNit">NIT:</label>
          <input id="clienteNit" [(ngModel)]="clienteNit" name="clienteNit"
            [class.error]="clienteErrors['nit']" placeholder="Ej: 900123456-7" />
          @if (clienteErrors['nit']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['nit'] }}
            </small>
          }
        </div>

        <!-- Tipo identificaci√≥n -->
        <div class="form-field">
          <label for="clienteTipoId">Tipo identificaci√≥n:</label>
          <select id="clienteTipoId" [(ngModel)]="clienteTipoId" name="clienteTipoId"
            [class.error]="clienteErrors['tipoId']">
            <option value="">Seleccionar tipo de id</option>
            @for (tipo of tiposIdentificacion; track tipo.value) {
              <option [value]="tipo.value">{{ tipo.label }}</option>
            }
          </select>
          @if (clienteErrors['tipoId']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['tipoId'] }}
            </small>
          }
        </div>

        <!-- N√∫mero identificaci√≥n -->
        <div class="form-field">
          <label for="clienteIdNum">N√∫mero identificaci√≥n:</label>
          <input id="clienteIdNum" [(ngModel)]="clienteIdNum" name="clienteIdNum" required
            [class.error]="clienteErrors['idNum']" placeholder="Ej: 12345678" />
          @if (clienteErrors['idNum']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['idNum'] }}
            </small>
          }
        </div>

        <!-- Sexo -->
        <div class="form-field">
          <label for="clienteSexo">Sexo:</label>
          <select id="clienteSexo" [(ngModel)]="clienteSexo" name="clienteSexo"
            [class.error]="clienteErrors['sexo']">
            <option value="">Seleccione el sexo</option>
            @for (sexo of opcionesSexo; track sexo.value) {
              <option [value]="sexo.value">{{ sexo.label }}</option>
            }
          </select>
          @if (clienteErrors['sexo']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['sexo'] }}
            </small>
          }
        </div>

        <!-- Tipo de comunidad -->
        <div class="form-field">
          <label for="clienteTipoPobl">Tipo de comunidad:</label>
          <select id="clienteTipoPobl" [(ngModel)]="clienteTipoPobl" name="clienteTipoPobl"
            (ngModelChange)="handleTipoPoblChange($event)"
            [class.error]="clienteErrors['tipoPobl']">
            <option value="">Seleccionar tipo de comunidad</option>
            @for (comunidad of tiposComunidad; track comunidad) {
              <option [value]="comunidad">{{ comunidad }}</option>
            }
            @for (opt of clienteTipoPoblCustomOptions; track opt) {
              <option [value]="opt">{{ opt }}</option>
            }
          </select>
          @if (clienteErrors['tipoPobl']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['tipoPobl'] }}
            </small>
          }
        </div>

        @if (showTipoPoblModal) {
          <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.35)">
            <div style="background:#fff;padding:16px;border-radius:6px;min-width:320px;max-width:90%">
              <h3>Especificar comunidad</h3>
              <textarea [(ngModel)]="modalTipoPoblText" name="modalTipoPoblText" rows="4" style="width:100%;box-sizing:border-box"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button type="button" (click)="confirmTipoPoblModal()">Guardar</button>
                <button type="button" (click)="cancelTipoPoblModal()">Cancelar</button>
              </div>
            </div>
          </div>
        }

        <!-- Direcci√≥n -->
        <div class="form-field">
          <label for="clienteDireccion">Direcci√≥n:</label>
          <input id="clienteDireccion" [(ngModel)]="clienteDireccion" name="clienteDireccion"
            [class.error]="clienteErrors['direccion']" placeholder="Ej: Calle 123 #45-67" />
          @if (clienteErrors['direccion']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['direccion'] }}
            </small>
          }
        </div>

        <!-- Departamento -->
        <div class="form-field">
          <label for="clienteDepartamento">Departamento:</label>
          <select id="clienteDepartamento" [(ngModel)]="clienteIdDepartamento" name="clienteIdDepartamento"
            (change)="onDepartamentoChange()" [class.error]="clienteErrors['departamento']">
            <option value="">Seleccionar departamento</option>
            @for (dep of departamentos(); track dep.codigo) {
              <option [value]="dep.codigo">{{ dep.nombre }}</option>
            }
          </select>
          @if (clienteErrors['departamento']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['departamento'] }}
            </small>
          }
        </div>

        <!-- Ciudad -->
        <div class="form-field">
          <label for="clienteCiudad">Ciudad:</label>
          <select id="clienteCiudad" [(ngModel)]="clienteIdCiudad" name="clienteIdCiudad"
            [class.error]="clienteErrors['ciudad']">
            <option value="">Seleccionar ciudad</option>
            @for (ciudad of ciudades(); track ciudad.codigo) {
              <option [value]="ciudad.codigo">{{ ciudad.nombre }}</option>
            }
          </select>
          @if (clienteErrors['ciudad']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['ciudad'] }}
            </small>
          }
        </div>

        <!-- Celular -->
        <div class="form-field">
          <label for="clienteCelular">Celular:</label>
          <input id="clienteCelular" [(ngModel)]="clienteCelular" name="clienteCelular"
            [class.error]="clienteErrors['celular']" placeholder="Ej: 3001234567" />
          @if (clienteErrors['celular']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['celular'] }}
            </small>
          }
        </div>

        <!-- Tel√©fono -->
        <div class="form-field">
          <label for="clienteTelefono">Tel√©fono:</label>
          <input id="clienteTelefono" [(ngModel)]="clienteTelefono" name="clienteTelefono"
            [class.error]="clienteErrors['telefono']" placeholder="Ej: 6011234567" />
          @if (clienteErrors['telefono']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['telefono'] }}
            </small>
          }
        </div>

        <!-- Correo -->
        <div class="form-field">
          <label for="clienteEmail">Correo:</label>
          <input id="clienteEmail" [(ngModel)]="clienteEmail" name="clienteEmail"
            [class.error]="clienteErrors['email']" placeholder="Ej: correo@ejemplo.com" />
          @if (clienteErrors['email']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['email'] }}
            </small>
          }
        </div>

        <!-- Tipo vinculaci√≥n -->
        <div class="form-field">
          <label for="clienteTipoVinc">Tipo vinculaci√≥n:</label>
          <input id="clienteTipoVinc" [(ngModel)]="clienteTipoVinc" name="clienteTipoVinc"
            [class.error]="clienteErrors['tipoVinc']" placeholder="Ej: Contrato, Convenio" />
          @if (clienteErrors['tipoVinc']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['tipoVinc'] }}
            </small>
          }
        </div>

        <!-- Registro realizado por -->
        <div class="form-field">
          <label for="clienteRegistroPor">Registro realizado por:</label>
          <input id="clienteRegistroPor" [(ngModel)]="clienteRegistroPor" name="clienteRegistroPor"
            [class.error]="clienteErrors['registroPor']" placeholder="Ej: Nombre/Cargo" />
          @if (clienteErrors['registroPor']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ clienteErrors['registroPor'] }}
            </small>
          }
        </div>
        
      </div>
      
      <!-- Observaciones -->
      <div class="form-grid">
        <div class="form-field full">
          <label for="clienteObservaciones">Observaciones:</label>
          <textarea id="clienteObservaciones" [(ngModel)]="clienteObservaciones" name="clienteObservaciones"
            [class.error]="clienteErrors['observaciones']" placeholder="Observaciones adicionales"></textarea>
          @if (clienteErrors['observaciones']) {
            <small class="error-message">‚ö†Ô∏è {{ clienteErrors['observaciones'] }}</small>
          }
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit">Agregar cliente</button>
      </div>
    </form>
  </section>

  <!-- SECCI√ìN: AGREGAR SOLICITUD-->
  <h2>Agregar solicitud</h2>
  <section>
    <form (submit)="createSolicitud($event)">
      <div class="form-grid">

        <!-- Consecutivo -->
        <div class="form-field">
          <label for="solicitudConsecutivo">Consecutivo:</label>
          <input id="solicitudConsecutivo" type="number" [(ngModel)]="solicitudConsecutivo" name="solicitudConsecutivo"
            placeholder="Auto" readonly aria-readonly="true" title="Asignado autom√°ticamente" />
        </div>

        <!-- Cliente -->
        <div class="form-field">
          <label for="solicitudClienteId">Cliente:</label>
          <select id="solicitudClienteId" [(ngModel)]="solicitudClienteId" name="solicitudClienteId" required
            [class.error]="solicitudErrors['clienteId']">
            <option value="">Seleccionar cliente</option>
            @for (u of clientes(); track u.id_cliente) {
              <option [value]="u.id_cliente">
                {{ u.nombre_solicitante }} ({{ u.numero_identificacion }})
              </option>
            }
          </select>
          @if (solicitudErrors['clienteId']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['clienteId'] }}
            </small>
          }
        </div>

        <!-- Tipo de solicitud -->
        <div class="form-field">
          <label for="solicitudTipo">Tipo de solicitud:</label>
          <select id="solicitudTipo" [(ngModel)]="solicitudTipo" name="solicitudTipo"
            [class.error]="solicitudErrors['tipo']" (ngModelChange)="computeNumeroFrontPreview()">
            <option value="">Seleccionar tipo de solicitud</option>
            @for (tipo of tiposSolicitud; track tipo.value) {
              <option [value]="tipo.value">{{ tipo.label }}</option>
            }
          </select>
          @if (solicitudErrors['tipo']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['tipo'] }}
            </small>
          }
        </div>

        <!-- Nombre de muestra/producto -->
        <div class="form-field">
          <label for="solicitudNombre">Nombre de la muestra:</label>
          <input id="solicitudNombre" [(ngModel)]="solicitudNombre" name="solicitudNombre"
            [class.error]="solicitudErrors['nombre']" placeholder="Ej: Suero l√°cteo" />
          @if (solicitudErrors['nombre']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['nombre'] }}
            </small>
          }
        </div>

        <!-- Lote -->
        <div class="form-field">
          <label for="solicitudLote">Lote del producto:</label>
          <input id="solicitudLote" [(ngModel)]="solicitudLote" name="solicitudLote"
            [class.error]="solicitudErrors['lote']" placeholder="Ej: L202501" />
          @if (solicitudErrors['lote']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['lote'] }}
            </small>
          }
        </div>

        <!-- Fecha de solicitud -->
        <div class="form-field">
          <label for="solicitudFechaSolicitud">Fecha de solicitud:</label>
          <input id="solicitudFechaSolicitud" type="date" [(ngModel)]="solicitudFechaSolicitud" name="solicitudFechaSolicitud"
            [class.error]="solicitudErrors['fechaSolicitud']" (ngModelChange)="computeNumeroFrontPreview()" />
          @if (solicitudErrors['fechaSolicitud']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['fechaSolicitud'] }}
            </small>
          }
        </div>

        <!-- Preview c√≥digo -->
        <div class="form-field">
          <label for="solicitudNumeroFrontPreview">C√≥digo (preview):</label>
          <input id="solicitudNumeroFrontPreview" [value]="solicitudNumeroFrontPreview" name="solicitudNumeroFrontPreview" readonly aria-readonly="true" />
        </div>

        <!-- Fecha de vencimiento -->
        <div class="form-field">
          <label for="solicitudFechaVenc">Fecha de vencimiento:</label>
          <input id="solicitudFechaVenc" type="date" [(ngModel)]="solicitudFechaVenc" name="solicitudFechaVenc"
            [class.error]="solicitudErrors['fechaVenc']" />
          @if (solicitudErrors['fechaVenc']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['fechaVenc'] }}
            </small>
          }
        </div>

        <!-- Tipo de muestra -->
        <div class="form-field">
          <label for="solicitudTipoMuestra">Tipo de muestra:</label>
          <input id="solicitudTipoMuestra" [(ngModel)]="solicitudTipoMuestra" name="solicitudTipoMuestra"
            [class.error]="solicitudErrors['tipoMuestra']" placeholder="Ej: Bebida Alcoh√≥lica, jugo de ca√±a" />
          @if (solicitudErrors['tipoMuestra']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['tipoMuestra'] }}
            </small>
          }
        </div>

        <!-- Tipo de empaque -->
        <div class="form-field">
          <label for="solicitudCondEmpaque">Tipo de empaque:</label>
          <select id="solicitudCondEmpaque" [(ngModel)]="solicitudCondEmpaque" name="solicitudCondEmpaque"
            (ngModelChange)="handleTipoEmpaqueChange($event)" [class.error]="solicitudErrors['condEmpaque']">
            <option value="">Seleccionar tipo de empaque</option>
            @for (empaque of tiposEmpaque; track empaque) {
              <option [value]="empaque">{{ empaque }}</option>
            }
            @for (opt of solicitudTipoEmpaqueCustomOptions; track opt) {
              <option [value]="opt">{{ opt }}</option>
            }
          </select>
          @if (solicitudErrors['condEmpaque']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['condEmpaque'] }}
            </small>
          }
        </div>

        @if (showTipoEmpaqueModal) {
          <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.35)">
            <div style="background:#fff;padding:16px;border-radius:6px;min-width:320px;max-width:90%">
              <h3>Especificar tipo de empaque</h3>
              <textarea [(ngModel)]="modalTipoEmpaqueText" name="modalTipoEmpaqueText" rows="4" style="width:100%;box-sizing:border-box"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button type="button" (click)="confirmTipoEmpaqueModal()">Guardar</button>
                <button type="button" (click)="cancelTipoEmpaqueModal()">Cancelar</button>
              </div>
            </div>
          </div>
        }

        <!-- Tipo de an√°lisis -->
        <div class="form-field">
          <label for="solicitudTipoAnalisis">Tipo de an√°lisis requerido:</label>
          <select id="solicitudTipoAnalisis" [(ngModel)]="solicitudTipoAnalisis" name="solicitudTipoAnalisis"
            (ngModelChange)="handleTipoAnalisisChange($event)" [class.error]="solicitudErrors['tipoAnalisis']">
            <option value="">Seleccionar tipo de an√°lisis</option>
            @for (analisis of tiposAnalisis; track analisis) {
              <option [value]="analisis">{{ analisis }}</option>
            }
            @for (opt of solicitudTipoAnalisisCustomOptions; track opt) {
              <option [value]="opt">{{ opt }}</option>
            }
          </select>
          @if (solicitudErrors['tipoAnalisis']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['tipoAnalisis'] }}
            </small>
          }
        </div>

        @if (showTipoAnalisisModal) {
          <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.35)">
            <div style="background:#fff;padding:16px;border-radius:6px;min-width:320px;max-width:90%">
              <h3>Especificar an√°lisis</h3>
              <textarea [(ngModel)]="modalTipoAnalisisText" name="modalTipoAnalisisText" rows="4" style="width:100%;box-sizing:border-box"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button type="button" (click)="confirmTipoAnalisisModal()">Guardar</button>
                <button type="button" (click)="cancelTipoAnalisisModal()">Cancelar</button>
              </div>
            </div>
          </div>
        }

        <!-- Cantidad de muestras -->
        <div class="form-field">
          <label for="solicitudCantidad">Cantidad de muestras:</label>
          <input id="solicitudCantidad" type="number" [(ngModel)]="solicitudCantidad" name="solicitudCantidad" min="1"
            max="1000" [class.error]="solicitudErrors['cantidad']" placeholder="Ej: 3" />
          @if (solicitudErrors['cantidad']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['cantidad'] }}
            </small>
          }
        </div>

        <!-- Fecha estimada de entrega -->
        <div class="form-field">
          <label for="solicitudFechaEstimada">Fecha estimada entrega:</label>
          <input id="solicitudFechaEstimada" type="date" [(ngModel)]="solicitudFechaEstimada"
            name="solicitudFechaEstimada" [class.error]="solicitudErrors['fechaEstimada']" />
          @if (solicitudErrors['fechaEstimada']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ solicitudErrors['fechaEstimada'] }}
            </small>
          }
        </div>

        <!-- Requiere varios an√°lisis -->
        <div class="form-field">
          <label for="solicitudRequiereVarios">¬øRequiere varios an√°lisis?</label>
          <select id="solicitudRequiereVarios" [(ngModel)]="solicitudRequiereVarios" name="solicitudRequiereVarios">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>

        <!-- Solicitud recibida -->
        <div class="form-field">
          <label for="solicitudRecibida">Solicitud recibida por:</label>
          <input id="solicitudRecibida" [(ngModel)]="solicitudRecibida" name="solicitudRecibida" placeholder="Ej: Correo, Ventanilla" />
        </div>

        <!-- Recibe personal -->
        <div class="form-field">
          <label for="solicitudRecibePersonal">Recibe personal:</label>
          <input id="solicitudRecibePersonal" [(ngModel)]="solicitudRecibePersonal" name="solicitudRecibePersonal" placeholder="Nombre de quien recibe" />
        </div>

        <!-- Cargo personal -->
        <div class="form-field">
          <label for="solicitudCargoPersonal">Cargo del personal:</label>
          <input id="solicitudCargoPersonal" [(ngModel)]="solicitudCargoPersonal" name="solicitudCargoPersonal" placeholder="Ej: Auxiliar de laboratorio" />
        </div>

      </div>
      
      <!-- Observaciones -->
      <div class="form-grid">
        <div class="form-field full">
          <label for="solicitudObservaciones">Observaciones:</label>
          <textarea id="solicitudObservaciones" [(ngModel)]="solicitudObservaciones" name="solicitudObservaciones" placeholder="Observaciones de la solicitud"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit">Agregar solicitud</button>
      </div>
    </form>
  </section>

  <!-- SECCI√ìN: AGREGAR OFERTA -->
  <h2>Agregar oferta</h2>
  <section>
    <form (submit)="createOferta($event)">
      <div class="form-grid">

        <!-- Solicitud -->
        <div class="form-field">
          <label for="ofertaSolicitudId">Solicitud:</label>
          <select id="ofertaSolicitudId" [(ngModel)]="ofertaSolicitudId" name="ofertaSolicitudId" required
            [class.error]="ofertaErrors['solicitudId']">
            <option value="">Seleccionar solicitud</option>
            @for (s of solicitudesFiltradas(); track s.solicitud_id) {
              <option [value]="s.solicitud_id">
                {{ s.nombre_solicitante }} - {{ s.numero_solicitud_front || s.solicitud_id }}
              </option>
            }
          </select>
          @if (ofertaErrors['solicitudId']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ ofertaErrors['solicitudId'] }}
            </small>
          }
        </div>

        <!-- Valor -->
        <div class="form-field">
          <label for="ofertaValor">Valor:</label>
          <input id="ofertaValor" type="number" [(ngModel)]="ofertaValor" name="ofertaValor" min="0" step="0.01"
            [class.error]="ofertaErrors['valor']" placeholder="Ej: 150000" />
          @if (ofertaErrors['valor']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ ofertaErrors['valor'] }}
            </small>
          }
        </div>

        <!-- Fecha de env√≠o -->
        <div class="form-field">
          <label for="ofertaFechaEnvio">Fecha de env√≠o de la oferta:</label>
          <input id="ofertaFechaEnvio" type="date" [(ngModel)]="ofertaFechaEnvio" name="ofertaFechaEnvio"
            [class.error]="ofertaErrors['fechaEnvio']" />
          @if (ofertaErrors['fechaEnvio']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ ofertaErrors['fechaEnvio'] }}
            </small>
          }
        </div>

        <!-- ¬øSe gener√≥ cotizaci√≥n? -->
        <div class="form-field">
          <label for="ofertaGeneroCotizacion">¬øSe gener√≥ cotizaci√≥n?</label>
          <select id="ofertaGeneroCotizacion" [(ngModel)]="ofertaGeneroCotizacion" name="ofertaGeneroCotizacion">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>

        <!-- ¬øSe realiz√≥ seguimiento? -->
        <div class="form-field">
          <label for="ofertaRealizoSeguimiento">¬øSe realiz√≥ seguimiento a la oferta?</label>
          <select id="ofertaRealizoSeguimiento" [(ngModel)]="ofertaRealizoSeguimiento" name="ofertaRealizoSeguimiento">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
      </div>
      
      <!-- Observaci√≥n -->
      <div class="form-grid">
        <div class="form-field full">
          <label for="ofertaObservacion">Observaci√≥n:</label>
          <textarea id="ofertaObservacion" [(ngModel)]="ofertaObservacion" name="ofertaObservacion"
            [class.error]="ofertaErrors['observacion']" placeholder="Observaciones sobre la oferta"></textarea>
          @if (ofertaErrors['observacion']) {
            <small class="error-message">‚ö†Ô∏è {{ ofertaErrors['observacion'] }}</small>
          }
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit">Agregar oferta</button>
      </div>
    </form>
  </section>

  <!-- SECCI√ìN: AGREGAR RESULTADOS -->
  <h2>Revisi√≥n de la oferta</h2>
  <section>
    <form (submit)="createResultado($event)">
      <div class="form-grid">

        <!-- Solicitud -->
        <div class="form-field">
          <label for="resultadoSolicitudId">Solicitud:</label>
          <select id="resultadoSolicitudId" [(ngModel)]="resultadoSolicitudId" name="resultadoSolicitudId" required
            [class.error]="resultadoErrors['solicitudId']">
            <option value="">Seleccionar solicitud</option>
            @for (s of solicitudesFiltradas(); track s.solicitud_id) {
              <option [value]="s.solicitud_id">
                {{ s.nombre_solicitante }} - {{ s.numero_solicitud_front || s.solicitud_id }}
              </option>
            }
          </select>
          @if (resultadoErrors['solicitudId']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ resultadoErrors['solicitudId'] }}
            </small>
          }
        </div>

        <!-- Fecha l√≠mite -->
        <div class="form-field">
          <label for="resultadoFechaLimite">Fecha l√≠mite para la entrega:</label>
          <input id="resultadoFechaLimite" type="date" [(ngModel)]="resultadoFechaLimite" name="resultadoFechaLimite"
            [class.error]="resultadoErrors['fechaLimite']" />
          @if (resultadoErrors['fechaLimite']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ resultadoErrors['fechaLimite'] }}
            </small>
          }
        </div>

        <!-- N√∫mero de informe -->
        <div class="form-field">
          <label for="resultadoNumeroInforme">N√∫mero del informe de resultados:</label>
          <input id="resultadoNumeroInforme" [(ngModel)]="resultadoNumeroInforme" name="resultadoNumeroInforme"
            [class.error]="resultadoErrors['numeroInforme']" placeholder="Ej: INF-2025-001" />
          @if (resultadoErrors['numeroInforme']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ resultadoErrors['numeroInforme'] }}
            </small>
          }
        </div>

        <!-- Fecha de env√≠o -->
        <div class="form-field">
          <label for="resultadoFechaEnvio">Fecha de env√≠o de resultados:</label>
          <input id="resultadoFechaEnvio" type="date" [(ngModel)]="resultadoFechaEnvio" name="resultadoFechaEnvio"
            [class.error]="resultadoErrors['fechaEnvio']" />
          @if (resultadoErrors['fechaEnvio']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ resultadoErrors['fechaEnvio'] }}
            </small>
          }
        </div>

        <!-- Viabilidad del servicio -->
        <div class="form-field">
          <label for="resultadoServicioViable">¬øEl servicio es viable?</label>
          <select id="resultadoServicioViable" [(ngModel)]="resultadoServicioViable" name="resultadoServicioViable" required>
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit">Completado</button>
      </div>
    </form>
  </section>

  <!-- SECCI√ìN: AGREGAR ENCUESTA -->
  <h2>Seguimiento Encuesta</h2>
  <section>
    <form (submit)="createEncuesta($event)">
      <div class="form-grid">

        <!-- Solicitud -->
        <div class="form-field">
          <label for="encuestaSolicitudId">Solicitud:</label>
          <select id="encuestaSolicitudId" [(ngModel)]="encuestaSolicitudId" name="encuestaSolicitudId" required
            [class.error]="encuestaErrors['solicitudId']">
            <option value="">Seleccionar solicitud</option>
            @for (s of solicitudesFiltradas(); track s.solicitud_id) {
              <option [value]="s.solicitud_id">
                {{ s.nombre_solicitante }} - {{ s.numero_solicitud_front || s.solicitud_id }}
              </option>
            }
          </select>
          @if (encuestaErrors['solicitudId']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ encuestaErrors['solicitudId'] }}
            </small>
          }
        </div>

        <!-- Fecha de encuesta -->
        <div class="form-field">
          <label for="encuestaFecha">Fecha de envio de la encuesta:</label>
          <input id="encuestaFecha" type="date" [(ngModel)]="encuestaFecha" name="encuestaFecha"
            [class.error]="encuestaErrors['fecha']" />
          @if (encuestaErrors['fecha']) {
            <small class="error-message">
              ‚ö†Ô∏è {{ encuestaErrors['fecha'] }}
            </small>
          }
        </div>

        <!-- ¬øRecomendar√≠a el servicio? -->
        <div class="form-field">
          <label for="encuestaRecomendaria">Recomendar√≠a el servicio</label>
          <select id="encuestaRecomendaria" [(ngModel)]="encuestaRecomendaria" name="encuestaRecomendaria">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>

        <!-- ¬øEl cliente respondi√≥? -->
        <div class="form-field">
          <label for="encuestaClienteRespondio">El cliente respondi√≥ la encuesta</label>
          <select id="encuestaClienteRespondio" [(ngModel)]="encuestaClienteRespondio" name="encuestaClienteRespondio">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>

        <!-- ¬øSe solicit√≥ nueva encuesta? -->
        <div class="form-field">
          <label for="encuestaSolicitoNueva">Se solicit√≥ nueva encuesta</label>
          <select id="encuestaSolicitoNueva" [(ngModel)]="encuestaSolicitoNueva" name="encuestaSolicitoNueva">
            <option value="">Seleccionar opci√≥n</option>
            <option [ngValue]="true">S√≠</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
      </div>

      <!-- Comentarios -->
      <div class="form-grid">
        <div class="form-field full">
          <label for="encuestaComentarios">Comentarios:</label>
          <textarea id="encuestaComentarios" [(ngModel)]="encuestaComentarios" name="encuestaComentarios"
            [class.error]="encuestaErrors['comentarios']" placeholder="Comentarios del cliente"></textarea>
          @if (encuestaErrors['comentarios']) {
            <small class="error-message">‚ö†Ô∏è {{ encuestaErrors['comentarios'] }}</small>
          }
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit">Agregar encuesta</button>
      </div>
    </form>
  </section>

  <!-- SECCI√ìN: Lista r√°pida de solicitudes -->
  <h2>Catalogo de Solicitudes</h2>
  <section>
    <div class="search-container">
      <label for="solicitudesQ">
        Buscar solicitud (ID, c√≥digo, nombre, tipo, muestra, an√°lisis o cliente):
      </label>
      <input id="solicitudesQ" [(ngModel)]="solicitudesQ" (input)="filtrarSolicitudes()"
        placeholder="Escribe para buscar..." />

      <!-- Mostrar contador de resultados -->
      @if (solicitudesFiltradas().length > 0 || solicitudesQ.trim()) {
        <small class="result-counter">
          Mostrando {{ solicitudesFiltradas().length }} de {{ solicitudes().length }} solicitudes
        </small>
      }

      <!-- Mensaje cuando no hay resultados -->
      @if (solicitudesQ.trim() && solicitudesFiltradas().length === 0) {
        <small class="no-results">
          ‚ö†Ô∏è No se encontraron solicitudes con el t√©rmino "{{ solicitudesQ }}"
        </small>
      }
    </div>

    <div class="equipos-grid">
      @for (s of solicitudesFiltradas(); track s.solicitud_id) {
        <article class="equipo-card" 
                 (click)="toggleExpandSolicitud(s)" 
                 [attr.aria-expanded]="isSolicitudExpanded(s)" 
                 tabindex="0">
          <div class="card-top">
            <div class="tags">
              <span class="tag"><strong>C√≥digo:</strong> {{ s.numero_solicitud_front || '‚Äî' }}</span>
              <span class="tag"><strong>ID:</strong> {{ s.solicitud_id }}</span>
              <span class="tag"><strong>Cliente:</strong> {{ s.nombre_solicitante || '‚Äî' }}</span>
              <span class="tag"><strong>Tipo:</strong> {{ s.tipo_solicitud || '‚Äî' }}</span>
              <span class="tag"><strong>Muestra:</strong> {{ s.nombre_muestra || '‚Äî' }}</span>
            </div>
            <div class="pdf-actions">
              @if (canDelete()) {
                <button type="button" class="pdf-btn delete" 
                        title="Eliminar solicitud" 
                        aria-label="Eliminar solicitud" 
                        (click)="deleteSolicitud(s.solicitud_id); $event.stopPropagation()">
                  <i class="fas fa-trash" aria-hidden="true"></i>
                </button>
              }
            </div>
          </div>
          <div class="card-name">
            <div class="name-line">{{ s.numero_solicitud_front || '' }} ¬∑ {{ s.nombre_muestra || s.tipo_solicitud || ('#' + s.solicitud_id) }}</div>
            <div class="meta-line">
              <span class="chip">Cliente: {{ s.nombre_solicitante || '‚Äî' }}</span>
              <span class="chip">Tipo: {{ s.tipo_solicitud || '‚Äî' }}</span>
            </div>
            <span class="toggle-icon" [class.open]="isSolicitudExpanded(s)" aria-hidden="true">‚ñæ</span>
          </div>
          
          @if (isSolicitudExpanded(s)) {
            <div class="equipo-detalles" (click)="$event.stopPropagation()">
              <div class="equipo-tabs-menu">
                @for (tab of solicitudTabs; track tab.key) {
                  <button type="button" 
                          class="tab-btn" 
                          [class.active]="activeSolicitudTab[s.solicitud_id] === tab.key" 
                          (click)="selectSolicitudTab(s.solicitud_id, tab.key); $event.stopPropagation()">
                    {{ tab.label }}
                  </button>
                }
              </div>
              
              <div class="detalle-grid-compacto">
                @switch (activeSolicitudTab[s.solicitud_id]) {
                  @case ('detalle') {
                    <div class="detalle-item-full">
                      <div class="seccion-titulo">Muestra y an√°lisis</div>
                      <div class="detalle-grid-compacto">
                        <div class="detalle-item">
                          <div class="detalle-label">Tipo muestra</div>
                          <span>{{ s.tipo_muestra || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">An√°lisis requerido</div>
                          <span>{{ s.analisis_requerido || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Tipo empaque</div>
                          <span>{{ s.tipo_empaque || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Lote producto</div>
                          <span>{{ s.lote_producto || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Cant. muestras</div>
                          <span>{{ s.cant_muestras || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Requiere an√°lisis</div>
                          <span>{{ s.req_analisis ? 'S√≠' : 'No' }}</span>
                        </div>
                        <div class="detalle-item detalle-item-full">
                          <div class="detalle-label">Observaciones</div>
                          <span>{{ s.observaciones || '‚Äî' }}</span>
                        </div>
                        
                        <div class="detalle-item-full seccion-titulo">Fechas</div>
                        <div class="detalle-item">
                          <div class="detalle-label">Solicitud</div>
                          <span>{{ formatValue(s.fecha_solicitud) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Vencimiento</div>
                          <span>{{ formatValue(s.fecha_vencimiento_muestra) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Entrega estimada</div>
                          <span>{{ formatValue(s.fecha_entrega_muestra) }}</span>
                        </div>
                      </div>
                    </div>
                  }
                  
                  @case ('oferta') {
                    <div class="detalle-item-full">
                      <div class="seccion-titulo">Oferta</div>
                      <div class="detalle-grid-compacto">
                        <div class="detalle-item">
                          <div class="detalle-label">¬øGener√≥ cotizaci√≥n?</div>
                          <span>{{ s.genero_cotizacion === null || s.genero_cotizacion === undefined ? '‚Äî' : (s.genero_cotizacion ? 'S√≠' : 'No') }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Valor cotizaci√≥n</div>
                          <span>{{ formatValue(s.valor_cotizacion) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Fecha env√≠o oferta</div>
                          <span>{{ formatValue(s.fecha_envio_oferta) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Seguimiento oferta</div>
                          <span>{{ s.realizo_seguimiento_oferta === null || s.realizo_seguimiento_oferta === undefined ? '‚Äî' : (s.realizo_seguimiento_oferta ? 'S√≠' : 'No') }}</span>
                        </div>
                        <div class="detalle-item detalle-item-full">
                          <div class="detalle-label">Observaci√≥n</div>
                          <span>{{ s.observacion_oferta || '‚Äî' }}</span>
                        </div>
                      </div>
                    </div>
                  }
                  
                  @case ('revision') {
                    <div class="detalle-item-full">
                      <div class="seccion-titulo">Revisi√≥n</div>
                      <div class="detalle-grid-compacto">
                        <div class="detalle-item">
                          <div class="detalle-label">Fecha l√≠mite entrega</div>
                          <span>{{ formatValue(s.fecha_limite_entrega) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">C√≥digo informe resultados</div>
                          <span>{{ s.Codigo_informe_resultados || '‚Äî' }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Fecha env√≠o resultados</div>
                          <span>{{ formatValue(s.fecha_envio_resultados) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Servicio viable</div>
                          <span>{{ s.servicio_es_viable === null || s.servicio_es_viable === undefined ? '‚Äî' : (s.servicio_es_viable ? 'S√≠' : 'No') }}</span>
                        </div>
                      </div>
                    </div>
                  }
                  
                  @case ('encuesta') {
                    <div class="detalle-item-full">
                      <div class="seccion-titulo">Encuesta</div>
                      <div class="detalle-grid-compacto">
                        <div class="detalle-item">
                          <div class="detalle-label">Fecha encuesta</div>
                          <span>{{ formatValue(s.fecha_encuesta) }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Recomendar√≠a servicio</div>
                          <span>{{ s.recomendaria_servicio === null || s.recomendaria_servicio === undefined ? '‚Äî' : (s.recomendaria_servicio ? 'S√≠' : 'No') }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Cliente respondi√≥</div>
                          <span>{{ s.cliente_respondio === null || s.cliente_respondio === undefined ? '‚Äî' : (s.cliente_respondio ? 'S√≠' : 'No') }}</span>
                        </div>
                        <div class="detalle-item">
                          <div class="detalle-label">Solicit√≥ nueva encuesta</div>
                          <span>{{ s.solicito_nueva_encuesta === null || s.solicito_nueva_encuesta === undefined ? '‚Äî' : (s.solicito_nueva_encuesta ? 'S√≠' : 'No') }}</span>
                        </div>
                        <div class="detalle-item detalle-item-full">
                          <div class="detalle-label">Comentarios</div>
                          <span>{{ s.comentarios || '‚Äî' }}</span>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }
        </article>
      }
      
      @if (solicitudesFiltradas().length === 0) {
        <p class="sin-equipos">No hay solicitudes para mostrar</p>
      }
    </div>
  </section>

  <!-- SECCI√ìN: Lista de clientes -->
  <h2>Catalogo de Clientes</h2>
  <section>
    <div class="search-container">
      <label for="clientesQ">
        Buscar cliente (nombre, correo, identificaci√≥n, ciudad, departamento, celular):
      </label>
      <input id="clientesQ" [(ngModel)]="clientesQ" (input)="filtrarClientes()" placeholder="Escribe para buscar..." />

      <!-- Mostrar contador de resultados -->
      @if (clientesFiltrados().length > 0 || clientesQ.trim()) {
        <small class="result-counter">
          üë• Mostrando {{ clientesFiltrados().length }} de {{ clientes().length }} clientes
        </small>
      }

      <!-- Mensaje cuando no hay resultados -->
      @if (clientesQ.trim() && clientesFiltrados().length === 0) {
        <small class="no-results">
          ‚ö†Ô∏è No se encontraron clientes con el t√©rmino "{{ clientesQ }}"
        </small>
      }
    </div>

    <div class="equipos-grid">
      @for (u of clientesFiltrados(); track u.id_cliente) {
        <article class="equipo-card" 
                 (click)="toggleClienteDetails(u.id_cliente)" 
                 [attr.aria-expanded]="detallesVisibles[u.id_cliente] ? 'true' : 'false'" 
                 tabindex="0">
          <div class="card-top">
            <div class="tags">
              <span class="tag"><strong>ID:</strong> {{ u.id_cliente }}</span>
              <span class="tag"><strong>Identificaci√≥n:</strong> {{ u.numero_identificacion || '‚Äî' }}</span>
              <span class="tag"><strong>Ciudad:</strong> {{ resolveCiudad(u) }}</span>
              <span class="tag"><strong>Celular:</strong> {{ u.celular || '‚Äî' }}</span>
            </div>
            <div class="pdf-actions">
              @if (canDelete()) {
                <button type="button" class="pdf-btn delete" 
                        title="Eliminar cliente" 
                        aria-label="Eliminar cliente" 
                        (click)="$event.stopPropagation(); deleteCliente(u.id_cliente)">
                  <i class="fas fa-trash" aria-hidden="true"></i>
                </button>
              }
            </div>
          </div>

          <div class="card-name">
            <div class="name-line">{{ u.nombre_solicitante || u.razon_social || ('Cliente ' + u.id_cliente) }}</div>
            <div class="meta-line">
              <span class="chip">Tipo: {{ u.tipo_usuario || '‚Äî' }}</span>
              <span class="chip">Correo: {{ u.correo_electronico || '‚Äî' }}</span>
            </div>
            <span class="toggle-icon" [class.open]="detallesVisibles[u.id_cliente]" aria-hidden="true">‚ñæ</span>
          </div>

          @if (detallesVisibles[u.id_cliente]) {
            <div class="equipo-detalles" (click)="$event.stopPropagation()">
              <div class="detalle-grid-compacto">
                <div class="detalle-item">
                  <div class="detalle-label">Nombre</div>
                  <span>{{ u.nombre_solicitante || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Raz√≥n social</div>
                  <span>{{ u.razon_social || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">NIT</div>
                  <span>{{ u.nit || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Identificaci√≥n</div>
                  <span>{{ u.numero_identificacion || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Departamento</div>
                  <span>{{ resolveDepartamento(u) }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Ciudad</div>
                  <span>{{ resolveCiudad(u) }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Direcci√≥n</div>
                  <span>{{ u.direccion || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Correo</div>
                  <span>{{ u.correo_electronico || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Celular</div>
                  <span>{{ u.celular || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Tel√©fono</div>
                  <span>{{ u.telefono || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Tipo cliente</div>
                  <span>{{ u.tipo_usuario || '‚Äî' }}</span>
                </div>
                <div class="detalle-item">
                  <div class="detalle-label">Fecha vinculaci√≥n</div>
                  <span>{{ u.fecha_vinculacion || '‚Äî' }}</span>
                </div>
                <div class="detalle-item detalle-item-full">
                  <div class="detalle-label">Observaciones</div>
                  <span>{{ u.observaciones || '‚Äî' }}</span>
                </div>
              </div>
            </div>
          }
        </article>
      }

      @empty {
        <p class="sin-equipos">No hay clientes para mostrar</p>
      }
    </div>
  </section>
</div>

<!-- Global toast -->
@if (lastCopiedMessage) {
  <div class="global-toast">{{ lastCopiedMessage }}</div>
}