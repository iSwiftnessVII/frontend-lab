<div class="liba-theme container volumetricos-page">
  <h1>
    <i class="fas fa-flask"></i>
    | Gestión de Material Volumétrico
  </h1>

  <!-- Tarjetas de Dashboard -->
  <div class="dashboard-cards">
    <div class="action-card" (click)="toggleFormulario('material')" [class.active]="formularioActivo === 'material'">
      <i class="fas fa-vial"></i>
      <span>Registrar Material Volumétrico</span>
    </div>

    <div class="action-card" (click)="toggleFormulario('historial')" [class.active]="formularioActivo === 'historial'">
      <i class="fas fa-history"></i>
      <span>Registrar Historial de Material</span>
    </div>

    <div class="action-card" (click)="toggleFormulario('intervalo')" [class.active]="formularioActivo === 'intervalo'">
      <i class="fas fa-calendar-alt"></i>
      <span>Registrar Intervalo de Calibración</span>
    </div>

    @if (!esAuxiliar) {
      <div class="action-card" (click)="toggleFormulario('documentos')" [class.active]="formularioActivo === 'documentos'">
        <i class="fas fa-file-alt"></i>
        <span>Generador por plantilla</span>
      </div>
    }
  </div>

  @if (formularioActivo === 'documentos' && !esAuxiliar) {
    <div class="form-section">
      <h2>Generación de documentos por plantilla (Volumétricos)</h2>
      <section>
        <div class="form-grid">
          <div class="form-field full-row search-section tpl-doc-equipos" style="position: relative; z-index: 1001;">
            <label>Buscar y Seleccionar Material: *</label>

            <div class="search-row">
              <div class="search-control">
                @if (!volDocSeleccionado) {
                  <div class="campo-combinado">
                    <select
                      name="volDocFiltroTipo"
                      [(ngModel)]="volDocFiltroTipo"
                      (change)="filtrarVolumetricosDocumentos()"
                      class="select-filtro"
                    >
                      @for (opcion of opcionesFiltro; track opcion.valor) {
                        <option [value]="opcion.valor">{{ opcion.texto }}</option>
                      }
                    </select>
                    <input
                      type="text"
                      name="volDocBusqueda"
                      [(ngModel)]="volDocBusqueda"
                      (input)="filtrarVolumetricosDocumentos()"
                      class="input-combinado"
                      placeholder="Buscar material..."
                      autocomplete="off"
                    />
                  </div>

                  @if (volDocBusqueda.trim() && volDocResultados.length > 0) {
                    <div class="lista-resultados">
                      @for (m of volDocResultados; track m.codigo_id) {
                        <div class="resultado-item" (click)="seleccionarVolumetricoDocumento(m)">
                          <div class="resultado-header">
                            <span class="codigo">{{ m.codigo_id }}</span>
                            <span class="nombre">{{ m.nombre_material || '—' }}</span>
                          </div>
                          <div class="info-adicional">
                            <span><i class="fas fa-tag"></i> {{ m.marca || '—' }}</span>
                            <span><i class="fas fa-cube"></i> {{ m.modelo || '—' }}</span>
                          </div>
                        </div>
                      }
                    </div>
                  }

                  @if (volDocBusqueda.trim() && volDocResultados.length === 0) {
                    <div class="lista-resultados">
                      <div class="sin-resultados">
                        <i class="fas fa-search"></i>
                        <span>No se encontraron resultados</span>
                      </div>
                    </div>
                  }
                } @else {
                  <div class="reactivo-seleccionado">
                    <div class="seleccionado-info">
                      <div class="seleccionado-content">
                        <div class="seleccionado-header">
                          <i class="fas fa-check-circle"></i>
                          <strong>Material Seleccionado</strong>
                        </div>
                        <span class="codigo-nombre">
                          {{ volDocSeleccionado.codigo_id }} — {{ volDocSeleccionado.nombre_material || '—' }}
                        </span>
                        <div class="detalles-seleccionado">
                          <span><i class="fas fa-tag"></i> {{ volDocSeleccionado.marca || '—' }}</span>
                          <span><i class="fas fa-cube"></i> {{ volDocSeleccionado.modelo || '—' }}</span>
                        </div>
                      </div>
                      <button type="button" class="btn-limpiar" (click)="limpiarSeleccionVolumetricoDocumento()" title="Cambiar material">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
              <button
                class="btn-compact"
                type="button"
                (click)="generarDocumentoVolumetricoDesdePlantilla()"
                [disabled]="volDocLoading || !volDocSeleccionado || !volDocPlantillaId"
              >
                {{ volDocLoading ? 'Generando…' : 'Generar y descargar' }}
              </button>
            </div>
          </div>

          <div class="form-field full-row">
            <label>Plantilla guardada: *</label>
            <div class="field-with-actions">
              <select name="volDocPlantillaId" [(ngModel)]="volDocPlantillaId" class="select-plantilla" [disabled]="volDocListLoading()">
                <option [ngValue]="null" disabled>
                  {{
                    volDocListLoading()
                      ? 'Cargando plantillas…'
                      : (volDocPlantillas().length ? 'Seleccione una plantilla' : 'No hay plantillas')
                  }}
                </option>
                @for (t of volDocPlantillas(); track t.id) {
                  <option [ngValue]="t.id">
                    {{ t.nombre || t.nombre_archivo || ('Plantilla #' + t.id) }}
                  </option>
                }
              </select>
              <div class="field-actions">
                <button
                  type="button"
                  class="btn-compact"
                  (click)="eliminarPlantillaDocumentoVolumetrico()"
                  [disabled]="volDocListLoading() || !volDocPlantillaId || volDocDeleteLoading.has(volDocPlantillaId!)"
                >
                  Eliminar
                </button>
              </div>
            </div>
          </div>

          <div class="form-field">
            <label for="volDocNombre">Nombre de plantilla</label>
            <input id="volDocNombre" name="volDocNombre" [(ngModel)]="volDocNombrePlantilla" placeholder="Ej: Hoja de vida" />
          </div>

          <div class="form-field">
            <label for="volDocTemplate">Subir plantilla (.xlsx o .docx)</label>
            <div class="field-with-actions">
              <input
                #volDocTemplateInput
                id="volDocTemplate"
                type="file"
                accept=".xlsx,.docx"
                class="file-input"
                (change)="onVolDocTemplateSelected($event)"
              />
              <button class="btn-compact" type="button" (click)="subirPlantillaDocumentoVolumetrico()" [disabled]="volDocUploadLoading">
                {{ volDocUploadLoading ? 'Guardando…' : 'Guardar plantilla' }}
              </button>
            </div>
          </div>

          @if (volDocMsg) {
            <small class="error-message">{{ volDocMsg }}</small>
          }
        </div>
      </section>
    </div>
  }

  <!-- Formulario de Material Volumétrico -->
  @if (formularioActivo === 'material' && !esAuxiliar) {
    <div class="form-section">
      <h2>
        <i class="fas fa-vial"></i>
        | Registrar Material Volumétrico
      </h2>
      <section>
        <form class="form-grid" (submit)="crearMaterial($event)">
          <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
            Datos del Material
          </div>
          

          <div>
            <label for="codigo_id">Código ID *</label>
            <input id="codigo_id" name="codigo_id" type="number" [value]="codigoIdSig()" readonly required placeholder="Ej: 1001" />
          </div>
          <div>
            <label for="nombre_material">Nombre del Material *</label>
            <input id="nombre_material" name="nombre_material" [(ngModel)]="nombre_material" required placeholder="Ej: Pipeta volumétrica 10 mL" />
          </div>
          <div>
            <label for="volumen_nominal">Volumen Nominal (mL) *</label>
            <input id="volumen_nominal" name="volumen_nominal" type="number" step="0.001" [(ngModel)]="volumen_nominal" required placeholder="Ej: 10.000" />
          </div>
          <div>
            <label for="rango_volumen">Rango de Volumen</label>
            <input id="rango_volumen" name="rango_volumen" [(ngModel)]="rango_volumen" placeholder="Ej: 10-100 mL" />
          </div>
          <div>
            <label for="marca">Marca</label>
            <input id="marca" name="marca" [(ngModel)]="marca" placeholder="Ej: Brand" />
          </div>
          <div>
            <label for="resolucion">Resolución</label>
            <input id="resolucion" name="resolucion" type="number" step="0.0001" [(ngModel)]="resolucion" placeholder="Ej: 0.0010" />
          </div>
          <div>
            <label for="error_max_permitido">Error Máximo Permitido</label>
            <input id="error_max_permitido" name="error_max_permitido" type="number" step="0.0001" [(ngModel)]="error_max_permitido" placeholder="Ej: 0.0020" />
          </div>
          <div>
            <label for="modelo">Modelo</label>
            <input id="modelo" name="modelo" [(ngModel)]="modelo" placeholder="Ej: PV-10" />
          </div>
          
          <div class="actions" style="width:100%; display:flex; justify-content:flex-end;">
            <button class="btn-compact" type="submit" style="width:fit-content;">Registrar Material</button>
          </div>
        </form>
      </section>
    </div>
  }

  <!-- Formulario de Historial -->
  @if (formularioActivo === 'historial' && !esAuxiliar) {
    <div class="form-section">
      <h2>Registrar Historial de Material Volumétrico</h2>
      <section>
        <form class="form-grid" (submit)="crearHistorial($event)">
          <div>
            <label for="codigo_material_historial">Material *</label>
            <select id="codigo_material_historial" name="codigo_material_historial" 
                    [(ngModel)]="codigo_material_historial" 
                    (ngModelChange)="onSeleccionMaterialHistorialChange($event)">
              <option [ngValue]="null" disabled>Seleccione un material</option>
              @for (material of materialesRegistrados; track material.codigo_id) {
                <option [ngValue]="material.codigo_id">
                  {{ material.codigo_id }} - {{ material.nombre_material }}
                </option>
              }
            </select>
          </div>
          
          <div>
            <label for="consecutivo_historial">Consecutivo *</label>
            <input id="consecutivo_historial" name="consecutivo_historial" 
                   [value]="consecutivoHistorialSig() ?? ''" readonly placeholder="Auto" />
          </div>
          
          <div>
            <label for="fecha_historial">Fecha</label>
            <input id="fecha_historial" name="fecha_historial" type="date" [(ngModel)]="fecha_historial" />
          </div>
          <div>
            <label for="tipo_historial_instrumento">Tipo de Historial</label>
            <input id="tipo_historial_instrumento" name="tipo_historial_instrumento" 
                   [(ngModel)]="tipo_historial_instrumento" placeholder="Ej: Calibración, Verificación" />
          </div>
          <div>
            <label for="codigo_registro_historial">Código de Registro</label>
               <input id="codigo_registro_historial" name="codigo_registro_historial" 
                 [(ngModel)]="codigo_registro_historial" placeholder="Ej: CAL-2024-001" />
          </div>
          <div>
            <label for="realizo">Realizó</label>
            <input id="realizo" name="realizo" [(ngModel)]="realizo" placeholder="Nombre de quien realizó" />
          </div>
          <div>
            <label for="superviso">Supervisó</label>
            <input id="superviso" name="superviso" [(ngModel)]="superviso" placeholder="Nombre de quien supervisó" />
          </div>
          
          <div class="actions">
            <button class="btn-compact" type="submit">Registrar Historial</button>
          </div>
        </form>
      </section>
    </div>
  }

  <!-- Formulario de Intervalo -->
  @if (formularioActivo === 'intervalo' && !esAuxiliar) {
    <div class="form-section">
      <h2>Registrar Intervalo de Calibración</h2>
      <section>
        <form class="form-grid" (submit)="crearIntervalo($event)">
          <div>
            <label for="codigo_material_intervalo">Material *</label>
            <select id="codigo_material_intervalo" name="codigo_material_intervalo" 
                    [(ngModel)]="codigo_material_intervalo" 
                    (ngModelChange)="onSeleccionMaterialIntervaloChange($event)">
              <option [ngValue]="null" disabled>Seleccione un material</option>
              @for (material of materialesRegistrados; track material.codigo_id) {
                <option [ngValue]="material.codigo_id">
                  {{ material.codigo_id }} - {{ material.nombre_material }}
                </option>
              }
            </select>
          </div>
          
          <div>
            <label for="consecutivo_intervalo">Consecutivo *</label>
            <input id="consecutivo_intervalo" name="consecutivo_intervalo" 
                   [value]="consecutivoIntervaloSig() ?? ''" readonly placeholder="Auto" />
          </div>
          
          <div>
            <label for="valor_nominal">Valor Nominal (mL)</label>
            <input id="valor_nominal" name="valor_nominal" type="number" step="0.001" 
                   [(ngModel)]="valor_nominal" placeholder="Ej: 10.000" />
          </div>
          
          <!-- Calibración 1 -->
          <div class="form-section-title" style="grid-column: 1 / -1;">Calibración 1 (Penúltima)</div>
          <div>
            <label for="fecha_c1">Fecha Cal. 1 *</label>
            <input id="fecha_c1" name="fecha_c1" type="date" [(ngModel)]="fecha_c1" />
          </div>
          <div>
            <label for="error_c1">Error Cal. 1 (mL) *</label>
            <input id="error_c1" name="error_c1" type="number" step="0.0001" 
                   [(ngModel)]="error_c1" placeholder="Ej: 0.0012" />
          </div>
          
          <!-- Calibración 2 -->
          <div class="form-section-title" style="grid-column: 1 / -1;">Calibración 2 (Actual)</div>
          <div>
            <label for="fecha_c2">Fecha Cal. 2 *</label>
            <input id="fecha_c2" name="fecha_c2" type="date" [(ngModel)]="fecha_c2" />
          </div>
          <div>
            <label for="error_c2">Error Cal. 2 (mL) *</label>
            <input id="error_c2" name="error_c2" type="number" step="0.0001" 
                   [(ngModel)]="error_c2" placeholder="Ej: 0.0015" />
          </div>
          
          <!-- Cálculos -->
          <div class="form-section-title" style="grid-column: 1 / -1;">Cálculos</div>
          <div>
            <label for="tolerancia">Tolerancia (mL)</label>
            <input id="tolerancia" name="tolerancia" type="number" step="0.0001" 
                   [(ngModel)]="tolerancia" placeholder="Ej: 0.0020" />
          </div>
          <div>
            <label for="incertidumbre_exp">Incertidumbre Expandida</label>
            <input id="incertidumbre_exp" name="incertidumbre_exp" type="number" step="0.0001" 
                   [(ngModel)]="incertidumbre_exp" placeholder="Ej: 0.0005" />
          </div>
          
          <!-- Resultados (readonly) -->
          <div>
            <label for="diferencia_tiempo_dias">Diferencia Tiempo (días)</label>
            <input id="diferencia_tiempo_dias" name="diferencia_tiempo_dias" 
                   [(ngModel)]="diferencia_tiempo_dias" readonly />
          </div>
          <div>
            <label for="desviacion_abs">Desviación Absoluta</label>
            <input id="desviacion_abs" name="desviacion_abs" [(ngModel)]="desviacion_abs" readonly />
          </div>
          <div>
            <label for="deriva">Deriva (mL/día)</label>
            <input id="deriva" name="deriva" [(ngModel)]="deriva" readonly />
          </div>
          <div>
            <label for="intervalo_calibracion_dias">Intervalo Cal. (días)</label>
            <input id="intervalo_calibracion_dias" name="intervalo_calibracion_dias" 
                   [(ngModel)]="intervalo_calibracion_dias" readonly />
          </div>
          <div>
            <label for="intervalo_calibracion_anos">Intervalo Cal. (años)</label>
            <input id="intervalo_calibracion_anos" name="intervalo_calibracion_anos" 
                   [(ngModel)]="intervalo_calibracion_anos" readonly />
          </div>
          
          <div class="actions">
            <button class="btn-compact" type="submit">Registrar Intervalo</button>
          </div>
        </form>
      </section>
    </div>
  }

  <!-- Lista de Materiales Volumétricos -->
  <div class="form-section">
    <h2>
      <i class="fas fa-list"></i>
      | Lista de Materiales Volumétricos
    </h2>
    
    @if (cargandoMateriales) {
      <div class="sin-volumetricos">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando materiales...</p>
      </div>
    } @else if (!cargandoMateriales && materialesRegistrados.length === 0) {
      <div class="sin-volumetricos">
        <i class="fas fa-inbox"></i>
        <p>No hay materiales volumétricos registrados</p>
        <button class="btn-compact" *ngIf="!esAuxiliar" (click)="toggleFormulario('material'); $event.stopPropagation()">
          <i class="fas fa-plus"></i> Registrar primer material
        </button>
      </div>
    } @else {
      <div class="volumetricos-grid">
        @for (material of materialesRegistrados; track material.codigo_id) {
          <article class="volumetrico-card" 
                   (click)="toggleDetalleMaterial(material.codigo_id.toString())">
            
            <div class="card-top">
              <div class="tags">
                <span class="tag"><strong>Código:</strong> {{ material.codigo_id }}</span>
                <span class="tag"><strong>Marca:</strong> {{ material.marca || '—' }}</span>
                <span class="tag"><strong>Modelo:</strong> {{ material.modelo || '—' }}</span>
                <span class="tag"><strong>Volumen:</strong> {{ material.volumen_nominal || '—' }} mL</span>
                <span class="tag"><strong>Resolución:</strong> {{ material.resolucion || '—' }}</span>
              </div>
              <div class="pdf-actions" (click)="$event.stopPropagation()">
                <button *ngIf="!esAuxiliar" type="button" class="pdf-btn edit" title="Editar material" 
                        (click)="abrirEditarMaterial(material, $event)">
                  <svg viewBox="0 0 24 24" class="icon">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor" />
                    <path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor" />
                  </svg>
                </button>
                <button *ngIf="!esAuxiliar" type="button" class="pdf-btn delete" title="Eliminar material" 
                        (click)="eliminarMaterial(material, $event)">
                  <svg viewBox="0 0 24 24" class="icon">
                    <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="card-header-row">
              <div class="card-name" [title]="material.nombre_material">
                <div class="name-line">{{ material.nombre_material }}</div>
                <div class="meta-line">
                  <span class="chip">Rango: {{ material.rango_volumen || '—' }}</span>
                  <span class="chip">Error máx: {{ material.error_max_permitido || '—' }}</span>
                </div>
                <!-- Controles de PDF (similar a equipos) -->
                <div class="card-right-controls" (click)="$event.stopPropagation()">
                  <div class="card-controls-inner">
                    <div class="pdf-field">
                      <svg class="pdf-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="2" width="18" height="20" rx="5" fill="#fff" stroke="#e5e7eb" stroke-width="1.6" />
                        <rect x="7" y="13.5" width="10" height="6" rx="3" fill="#ff3b30"/>
                        <text x="9" y="17.2" font-size="5.5" fill="#fff" font-weight="600">PDF</text>
                      </svg>

                      <select class="pdf-select" [(ngModel)]="selectedPdfByMaterial[material.codigo_id.toString()]" [class.placeholder]="!selectedPdfByMaterial[material.codigo_id.toString()]">
                        <option [ngValue]="null" disabled>Seleccionar PDF...</option>
                        <option *ngFor="let pdf of (pdfListByMaterial[material.codigo_id.toString()] || [])" [value]="pdf.url" [title]="pdf.name">{{ pdf.displayName || pdf.name }}</option>
                        <option *ngIf="!(pdfListByMaterial[material.codigo_id.toString()] || []).length" [ngValue]="null" disabled>Sin archivos</option>
                      </select>

                      <button class="btn view pdf-action" (click)="openPdf(material.codigo_id.toString(), $event)">Ver</button>
                      <button *ngIf="!esAuxiliar" class="btn delete pdf-action eliminar" (click)="deletePdf(material.codigo_id.toString(), $event)">Eliminar</button>
                      <button *ngIf="!esAuxiliar" class="btn add pdf-action" (click)="mostrarMenuCategoriaPdf(material.codigo_id.toString(), $event)">Añadir</button>
                    </div>

                    <!-- Menú de categorías de PDF -->
                    <ul *ngIf="menuCategoriaPdfVisible[material.codigo_id.toString()] && !esAuxiliar" class="categoria-pdf-menu" (click)="$event.stopPropagation()">
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Manual de usuario', $event)">Manual de usuario</li>
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Certificados de calificación', $event)">Certificados de calificación</li>
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Certificados de verificación', $event)">Certificados de verificación</li>
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Certificados de calibración', $event)">Certificados de calibración</li>
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Certificados de mantenimiento', $event)">Certificados de mantenimiento</li>
                      <li (click)="iniciarUpload(material.codigo_id.toString(), 'Ficha técnica de especificaciones', $event)">Ficha técnica de especificaciones</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Detalles expandidos -->
            @if (materialExpandido === material.codigo_id.toString()) {
              <div class="volumetrico-detalles">
                <!-- Menú de pestañas -->
                <div class="volumetrico-tabs-menu">
                  @for (tab of volumetricoTabs; track tab.key) {
                    <button type="button" class="tab-btn" 
                            [class.active]="activeTab[material.codigo_id.toString()] === tab.key" 
                            (click)="selectTab(material.codigo_id.toString(), tab.key); $event.stopPropagation()">
                      {{ tab.label }}
                      @if (tab.key === 'historial' || tab.key === 'intervalo') {
                        <span class="tab-count" aria-hidden="true">
                          {{ getTabCount(material, tab.key) }}
                        </span>
                      }
                    </button>
                  }
                </div>
                
                <div class="volumetrico-info-card" (click)="$event.stopPropagation()">
                  <div class="volumetrico-info-card-header">
                    <span class="volumetrico-info-card-title">Información del Material Volumétrico</span>
                  </div>
                  <div class="volumetrico-info-card-body">
                    @switch (activeTab[material.codigo_id.toString()]) {
                      
                      <!-- Pestaña General -->
                      @case ('general') {
                        <div>
                          <div class="detalle-grid-compacto">
                            <div class="detalle-item"><span class="detalle-label">Código ID</span><span>{{ material.codigo_id }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Nombre</span><span>{{ material.nombre_material || 'N/A' }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Volumen Nominal</span><span>{{ material.volumen_nominal || 'N/A' }} mL</span></div>
                            <div class="detalle-item"><span class="detalle-label">Rango de Volumen</span><span>{{ material.rango_volumen || 'N/A' }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Marca</span><span>{{ material.marca || 'N/A' }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Modelo</span><span>{{ material.modelo || 'N/A' }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Resolución</span><span>{{ material.resolucion || 'N/A' }}</span></div>
                            <div class="detalle-item"><span class="detalle-label">Error Máx Permitido</span><span>{{ material.error_max_permitido || 'N/A' }}</span></div>
                          </div>
                        </div>
                      }
                      
                      <!-- Pestaña Historial -->
                      @case ('historial') {
                        <div>
                          @if (historialPorMaterial[material.codigo_id] && historialPorMaterial[material.codigo_id].length > 0) {
                            <div class="historial-records-container">
                              @for (registro of historialPorMaterial[material.codigo_id]; track registro.consecutivo) {
                                <div class="historial-record-card">
                                  <div class="historial-header" 
                                       (click)="toggleHistorialRegistro(material.codigo_id.toString(), registro.consecutivo)">
                                    <span class="historial-consecutivo">
                                      <i class="fas" 
                                         [ngClass]="historialExpandido[material.codigo_id.toString() + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                      Registro #{{ registro.consecutivo }}
                                    </span>
                                    <span class="historial-fecha">{{ registro.fecha ? (registro.fecha | date: 'yyyy/MM/dd') : 'N/A' }}</span>
                                  </div>
                                  @if (historialExpandido[material.codigo_id.toString() + '_' + registro.consecutivo]) {
                                    <div class="historial-body">
                                      <div class="historial-grid">
                                        @if (registro.editando && !esAuxiliar) {
                                          <div class="historial-item"><span class="historial-label">Tipo de Historial:</span><input [(ngModel)]="registro.tipo_historial_instrumento" /></div>
                                          <div class="historial-item"><span class="historial-label">Código de Registro:</span><input [(ngModel)]="registro.codigo_registro" /></div>
                                          <div class="historial-item"><span class="historial-label">Realizó:</span><input [(ngModel)]="registro.realizo" /></div>
                                          <div class="historial-item"><span class="historial-label">Supervisó:</span><input [(ngModel)]="registro.superviso" /></div>
                                          <div class="historial-actions">
                                            <button (click)="guardarEdicionHistorial(material.codigo_id, registro)" class="btn-compact">Guardar</button>
                                            <button (click)="cancelarEdicionHistorial(material.codigo_id, registro)" class="btn-compact">Cancelar</button>
                                          </div>
                                        } @else {
                                          <div class="historial-item"><span class="historial-label">Tipo de Historial:</span><span>{{ registro.tipo_historial_instrumento || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Código de Registro:</span><span>{{ registro.codigo_registro || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Realizó:</span><span>{{ registro.realizo || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Supervisó:</span><span>{{ registro.superviso || 'N/A' }}</span></div>
                                          <div class="historial-actions">
                                            @if (!esAuxiliar) {
                                              <button (click)="editarRegistroHistorial(registro)" class="btn-compact">Editar</button>
                                            }
                                          </div>
                                        }
                                      </div>
                                    </div>
                                  }
                                </div>
                              }
                            </div>
                          } @else {
                            <div class="no-historial-message">
                              <i class="fas fa-history"></i>
                              <p>No hay registros de historial para este material</p>
                            </div>
                          }
                        </div>
                      }
                      
                      <!-- Pestaña Intervalo -->
                      @case ('intervalo') {
                        <div>
                          @if (intervaloPorMaterial[material.codigo_id] && intervaloPorMaterial[material.codigo_id].length > 0) {
                            <div class="historial-records-container">
                              @for (registro of intervaloPorMaterial[material.codigo_id]; track registro.consecutivo) {
                                <div class="historial-record-card">
                                  <div class="historial-header" 
                                       (click)="toggleIntervaloRegistro(material.codigo_id.toString(), registro.consecutivo)">
                                    <span class="historial-consecutivo">
                                      <i class="fas" 
                                         [ngClass]="intervaloExpandido[material.codigo_id.toString() + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                      Registro #{{ registro.consecutivo }}
                                    </span>
                                    <span class="historial-fecha">Valor: {{ registro.valor_nominal || 'N/A' }} mL</span>
                                  </div>
                                  @if (intervaloExpandido[material.codigo_id.toString() + '_' + registro.consecutivo]) {
                                    <div class="historial-body">
                                      <div class="historial-grid">
                                        @if (registro.editando && !esAuxiliar) {
                                          <div class="historial-item"><span class="historial-label">Valor Nominal (mL):</span><input type="number" [(ngModel)]="registro.valor_nominal" /></div>
                                          <div class="historial-item"><span class="historial-label">Fecha Cal. 1:</span><input type="date" [(ngModel)]="registro.fecha_c1" /></div>
                                          <div class="historial-item"><span class="historial-label">Error Cal. 1:</span><input type="number" [(ngModel)]="registro.error_c1" /></div>
                                          <div class="historial-item"><span class="historial-label">Fecha Cal. 2:</span><input type="date" [(ngModel)]="registro.fecha_c2" /></div>
                                          <div class="historial-item"><span class="historial-label">Error Cal. 2:</span><input type="number" [(ngModel)]="registro.error_c2" /></div>
                                          <div class="historial-item"><span class="historial-label">Diferencia Tiempo (días):</span><input type="number" [(ngModel)]="registro.diferencia_tiempo_dias" /></div>
                                          <div class="historial-item"><span class="historial-label">Desviación Absoluta:</span><input type="number" [(ngModel)]="registro.desviacion_abs" /></div>
                                          <div class="historial-item"><span class="historial-label">Deriva (mL/día):</span><input type="number" [(ngModel)]="registro.deriva" /></div>
                                          <div class="historial-item"><span class="historial-label">Tolerancia:</span><input type="number" [(ngModel)]="registro.tolerancia" /></div>
                                          <div class="historial-item"><span class="historial-label">Intervalo Cal. (días):</span><input type="number" [(ngModel)]="registro.intervalo_calibracion_dias" /></div>
                                          <div class="historial-item"><span class="historial-label">Intervalo Cal. (años):</span><input type="number" [(ngModel)]="registro.intervalo_calibracion_anos" /></div>
                                          <div class="historial-item"><span class="historial-label">Incertidumbre Expandida:</span><input type="number" [(ngModel)]="registro.incertidumbre_exp" /></div>
                                          <div class="historial-actions">
                                            <button (click)="guardarEdicionIntervalo(material.codigo_id, registro)" class="btn-compact">Guardar</button>
                                            <button (click)="cancelarEdicionIntervalo(material.codigo_id, registro)" class="btn-compact">Cancelar</button>
                                          </div>
                                        } @else {
                                          <div class="historial-item"><span class="historial-label">Valor Nominal (mL):</span><span>{{ registro.valor_nominal || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Fecha Cal. 1:</span><span>{{ registro.fecha_c1 ? (registro.fecha_c1 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Error Cal. 1:</span><span>{{ registro.error_c1 || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Fecha Cal. 2:</span><span>{{ registro.fecha_c2 ? (registro.fecha_c2 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Error Cal. 2:</span><span>{{ registro.error_c2 || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Diferencia Tiempo (días):</span><span>{{ registro.diferencia_tiempo_dias || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Desviación Absoluta:</span><span>{{ registro.desviacion_abs || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Deriva (mL/día):</span><span>{{ registro.deriva || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Tolerancia:</span><span>{{ registro.tolerancia || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Intervalo Cal. (días):</span><span>{{ registro.intervalo_calibracion_dias || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Intervalo Cal. (años):</span><span>{{ registro.intervalo_calibracion_anos || 'N/A' }}</span></div>
                                          <div class="historial-item"><span class="historial-label">Incertidumbre Expandida:</span><span>{{ registro.incertidumbre_exp || 'N/A' }}</span></div>
                                          <div class="historial-actions">
                                            @if (!esAuxiliar) {
                                              <button (click)="editarRegistroIntervalo(registro)" class="btn-compact">Editar</button>
                                            }
                                          </div>
                                        }
                                      </div>
                                    </div>
                                  }
                                </div>
                              }
                            </div>
                          } @else {
                            <div class="no-historial-message">
                              <i class="fas fa-calendar-alt"></i>
                              <p>No hay registros de intervalo para este material</p>
                            </div>
                          }
                        </div>
                      }
                      
                      @default {
                        <div>
                          <div class="detalle-grid-compacto"><span>Seleccione una pestaña</span></div>
                        </div>
                      }
                    }
                  </div>
                </div>
              </div>
            }
          </article>
        }
      </div>
    }
  </div>

  <!-- Modal de edición (similar a equipos) -->
  @if ((editModalVisible || editModalClosing) && !esAuxiliar) {
    <div class="modal-overlay" 
         [class.closing]="editModalClosing" (click)="closeEditMaterialModal()">
      <div class="edit-modal" [class.closing]="editModalClosing" (click)="$event.stopPropagation()">
        <h3>Editar Material Volumétrico</h3>
        
        <div class="volumetrico-tabs-menu">
          <button type="button" class="tab-btn" [class.active]="editModalActiveTab === 'general'" 
                  (click)="editModalActiveTab = 'general'">General</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button type="button" class="tab-btn" (click)="saveAllEditMaterial()">Guardar</button>
            <button type="button" class="tab-btn" (click)="closeEditMaterialModal()">Cancelar</button>
          </div>
        </div>
        
        <div style="margin-top:12px" class="edit-modal-body">
          @if (editModalActiveTab === 'general') {
            <form class="form-grid" (submit)="$event.preventDefault()">
              <div>
                <label for="edit_codigo_id">Código ID</label>
                <input id="edit_codigo_id" name="edit_codigo_id" type="number" [value]="codigoIdSig()" readonly />
              </div>
              <div>
                <label for="edit_nombre_material">Nombre del Material</label>
                <input id="edit_nombre_material" name="edit_nombre_material" [(ngModel)]="nombre_material" placeholder="Ej: Pipeta volumétrica 10 mL" />
              </div>
              <div>
                <label for="edit_volumen_nominal">Volumen Nominal (mL)</label>
                <input id="edit_volumen_nominal" name="edit_volumen_nominal" type="number" step="0.001" [(ngModel)]="volumen_nominal" placeholder="Ej: 10.000" />
              </div>
              <div>
                <label for="edit_rango_volumen">Rango de Volumen</label>
                <input id="edit_rango_volumen" name="edit_rango_volumen" [(ngModel)]="rango_volumen" placeholder="Ej: 10-100 mL" />
              </div>
              <div>
                <label for="edit_marca">Marca</label>
                <input id="edit_marca" name="edit_marca" [(ngModel)]="marca" placeholder="Ej: Brand" />
              </div>
              <div>
                <label for="edit_resolucion">Resolución</label>
                <input id="edit_resolucion" name="edit_resolucion" type="number" step="0.0001" [(ngModel)]="resolucion" placeholder="Ej: 0.0010" />
              </div>
              <div>
                <label for="edit_error_max_permitido">Error Máximo Permitido</label>
                <input id="edit_error_max_permitido" name="edit_error_max_permitido" type="number" step="0.0001" [(ngModel)]="error_max_permitido" placeholder="Ej: 0.0020" />
              </div>
              <div>
                <label for="edit_modelo">Modelo</label>
                <input id="edit_modelo" name="edit_modelo" [(ngModel)]="modelo" placeholder="Ej: PV-10" />
              </div>
            </form>
          }
        </div>
      </div>
    </div>
  }
</div>
