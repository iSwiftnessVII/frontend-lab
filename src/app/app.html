<!-- ====== HEADER GLOBAL LIBA ====== -->
@if (user()) {
<header id="app-header" class="header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">LIBA</div>
      <div>
        <div class="header-title">
          Laboratorio Integrado de Biociencias Aplicadas
        </div>
        <div class="header-subtitle">
          LIBA Software{{ appVersion ? ' ' + appVersion : '' }}
        </div>
      </div>
    </div>

    <div class="user-menu">
      <div class="header-notifs" aria-label="Alertas de reactivos">
        <button type="button" class="notif-pill vencidos" title="Reactivos vencidos" (click)="toggleNotifVencidos($event)">
          <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
          <span>Vencidos</span>
          <span class="notif-count">
            @if (reactivosAlertLoading()) {
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            } @else {
              {{ reactivosVencidosCount() }}
            }
          </span>
        </button>
        @if (notifVencidosOpen()) {
          <div class="notif-panel vencidos" role="dialog" aria-label="Reactivos vencidos">
            @if (reactivosAlertLoading()) {
              <div class="notif-loading"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>
            } @else if (!reactivosVencidosList().length) {
              <div class="notif-empty">Sin reactivos vencidos.</div>
            } @else {
              <div class="notif-list">
                @for (r of reactivosVencidosList(); track $index) {
                  <div class="notif-row">
                    <div class="notif-main">
                      <span class="notif-name" [title]="r.nombre || 'Sin nombre'">{{ r.nombre || 'Sin nombre' }}</span>
                      <span class="notif-code" [title]="r.codigo || '—'">{{ r.codigo || '—' }}</span>
                      <span class="notif-lote" [title]="r.lote || '—'">{{ r.lote || '—' }}</span>
                    </div>
                    <div class="notif-date">Vencido: {{ r.fecha_vencimiento | date:'dd/MM/yyyy' }}</div>
                  </div>
                }
              </div>
            }
          </div>
        }

        <button type="button" class="notif-pill por-vencer" title="Reactivos por vencer" (click)="toggleNotifPorVencer($event)">
          <i class="fas fa-clock" aria-hidden="true"></i>
          <span>Por vencer</span>
          <span class="notif-count">
            @if (reactivosAlertLoading()) {
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            } @else {
              {{ reactivosPorVencerCount() }}
            }
          </span>
        </button>
        @if (notifPorVencerOpen()) {
          <div class="notif-panel por-vencer" role="dialog" aria-label="Reactivos por vencer">
            @if (reactivosAlertLoading()) {
              <div class="notif-loading"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>
            } @else if (!reactivosPorVencerList().length) {
              <div class="notif-empty">Sin reactivos por vencer.</div>
            } @else {
              <div class="notif-list">
                @for (r of reactivosPorVencerList(); track $index) {
                  <div class="notif-row">
                    <div class="notif-main">
                      <span class="notif-name" [title]="r.nombre || 'Sin nombre'">{{ r.nombre || 'Sin nombre' }}</span>
                      <span class="notif-code" [title]="r.codigo || '—'">{{ r.codigo || '—' }}</span>
                      <span class="notif-lote" [title]="r.lote || '—'">{{ r.lote || '—' }}</span>
                    </div>
                    <div class="notif-date">Vence: {{ r.fecha_vencimiento | date:'dd/MM/yyyy' }}</div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
      <!-- User initial circle -->
      <button type="button" class="user-initial" [class.active]="menuOpen()" aria-haspopup="true" [attr.aria-expanded]="menuOpen()" (click)="toggleUserMenu()">
        {{ (user()?.email || '')[0] | uppercase }}
      </button>

      <!-- Dropdown menu -->
      <div class="user-dropdown gh-style" [class.open]="menuOpen()" [attr.aria-hidden]="!menuOpen()" role="menu">
        <!-- Profile header: larger area showing name and email -->
        <div class="profile-header">
          <div class="profile-initial">{{ (user()?.email || '')[0] | uppercase }}</div>
          <div class="profile-meta">
            <div class="profile-name">{{ userShortName() }}</div>
            <div class="profile-email">{{ user()?.email }}</div>
            <div class="profile-role">{{ user()?.rol }}</div>
          </div>
        </div>

        <div class="profile-actions">
          <button type="button" class="user-dropdown-item" role="menuitem" (click)="goToPerfil()">
            <i class="fas fa-user" aria-hidden="true"></i>
            <span>Perfil</span>
          </button>

          <button type="button" class="user-dropdown-item" role="menuitem" (click)="openUpdatesModal()">
            <i class="fas fa-envelope" aria-hidden="true"></i>
            <span>Notificaciones</span>
            @if (hasUpdateNotes()) {
              <span class="dropdown-flag" aria-hidden="true">
                <i class="fas fa-exclamation-circle"></i>
              </span>
            }
          </button>

          <button
            type="button"
            class="user-dropdown-item theme-toggle"
            role="menuitemcheckbox"
            [attr.aria-checked]="isDarkMode()"
            (click)="toggleTheme($event)"
          >
            <i class="fas" [class.fa-moon]="!isDarkMode()" [class.fa-sun]="isDarkMode()" aria-hidden="true"></i>
            <span>Modo oscuro</span>
            <span class="theme-switch" [class.on]="isDarkMode()" aria-hidden="true"></span>
          </button>
        </div>
        <hr class="dropdown-divider"/>
        <button type="button" class="user-dropdown-item logout" (click)="onLogout()" [disabled]="isLoggingOut()" role="menuitem">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
          <span>{{ isLoggingOut() ? 'Cerrando sesión…' : 'Salir' }}</span>
        </button>
      </div>
    </div>
  </div>
</header>
}

<!-- ====== NAVIGATION MENU ====== -->
@if (user()) {
<nav class="nav-menu">
  <div class="nav-content">
    <a
      routerLink="/dashboard"
      routerLinkActive="active"
      [routerLinkActiveOptions]="{ exact: true }"
      class="nav-item"
    >
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>

    @if (user()?.rol === 'Administrador' || user()?.rol === 'Superadmin') {
      <a 
        routerLink="/solicitudes" 
        routerLinkActive="active" 
        class="nav-item"
      >
        <i class="fas fa-clipboard-list"></i> Solicitudes
      </a>
    }
        
        @if (user()?.rol === 'Administrador' || user()?.rol === 'Superadmin' || user()?.rol === 'Auxiliar') {
          <a routerLink="/plantillas" routerLinkActive="active" class="nav-item">
            <i class="fas fa-layer-group"></i> Plantillas
          </a>
        }

    <!-- Inventario dropdown - CON ESTADO ACTIVO -->
    <div 
      class="nav-item dropdown full-width-dropdown" 
      [class.is-open]="inventoryMenuOpen()" 
      [class.active]="selectedInventory()"
      (click)="toggleInventoryMenu()"
    >
      <button
        type="button"
        class="dropdown-toggle"
        [class.has-selection]="selectedInventory()"
        aria-haspopup="true"
        [attr.aria-expanded]="inventoryMenuOpen()"
      >
        @if (selectedInventory()) {
          <!-- Estado activo: muestra el apartado seleccionado -->
          <i class="fas" [class]="getInventoryIcon(selectedInventory()!)"></i>
          <span>{{ getInventoryName(selectedInventory()!) }}</span>
        } @else {
          <!-- Estado por defecto: muestra Inventario -->
          <i class="fas fa-warehouse" aria-hidden="true"></i>
          <span>Inventario</span>
        }
        <i class="fas fa-chevron-down caret" aria-hidden="true"></i>
      </button>

      <div class="dropdown-menu inventory-menu full-width-menu" role="menu" [class.open]="inventoryMenuOpen()">
        <div class="inventory-container">
          <div class="inventory-grid">
            <!-- Apartados originales -->
            <a 
              routerLink="/reactivos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('reactivos'); $event.stopPropagation()"
            >
              <div class="inventory-icon reactivos">
                <i class="fas fa-flask" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Reactivos</div>
                <div class="inventory-subtitle">Químicos y sustancias</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/insumos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('insumos'); $event.stopPropagation()"
            >
              <div class="inventory-icon insumos">
                <i class="fas fa-boxes" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Insumos</div>
                <div class="inventory-subtitle">Materiales generales</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/papeleria" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('papeleria'); $event.stopPropagation()"
            >
              <div class="inventory-icon papeleria">
                <i class="fas fa-paperclip" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Papelería</div>
                <div class="inventory-subtitle">Oficina y suministros</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <!-- NUEVOS APARTADOS -->
            <a 
              routerLink="/equipos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('equipos'); $event.stopPropagation()"
            >
              <div class="inventory-icon equipos">
                <i class="fas fa-microscope" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Equipos</div>
                <div class="inventory-subtitle">Instrumentación científica</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/materiales-volumetricos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('volumetricos'); $event.stopPropagation()"
            >
              <div class="inventory-icon volumetricos">
                <i class="fas fa-vial" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Materiales Volumétricos</div>
                <div class="inventory-subtitle">Medición de precisión</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/materiales-referencia" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('referencia'); $event.stopPropagation()"
            >
              <div class="inventory-icon referencia">
                <i class="fas fa-vial" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Materiales de Referencia</div>
                <div class="inventory-subtitle">Material de referencia</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

@if (user()?.rol === 'Superadmin') {
  <a 
    routerLink="/auditoria" 
    routerLinkActive="active" 
    class="nav-item"
  >
    <i class="fas fa-clipboard-check"></i> Auditoría
  </a>
}

    @if (user()?.rol === 'Superadmin') {
      <a 
        routerLink="/usuarios" 
        routerLinkActive="active" 
        class="nav-item"
      >
        <i class="fas fa-users"></i> Usuarios
      </a>
    }
  </div>
</nav>
}

<!-- ====== CONTENIDO PRINCIPAL ====== -->
<main class="main-content liba-theme" [class.route-navigating]="isNavigating()">
  <router-outlet></router-outlet>
</main>

@if (updatesModalOpen()) {
  <div class="updates-modal-backdrop" (click)="closeUpdatesModal()"></div>
  <div class="updates-modal" role="dialog" aria-modal="true" aria-label="Notificaciones de actualizaciones" (click)="$event.stopPropagation()">
    <div class="updates-modal-header">
      <div>
        <h3>Notificaciones</h3>
        <p>Actualizaciones recientes del sistema</p>
      </div>
      <button type="button" class="close-btn" (click)="closeUpdatesModal()" aria-label="Cerrar">×</button>
    </div>

    <div class="updates-list">
      @if (!updatesNotes().length) {
        <div class="updates-empty">No hay actualizaciones recientes.</div>
      } @else {
        @for (note of updatesNotes(); track note.id) {
          <button type="button" class="update-card" (click)="openUpdateDetail(note)">
            <div class="update-date">{{ note.date | date:'dd/MM/yyyy' }}</div>
            <div class="update-title">{{ note.title }}</div>
            <div class="update-summary">{{ note.summary }}</div>
            @if (note.hasNotes) {
              <div class="update-flag" aria-hidden="true">
                <i class="fas fa-exclamation-circle"></i>
                <span>Notas</span>
              </div>
            }
          </button>
        }
      }
    </div>
  </div>
}

@if (updatesDetailOpen() && selectedUpdate()) {
  <div class="updates-detail-backdrop" (click)="closeUpdateDetail()"></div>
  <div class="updates-detail-modal" role="dialog" aria-modal="true" aria-label="Detalle de actualizacion" (click)="$event.stopPropagation()">
    <div class="updates-modal-header">
      <div>
        <h3>{{ selectedUpdate()?.title }}</h3>
        <p>{{ selectedUpdate()?.date | date:'dd/MM/yyyy' }}</p>
      </div>
      <button type="button" class="close-btn" (click)="closeUpdateDetail()" aria-label="Cerrar">×</button>
    </div>

    <div class="updates-detail-body">
      <p class="updates-detail-summary">{{ selectedUpdate()?.summary }}</p>
      <pre class="updates-detail-text">{{ selectedUpdate()?.detail }}</pre>
    </div>
  </div>
}

@if (confirm.state().open) {
  <div class="confirm-backdrop" (click)="confirm.resolve(false)"></div>
  <div class="confirm-modal" role="dialog" aria-modal="true" aria-label="Confirmacion" (click)="$event.stopPropagation()">
    <div class="confirm-header">
      <h3>{{ confirm.state().title }}</h3>
    </div>
    <div class="confirm-body">
      <p class="confirm-message">{{ confirm.state().message }}</p>
    </div>
    <div class="confirm-actions">
      <button type="button" class="btn-secondary" (click)="confirm.resolve(false)">{{ confirm.state().cancelText }}</button>
      <button type="button" class="btn-primary" [class.danger]="confirm.state().danger" (click)="confirm.resolve(true)">{{ confirm.state().confirmText }}</button>
    </div>
  </div>
}

<!-- ====== FOOTER GLOBAL LIBA ====== -->
@if (showFooter()) {
<footer class="app-footer">
  <p>
    © {{ currentYear }} LIBA - Laboratorio Integrado de Biociencias Aplicadas.
    Todos los derechos reservados.
  </p>
</footer>
}

<!-- ====== GLOBAL SNACKBAR ====== -->
<div class="snackbar" [class.open]="snack.openSig()" [class.success]="snack.typeSig() === 'success'" [class.error]="snack.typeSig() === 'error'" [class.warn]="snack.typeSig() === 'warn'">
  <div class="snackbar-content">
    <span class="snackbar-icon" aria-hidden="true">
      <i class="fas" [ngClass]="{
        'fa-check-circle': snack.typeSig() === 'success',
        'fa-exclamation-triangle': snack.typeSig() === 'warn',
        'fa-times-circle': snack.typeSig() === 'error',
        'fa-info-circle': snack.typeSig() !== 'success' && snack.typeSig() !== 'warn' && snack.typeSig() !== 'error'
      }"></i>
    </span>
    <span class="snackbar-text">{{ snack.messageSig() }}</span>
  </div>
  <div class="snackbar-timer"></div>
</div>
