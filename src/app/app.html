<!-- ====== HEADER GLOBAL LIBA ====== -->
@if (user()) {
<header id="app-header" class="header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">LIBA</div>
      <div>
        <div class="header-title">
          Laboratorio Integrado de Biociencias Aplicadas
        </div>
        <div class="header-subtitle">
          LIBA Software 1.0
        </div>
      </div>
    </div>

    <div class="user-menu">
      <!-- User initial circle -->
      <button type="button" class="user-initial" [class.active]="menuOpen()" aria-haspopup="true" [attr.aria-expanded]="menuOpen()" (click)="toggleUserMenu()">
        {{ (user()?.email || '')[0] | uppercase }}
      </button>

      <!-- Dropdown menu -->
      <div class="user-dropdown gh-style" [class.open]="menuOpen()" [attr.aria-hidden]="!menuOpen()" role="menu">
        <!-- Profile header: larger area showing name and email -->
        <div class="profile-header">
          <div class="profile-initial">{{ (user()?.email || '')[0] | uppercase }}</div>
          <div class="profile-meta">
            <div class="profile-name">{{ userShortName() }}</div>
            <div class="profile-email">{{ user()?.email }}</div>
            <div class="profile-role">{{ user()?.rol }}</div>
          </div>
        </div>

        <div class="profile-actions">
          <button type="button" class="user-dropdown-item" role="menuitem" (click)="goToPerfil()">
            <i class="fas fa-user" aria-hidden="true"></i>
            <span>Perfil</span>
          </button>

          <button
            type="button"
            class="user-dropdown-item theme-toggle"
            role="menuitemcheckbox"
            [attr.aria-checked]="isDarkMode()"
            (click)="toggleTheme($event)"
          >
            <i class="fas" [class.fa-moon]="!isDarkMode()" [class.fa-sun]="isDarkMode()" aria-hidden="true"></i>
            <span>Modo oscuro</span>
            <span class="theme-switch" [class.on]="isDarkMode()" aria-hidden="true"></span>
          </button>
        </div>
        <hr class="dropdown-divider"/>
        <button type="button" class="user-dropdown-item logout" (click)="onLogout()" [disabled]="isLoggingOut()" role="menuitem">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
          <span>{{ isLoggingOut() ? 'Cerrando sesión…' : 'Salir' }}</span>
        </button>
      </div>
    </div>
  </div>
</header>
}

<!-- ====== NAVIGATION MENU ====== -->
@if (user()) {
<nav class="nav-menu">
  <div class="nav-content">
    <a
      routerLink="/dashboard"
      routerLinkActive="active"
      [routerLinkActiveOptions]="{ exact: true }"
      class="nav-item"
    >
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>

    @if (user()?.rol === 'Administrador' || user()?.rol === 'Superadmin') {
      <a 
        routerLink="/solicitudes" 
        routerLinkActive="active" 
        class="nav-item"
      >
        <i class="fas fa-clipboard-list"></i> Solicitudes
      </a>
    }
        
        @if (user()?.rol === 'Administrador' || user()?.rol === 'Auxiliar' || user()?.rol === 'Superadmin') {
          <a routerLink="/plantillas" routerLinkActive="active" class="nav-item">
            <i class="fas fa-layer-group"></i> Plantillas
          </a>
        }

    <!-- Inventario dropdown - CON ESTADO ACTIVO -->
    <div 
      class="nav-item dropdown full-width-dropdown" 
      [class.is-open]="inventoryMenuOpen()" 
      [class.active]="selectedInventory()"
      (click)="toggleInventoryMenu()"
    >
      <button
        type="button"
        class="dropdown-toggle"
        [class.has-selection]="selectedInventory()"
        aria-haspopup="true"
        [attr.aria-expanded]="inventoryMenuOpen()"
      >
        @if (selectedInventory()) {
          <!-- Estado activo: muestra el apartado seleccionado -->
          <i class="fas" [class]="getInventoryIcon(selectedInventory()!)"></i>
          <span>{{ getInventoryName(selectedInventory()!) }}</span>
        } @else {
          <!-- Estado por defecto: muestra Inventario -->
          <i class="fas fa-warehouse" aria-hidden="true"></i>
          <span>Inventario</span>
        }
        <i class="fas fa-chevron-down caret" aria-hidden="true"></i>
      </button>

      <div class="dropdown-menu inventory-menu full-width-menu" role="menu" [class.open]="inventoryMenuOpen()">
        <div class="inventory-container">
          <div class="inventory-grid">
            <!-- Apartados originales -->
            <a 
              routerLink="/reactivos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('reactivos'); $event.stopPropagation()"
            >
              <div class="inventory-icon reactivos">
                <i class="fas fa-flask" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Reactivos</div>
                <div class="inventory-subtitle">Químicos y sustancias</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/insumos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('insumos'); $event.stopPropagation()"
            >
              <div class="inventory-icon insumos">
                <i class="fas fa-boxes" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Insumos</div>
                <div class="inventory-subtitle">Materiales generales</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/papeleria" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('papeleria'); $event.stopPropagation()"
            >
              <div class="inventory-icon papeleria">
                <i class="fas fa-paperclip" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Papelería</div>
                <div class="inventory-subtitle">Oficina y suministros</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <!-- NUEVOS APARTADOS -->
            <a 
              routerLink="/equipos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('equipos'); $event.stopPropagation()"
            >
              <div class="inventory-icon equipos">
                <i class="fas fa-microscope" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Equipos</div>
                <div class="inventory-subtitle">Instrumentación científica</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/materiales-volumetricos" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('volumetricos'); $event.stopPropagation()"
            >
              <div class="inventory-icon volumetricos">
                <i class="fas fa-vial" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Materiales Volumétricos</div>
                <div class="inventory-subtitle">Medición de precisión</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>

            <a 
              routerLink="/materiales-referencia" 
              class="inventory-card" 
              role="menuitem"
              (click)="setSelectedInventory('referencia'); $event.stopPropagation()"
            >
              <div class="inventory-icon referencia">
                <i class="fas fa-vial" aria-hidden="true"></i>
              </div>
              <div class="inventory-content">
                <div class="inventory-title">Materiales de Referencia</div>
                <div class="inventory-subtitle">Material de referencia</div>
              </div>
              <i class="fas fa-arrow-right inventory-arrow"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

@if (user()?.rol === 'Superadmin') {
  <a 
    routerLink="/auditoria" 
    routerLinkActive="active" 
    class="nav-item"
  >
    <i class="fas fa-clipboard-check"></i> Auditoría
  </a>
}

    @if (user()?.rol === 'Superadmin') {
      <a 
        routerLink="/usuarios" 
        routerLinkActive="active" 
        class="nav-item"
      >
        <i class="fas fa-users"></i> Usuarios
      </a>
    }
  </div>
</nav>
}

<!-- ====== CONTENIDO PRINCIPAL ====== -->
<main class="main-content liba-theme" [class.route-navigating]="isNavigating()">
  <router-outlet></router-outlet>
</main>

<!-- ====== FOOTER GLOBAL LIBA ====== -->
@if (showFooter()) {
<footer class="app-footer">
  <p>
    © {{ currentYear }} LIBA - Laboratorio Integrado de Biociencias Aplicadas.
    Todos los derechos reservados.
  </p>
</footer>
}

<!-- ====== GLOBAL SNACKBAR ====== -->
<div class="snackbar" [class.open]="snack.openSig()" [class.success]="snack.typeSig() === 'success'" [class.error]="snack.typeSig() === 'error'" [class.warn]="snack.typeSig() === 'warn'">
  <div class="snackbar-content">
    <span class="snackbar-icon" aria-hidden="true">
      <i class="fas" [ngClass]="{
        'fa-check-circle': snack.typeSig() === 'success',
        'fa-exclamation-triangle': snack.typeSig() === 'warn',
        'fa-times-circle': snack.typeSig() === 'error',
        'fa-info-circle': snack.typeSig() !== 'success' && snack.typeSig() !== 'warn' && snack.typeSig() !== 'error'
      }"></i>
    </span>
    <span class="snackbar-text">{{ snack.messageSig() }}</span>
  </div>
  <div class="snackbar-timer"></div>
</div>
