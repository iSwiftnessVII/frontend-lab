<div class="liba-theme container reactivos-page">
  <h2>Crear nuevo reactivo en Catalogo</h2>
  <section>
  <form class="form-grid" #catalogoForm="ngForm" (ngSubmit)="crearCatalogo($event, catalogoForm)">
    <div>
      <label for="catTipo">Tipo reactivo</label>
      <select id="catTipo" [(ngModel)]="catTipo" name="catTipo" #catTipoCtrl="ngModel" required [class.invalid]="catTipoCtrl.invalid && (catTipoCtrl.touched || submittedCatalogo)">
        <option [ngValue]="''">Seleccione tipo</option>
        <option *ngFor="let t of tipos" [value]="t.nombre">{{ t.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="catTipoCtrl.invalid && (catTipoCtrl.touched || submittedCatalogo)">Seleccione una opci√≥n</span>
    </div>
    <div>
      <label for="catClasificacion">Clasificaci√≥n SGA</label>
  <select id="catClasificacion" [(ngModel)]="catClasificacion" name="catClasificacion" #catClasifCtrl="ngModel" required [class.invalid]="catClasifCtrl.invalid && (catClasifCtrl.touched || submittedCatalogo)" [ngStyle]="getSelectStyleForName(catClasificacion)">
        <option [ngValue]="''">Seleccione clasificaci√≥n</option>
        <option *ngFor="let c of clasif" [value]="c.nombre"
          [style.backgroundColor]="getClasifColorByName(c.nombre)"
          [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">
          {{ c.nombre }}
        </option>
      </select>
      <span class="field-error" *ngIf="catClasifCtrl.invalid && (catClasifCtrl.touched || submittedCatalogo)">Seleccione una opci√≥n</span>
    </div>
    <div class="full-row">
      <label for="catDescripcion">Descripci√≥n</label>
      <textarea id="catDescripcion" [(ngModel)]="catDescripcion" name="catDescripcion" rows="2"></textarea>
    </div>
    <div><button type="submit">Agregar al cat√°logo</button></div>
  </form>
  <!-- Transient toast (used for upload/delete feedback) -->
  <div class="toast" *ngIf="toastMsg" role="status" aria-live="polite">{{ toastMsg }}</div>
</section>
<h2>Catalogo de Reactivos</h2>
<section>
  <div>
    <div class="filters-grid catalogo-filters">
      <div>
        <label for="catalogoCodigoQ">Filtrar por c√≥digo</label>
  <input id="catalogoCodigoQ" [(ngModel)]="codigoFiltro" (input)="filtrarCatalogoPorCampos()" placeholder="Ej: H2SO4" />
      </div>
      <div>
        <label for="catalogoNombreQ">Filtrar por nombre</label>
  <input id="catalogoNombreQ" [(ngModel)]="nombreFiltro" (input)="filtrarCatalogoPorCampos()" placeholder="Ej: √°cido ac√©tico" />
      </div>
      <div class="reset-cell">
        <button type="button" class="btn-reset-filtros" (click)="resetCatalogoPaginado()" aria-label="Reiniciar filtros">Reiniciar filtros</button>
      </div>
    </div>


    <div class="cards-container">
      <p *ngIf="catalogoCargando">Cargando cat√°logo...</p>
      <div class="catalogo-stats" *ngIf="!catalogoCargando && catalogoResultados.length">
        <span>üß™ Mostrando {{ catalogoResultados.length }} de {{ catalogoTotal || catalogoBase.length }} reactivos</span>
      </div>
  <div class="catalogo-cards">
  <article class="catalog-card" *ngFor="let c of catalogoResultados; trackBy: trackByCatalogo">
          <div class="card-top">
            <div class="tags">
              <span class="tag"><strong>C√≥digo: </strong> <span [innerHTML]="highlightField(c.codigo, 'codigo')"></span></span>
              <span class="tag"><strong>Tipo: </strong> <span [innerHTML]="highlightField(c.tipo_reactivo, 'otro')"></span></span>
              <span class="tag"><strong>Clasificaci√≥n: </strong> <span [innerHTML]="highlightField(c.clasificacion_sga, 'otro')"></span></span>
            </div>
            <!-- PDF controls moved out of catalog cards into reactivo creation workflow -->
          </div>
          <div class="card-name" [title]="c.nombre">
            <span [innerHTML]="highlightField(c.nombre, 'nombre')"></span>
            <!-- PDF badges removed from catalog; PDFs are shown for reactivos in inventory -->
          </div>
        </article>
      </div>
      <p *ngIf="!catalogoCargando && !catalogoResultados.length">No hay elementos en el cat√°logo.</p>
    </div>
  </div>
</section>




<!-- Inventario de reactivos -->
<h2>Crear reactivo</h2>
<section>
 
  
  <!-- Formulario de creaci√≥n -->
  <form class="form-grid" #reactivoForm="ngForm" (ngSubmit)="crearReactivo($event, reactivoForm)">
    <div class="field-sm field-autocomplete">
      <label for="lote">Lote</label>
      <input id="lote" [(ngModel)]="lote" name="lote" #loteCtrl="ngModel" required [class.invalid]="loteCtrl.invalid && (loteCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="loteCtrl.invalid && (loteCtrl.touched || submittedReactivo)">Requerido</span>
    </div>
    <div class="field-autocomplete">
      <label for="codigo">C√≥digo (cat√°logo)</label>
      <input id="codigo" [(ngModel)]="codigo" name="codigo" #codigoCtrl="ngModel" (input)="onCodigoInput()" (focus)="onCodigoFocus()" (blur)="onCodigoBlur()" required [class.invalid]="codigoCtrl.invalid && (codigoCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="codigoCtrl.invalid && (codigoCtrl.touched || submittedReactivo)">Requerido</span>
   <div class="autocomplete-panel" role="listbox"
     *ngIf="isCodigoFocused && (codigo.trim().length>=1) && catalogoSugerencias.length && catalogoFiltroCampo==='codigo'">
        <button type="button" class="autocomplete-item" role="option"
       *ngFor="let s of catalogoSugerencias | slice:0:8"
                (mousedown)="$event.preventDefault()"
                (click)="seleccionarCatalogo(s)"
                [title]="s.nombre">
          <span class="code">{{ s.codigo }}</span>
          <span class="name">{{ s.nombre }}</span>
        </button>
      </div>
    </div>
    <div class="field-autocomplete">
      <label for="nombre">Nombre (cat√°logo)</label>
      <input id="nombre" [(ngModel)]="nombre" name="nombre" #nombreCtrl="ngModel" (input)="onNombreInput()" (focus)="onNombreFocus()" (blur)="onNombreBlur()" required [class.invalid]="nombreCtrl.invalid && (nombreCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="nombreCtrl.invalid && (nombreCtrl.touched || submittedReactivo)">Requerido</span>
   <div class="autocomplete-panel" role="listbox"
     *ngIf="isNombreFocused && (nombre.trim().length>=1) && catalogoSugerencias.length && catalogoFiltroCampo==='nombre'">
        <button type="button" class="autocomplete-item" role="option"
       *ngFor="let s of catalogoSugerencias | slice:0:8"
                (mousedown)="$event.preventDefault()"
                (click)="seleccionarCatalogo(s)"
                [title]="s.nombre">
          <span class="code">{{ s.codigo }}</span>
          <span class="name">{{ s.nombre }}</span>
        </button>
      </div>
    </div>

    

    <div>
      <label for="marca">Marca</label>
      <input id="marca" [(ngModel)]="marca" name="marca" #marcaCtrl="ngModel" required [class.invalid]="marcaCtrl.invalid && (marcaCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="marcaCtrl.invalid && (marcaCtrl.touched || submittedReactivo)">Requerido</span>
    </div>
    <div>
      <label for="referencia">Referencia</label>
      <input id="referencia" [(ngModel)]="referencia" name="referencia" #referenciaCtrl="ngModel" required [class.invalid]="referenciaCtrl.invalid && (referenciaCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="referenciaCtrl.invalid && (referenciaCtrl.touched || submittedReactivo)">Requerido</span>
    </div>
    <div>
      <label for="cas">CAS</label>
  <input id="cas" [(ngModel)]="cas" name="cas" #casCtrl="ngModel" required title="Formato: 64-17-5" (blur)="onCasBlur()" [class.invalid]="casCtrl.invalid && (casCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="casCtrl.errors?.['required'] && (casCtrl.touched || submittedReactivo)">Requerido</span>
      <span class="field-error" *ngIf="casCtrl.errors?.['pattern'] && (casCtrl.touched || submittedReactivo)">Formato CAS inv√°lido (ej: 64-17-5)</span>
    </div>

    <div class="field-sm">
      <label for="presentacion">Presentaci√≥n</label>
      <input id="presentacion" type="number" [(ngModel)]="presentacion" name="presentacion" min="0" step="any" required #presentacionCtrl="ngModel" (input)="calcularCantidadTotal()" [class.invalid]="presentacionCtrl.invalid && (presentacionCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="presentacionCtrl.errors?.['required'] && (presentacionCtrl.touched || submittedReactivo)">Requerido</span>
      <span class="field-error" *ngIf="presentacionCtrl.errors?.['min'] && (presentacionCtrl.touched || submittedReactivo)">No puede ser negativo</span>
    </div>
    <div>
      <label for="unidad_id">Unidad</label>
      <select id="unidad_id" [(ngModel)]="unidad_id" name="unidad_id" #unidadCtrl="ngModel" required [class.invalid]="unidadCtrl.invalid && (unidadCtrl.touched || submittedReactivo)">
        <option [ngValue]="''">Seleccione unidad</option>
        <option *ngFor="let u of unidades" [value]="u.id">{{ u.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="unidadCtrl.invalid && (unidadCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
    <div class="field-sm">
      <label for="presentacion_cant">Cantidad x presentaci√≥n</label>
      <input id="presentacion_cant" type="number" [(ngModel)]="presentacion_cant" name="presentacion_cant" min="0" step="any" required #presentCantCtrl="ngModel" (input)="calcularCantidadTotal()" [class.invalid]="presentCantCtrl.invalid && (presentCantCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="presentCantCtrl.errors?.['required'] && (presentCantCtrl.touched || submittedReactivo)">Requerido</span>
      <span class="field-error" *ngIf="presentCantCtrl.errors?.['min'] && (presentCantCtrl.touched || submittedReactivo)">No puede ser negativo</span>
    </div>
    <div class="field-sm">
      <label for="cantidad_total">Cantidad total</label>
      <input id="cantidad_total" type="number" [(ngModel)]="cantidad_total" name="cantidad_total" readonly />
    </div>

    <div>
      <label for="fecha_adquisicion">Fecha de adquisici√≥n</label>
      <input id="fecha_adquisicion" type="date" [(ngModel)]="fecha_adquisicion" name="fecha_adquisicion" #fechaAdqCtrl="ngModel" required [class.invalid]="fechaAdqCtrl.invalid && (fechaAdqCtrl.touched || submittedReactivo)" />
      <span class="field-error" *ngIf="fechaAdqCtrl.invalid && (fechaAdqCtrl.touched || submittedReactivo)">Requerido</span>
    </div>
    <div>
      <label for="fecha_vencimiento">Fecha de vencimiento</label>
      <input id="fecha_vencimiento" type="date" [(ngModel)]="fecha_vencimiento" name="fecha_vencimiento" #fechaVencCtrl="ngModel" required [class.invalid]="(fechaVencCtrl.invalid && (fechaVencCtrl.touched || submittedReactivo)) || fechasInconsistentes()" />
      <span class="field-error" *ngIf="fechaVencCtrl.invalid && (fechaVencCtrl.touched || submittedReactivo)">Requerido</span>
      <span class="field-error" *ngIf="!fechaVencCtrl.invalid && fechasInconsistentes()">Vencimiento no puede ser anterior a adquisici√≥n</span>
    </div>
    <div class="full-row">
      <label for="observaciones">Observaciones</label>
      <textarea id="observaciones" [(ngModel)]="observaciones" name="observaciones" rows="2"></textarea>
    </div>

    <!-- PDF uploads for reactivo creation: SDS (Hoja de seguridad) and CoA (Certificado de an√°lisis) -->
    <div>
      <label for="sdsFile">Hoja de seguridad (SDS)</label>
      <input id="sdsFile" type="file" accept="application/pdf" (change)="onSdsSelected($event)" />
    </div>
    <div>
      <label for="coaFile">Certificado de an√°lisis (CoA)</label>
      <input id="coaFile" type="file" accept="application/pdf" (change)="onCoaSelected($event)" />
    </div>

    <div>
      <label for="tipo_id">Tipo reactivo</label>
      <select id="tipo_id" [(ngModel)]="tipo_id" name="tipo_id" #tipoIdCtrl="ngModel" required [class.invalid]="tipoIdCtrl.invalid && (tipoIdCtrl.touched || submittedReactivo)">
        <option [ngValue]="''">Seleccione tipo</option>
        <option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="tipoIdCtrl.invalid && (tipoIdCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
    <div>
      <label for="clasificacion_id">Clasificaci√≥n SGA</label>
  <select id="clasificacion_id" [(ngModel)]="clasificacion_id" name="clasificacion_id" #clasifIdCtrl="ngModel" required [class.invalid]="clasifIdCtrl.invalid && (clasifIdCtrl.touched || submittedReactivo)" [ngStyle]="getSelectStyleForId(clasificacion_id)">
        <option [ngValue]="''">Seleccione clasificaci√≥n</option>
        <option *ngFor="let c of clasif" [value]="c.id"
          [style.backgroundColor]="getClasifColorByName(c.nombre)"
          [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">
          {{ c.nombre }}
        </option>
      </select>
      <span class="field-error" *ngIf="clasifIdCtrl.invalid && (clasifIdCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
    <div>
      <label for="estado_id">Estado</label>
      <select id="estado_id" [(ngModel)]="estado_id" name="estado_id" #estadoIdCtrl="ngModel" required [class.invalid]="estadoIdCtrl.invalid && (estadoIdCtrl.touched || submittedReactivo)">
        <option [ngValue]="''">Seleccione estado</option>
        <option *ngFor="let e of estado" [value]="e.id">{{ e.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="estadoIdCtrl.invalid && (estadoIdCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
    <div>
      <label for="tipo_recipiente_id">Tipo de recipiente</label>
      <select id="tipo_recipiente_id" [(ngModel)]="tipo_recipiente_id" name="tipo_recipiente_id" #recipienteIdCtrl="ngModel" required [class.invalid]="recipienteIdCtrl.invalid && (recipienteIdCtrl.touched || submittedReactivo)">
        <option [ngValue]="''">Seleccione recipiente</option>
        <option *ngFor="let r of recipiente" [value]="r.id">{{ r.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="recipienteIdCtrl.invalid && (recipienteIdCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
    <div>
      <label for="almacenamiento_id">Almacenamiento</label>
      <select id="almacenamiento_id" [(ngModel)]="almacenamiento_id" name="almacenamiento_id" #almacenIdCtrl="ngModel" required [class.invalid]="almacenIdCtrl.invalid && (almacenIdCtrl.touched || submittedReactivo)">
        <option [ngValue]="''">Seleccione almacenamiento</option>
        <option *ngFor="let a of almacen" [value]="a.id">{{ a.nombre }}</option>
      </select>
      <span class="field-error" *ngIf="almacenIdCtrl.invalid && (almacenIdCtrl.touched || submittedReactivo)">Seleccione una opci√≥n</span>
    </div>
      <div class="form-actions">
        <button type="submit" class="btn-create">{{ editMode ? 'Guardar cambios' : 'Crear reactivo' }}</button>
        <button type="button" *ngIf="editMode" (click)="resetReactivoForm()" style="margin-left:8px; background:#777; color:#fff; border:1px solid #666;">Cancelar</button>
      </div>
  </form>
  <div>
    <p *ngIf="reactivoMsg">{{ reactivoMsg }}</p>
  </div>
    
</section>

<h2>Inventario de Reactivos</h2>
<section>
  <!-- Lista y b√∫squeda de reactivos existentes -->
  <div>

    <div class="filters-row reactivos-filters">
      <div>
        <label for="reactLoteQ">Filtrar por Lote</label>
        <input id="reactLoteQ" [(ngModel)]="reactivosLoteQ" (input)="filtrarReactivos()" />
      </div>
      <div>
        <label for="reactCodigoQ">Filtrar por C√≥digo</label>
        <input id="reactCodigoQ" [(ngModel)]="reactivosCodigoQ" (input)="filtrarReactivos()" />
      </div>
      <div>
        <label for="reactNombreQ">Filtrar por Nombre</label>
        <input id="reactNombreQ" [(ngModel)]="reactivosNombreQ" (input)="filtrarReactivos()" />
      </div>
    </div>
    <div class="cards-container">
      <div class="catalogo-stats" *ngIf="reactivos && reactivos.length">
        <span>üß™ Mostrando {{ reactivosFiltrados.length }} de {{ reactivos.length }} reactivos</span>
      </div>
      <div class="catalogo-cards">
        <article class="catalog-card reactivo-card" *ngFor="let r of reactivosFiltrados; trackBy: trackByReactivo"
                 (click)="toggleExpand(r)" [attr.aria-expanded]="isExpanded(r)" tabindex="0">
          <div class="card-top">
            <div class="tags">
              <span class="tag"><strong>C√≥digo:</strong> {{ r.codigo }}</span>
              <span class="tag"><strong>Lote:</strong> {{ r.lote }}</span>
              <span class="tag"><strong>Estado:</strong> {{ obtenerNombreEstado(r.estado_id) }}</span>
              <span class="tag"><strong>Marca:</strong> {{ r.marca || '‚Äî' }}</span>
              <span class="tag" [style.borderColor]="getClasifColor(r.clasificacion_id)"><strong>SGA:</strong> {{ obtenerNombreClasificacion(r.clasificacion_id) }}</span>
              <span class="tag" *ngIf="getVencimientoInfo(r.fecha_vencimiento) as v"
                [style.backgroundColor]="v.bg"
                [style.color]="v.fg"
                [attr.title]="v.title">
                {{ v.text }}
              </span>
            </div>
            <div class="pdf-actions" aria-label="Acciones del reactivo" (click)="$event.stopPropagation()">
              <div class="pdf-group">
                <button type="button" class="pdf-btn view" title="Editar reactivo" aria-label="Editar reactivo" (click)="openEditModal(r)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z" fill="currentColor"/></svg>
                </button>
                <button type="button" class="pdf-btn delete" title="Eliminar reactivo" aria-label="Eliminar reactivo" (click)="eliminarReactivo(r.lote)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
              </div>
            </div>
          </div>
          <div class="card-name" [title]="r.nombre">
            <div class="name-line">{{ r.nombre }}</div>

            <!-- Botones y etiquetas PDF a la derecha -->
            <div class="name-pdfs" (click)="$event.stopPropagation()">
              <div class="pdf-box pdf-sds" role="group" aria-label="SDS controls">
                <!-- SDS group -->
                <button type="button" class="pdf-btn view" title="Ver hoja de seguridad (SDS)" aria-label="Ver hoja de seguridad" (click)="$event.stopPropagation(); onVerHojaCatalogo(r.codigo)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
                <span class="pdf-availability" [title]="(pdfStatus[r.codigo] && pdfStatus[r.codigo].hoja===true) ? 'Subido' : ((pdfStatus[r.codigo] && pdfStatus[r.codigo].hoja===false) ? 'No subido' : 'Comprobando')" [class.loading]="pdfStatus[r.codigo] && pdfStatus[r.codigo].hoja===null" [class.ok]="pdfStatus[r.codigo] && pdfStatus[r.codigo].hoja===true" [class.fail]="pdfStatus[r.codigo] && pdfStatus[r.codigo].hoja===false">SDS</span>
                <button type="button" class="pdf-btn delete" title="Eliminar hoja de seguridad" aria-label="Eliminar hoja de seguridad" (click)="$event.stopPropagation(); onEliminarHojaCatalogo(r.codigo)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
                <input type="file" accept="application/pdf" (change)="onSubirHojaCatalogo($event, r.codigo)" #sdsInput style="display:none" />
                <button type="button" class="pdf-btn upload" title="Subir hoja de seguridad" aria-label="Subir hoja de seguridad" (click)="$event.stopPropagation(); sdsInput.click()">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>

              <div class="pdf-box pdf-coa" role="group" aria-label="CoA controls">
                <!-- CoA group -->
                <button type="button" class="pdf-btn view" title="Ver certificado de an√°lisis (CoA)" aria-label="Ver certificado de an√°lisis" (click)="$event.stopPropagation(); onVerCertCatalogo(r.codigo)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
                <span class="pdf-availability" [title]="(pdfStatus[r.codigo] && pdfStatus[r.codigo].cert===true) ? 'Subido' : ((pdfStatus[r.codigo] && pdfStatus[r.codigo].cert===false) ? 'No subido' : 'Comprobando')" [class.loading]="pdfStatus[r.codigo] && pdfStatus[r.codigo].cert===null" [class.ok]="pdfStatus[r.codigo] && pdfStatus[r.codigo].cert===true" [class.fail]="pdfStatus[r.codigo] && pdfStatus[r.codigo].cert===false">CoA</span>
                <button type="button" class="pdf-btn delete" title="Eliminar certificado de an√°lisis" aria-label="Eliminar certificado de an√°lisis" (click)="$event.stopPropagation(); onEliminarCertCatalogo(r.codigo)">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
                <input type="file" accept="application/pdf" (change)="onSubirCertCatalogo($event, r.codigo)" #coaInput style="display:none" />
                <button type="button" class="pdf-btn upload" title="Subir certificado de an√°lisis" aria-label="Subir certificado de an√°lisis" (click)="$event.stopPropagation(); coaInput.click()">
                  <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            </div>

            <div class="meta-line">
              <span class="chip">{{ obtenerNombreTipo(r.tipo_id) }}</span>
              <span class="chip">{{ r.cantidad_total }} {{ obtenerNombreUnidad(r.unidad_id) }}</span>
              <span class="chip">Vence: {{ formatearFecha(r.fecha_vencimiento) }}</span>
            </div>

            <span class="toggle-icon" [class.open]="isExpanded(r)" aria-hidden="true">‚ñæ</span>
          </div>
          <div class="card-expand" *ngIf="isExpanded(r)" (click)="$event.stopPropagation()">
            <div class="expand-grid">
              <div class="section-label">Detalle</div>
              <div><strong>Referencia:</strong> {{ r.referencia || '‚Äî' }}</div>
              <div><strong>CAS:</strong> {{ r.cas || '‚Äî' }}</div>

              <div class="section-label">Presentaci√≥n y unidad</div>
              <div><strong>Presentaci√≥n:</strong> {{ r.presentacion || '‚Äî' }}</div>
              <div><strong>Cant. x presentaci√≥n:</strong> {{ r.presentacion_cant || '‚Äî' }}</div>
              <div><strong>Unidad:</strong> {{ obtenerNombreUnidad(r.unidad_id) }}</div>

              <div class="section-label">Manejo y almacenamiento</div>
              <div><strong>Almacenamiento:</strong> {{ obtenerNombreAlmacenamiento(r.almacenamiento_id) }}</div>
              <div><strong>Recipiente:</strong> {{ obtenerNombreTipoRecipiente(r.tipo_recipiente_id) }}</div>

              <div class="section-label">Fechas</div>
              <div><strong>Adquisici√≥n:</strong> {{ formatearFecha(r.fecha_adquisicion) }}</div>
              <div><strong>Vencimiento:</strong> {{ formatearFecha(r.fecha_vencimiento) }}</div>

              <div class="full" *ngIf="r.observaciones"><strong>Observaciones:</strong> {{ r.observaciones }}</div>
            </div>
          </div>
        </article>
      </div>
      <p *ngIf="reactivosFiltrados && reactivosFiltrados.length === 0">No hay reactivos que coincidan con los filtros.</p>
      <p *ngIf="reactivos && reactivos.length === 0">No hay reactivos cargados.</p>
    </div>
  </div>

  

</section>
<!-- Modal de edici√≥n de reactivo -->
<div class="modal-backdrop" *ngIf="editModalOpen" (click)="closeEditModal()"></div>
<div class="modal" *ngIf="editModalOpen" role="dialog" aria-modal="true" aria-label="Editar reactivo" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <button type="button" class="close-btn" (click)="closeEditModal()" aria-label="Cerrar">√ó</button>
  </div>
  <form class="form-grid" #editForm="ngForm" (ngSubmit)="guardarEdicion(editForm)">
    <div class="field-sm">
      <label for="edit_lote">Lote</label>
      <input id="edit_lote" [(ngModel)]="editFormData.lote" name="edit_lote" #editLoteCtrl="ngModel" required [class.invalid]="editLoteCtrl.invalid && (editLoteCtrl.touched || editSubmitted)" />
      <span class="field-error" *ngIf="editLoteCtrl.invalid && (editLoteCtrl.touched || editSubmitted)">Requerido</span>
    </div>
    <div>
      <label for="edit_codigo">C√≥digo (cat√°logo)</label>
      <input id="edit_codigo" [(ngModel)]="editFormData.codigo" name="edit_codigo" #editCodigoCtrl="ngModel" required [class.invalid]="editCodigoCtrl.invalid && (editCodigoCtrl.touched || editSubmitted)" />
      <span class="field-error" *ngIf="editCodigoCtrl.invalid && (editCodigoCtrl.touched || editSubmitted)">Requerido</span>
    </div>
    <div>
      <label for="edit_nombre">Nombre (cat√°logo)</label>
      <input id="edit_nombre" [(ngModel)]="editFormData.nombre" name="edit_nombre" #editNombreCtrl="ngModel" required [class.invalid]="editNombreCtrl.invalid && (editNombreCtrl.touched || editSubmitted)" />
      <span class="field-error" *ngIf="editNombreCtrl.invalid && (editNombreCtrl.touched || editSubmitted)">Requerido</span>
    </div>
    <div>
      <label for="edit_marca">Marca</label>
      <input id="edit_marca" [(ngModel)]="editFormData.marca" name="edit_marca" />
    </div>
    <div>
      <label for="edit_referencia">Referencia</label>
      <input id="edit_referencia" [(ngModel)]="editFormData.referencia" name="edit_referencia" />
    </div>
    <div>
      <label for="edit_cas">CAS</label>
  <input id="edit_cas" [(ngModel)]="editFormData.cas" name="edit_cas" title="Formato: 64-17-5" #editCasCtrl="ngModel" (blur)="onEditCasBlur()" [class.invalid]="editCasCtrl.invalid && (editCasCtrl.touched || editSubmitted)" />
      <span class="field-error" *ngIf="editCasCtrl.errors?.['pattern'] && (editCasCtrl.touched || editSubmitted)">Formato CAS inv√°lido</span>
    </div>
    <div class="field-sm">
      <label for="edit_presentacion">Presentaci√≥n</label>
      <input id="edit_presentacion" type="number" [(ngModel)]="editFormData.presentacion" name="edit_presentacion" min="0" step="any" />
    </div>
    <div class="field-sm">
      <label for="edit_presentacion_cant">Cantidad x presentaci√≥n</label>
      <input id="edit_presentacion_cant" type="number" [(ngModel)]="editFormData.presentacion_cant" name="edit_presentacion_cant" min="0" step="any" />
    </div>
    <div class="field-sm">
      <label for="edit_cantidad_total">Cantidad total</label>
      <input id="edit_cantidad_total" type="number" [(ngModel)]="editFormData.cantidad_total" name="edit_cantidad_total" readonly />
    </div>
    <div>
      <label for="edit_fecha_adq">Fecha de adquisici√≥n</label>
      <input id="edit_fecha_adq" type="date" [(ngModel)]="editFormData.fecha_adquisicion" name="edit_fecha_adq" />
    </div>
    <div>
      <label for="edit_fecha_venc">Fecha de vencimiento</label>
      <input id="edit_fecha_venc" type="date" [(ngModel)]="editFormData.fecha_vencimiento" name="edit_fecha_venc" />
    </div>
    <div>
      <label for="edit_tipo">Tipo reactivo</label>
      <select id="edit_tipo" [(ngModel)]="editFormData.tipo_id" name="edit_tipo">
        <option [ngValue]="''">Seleccione tipo</option>
        <option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</option>
      </select>
    </div>
    <div>
      <label for="edit_clasif">Clasificaci√≥n SGA</label>
      <select id="edit_clasif" [(ngModel)]="editFormData.clasificacion_id" name="edit_clasif" [ngStyle]="getSelectStyleForId(editFormData.clasificacion_id)">
        <option [ngValue]="''">Seleccione clasificaci√≥n</option>
        <option *ngFor="let c of clasif" [value]="c.id" [style.backgroundColor]="getClasifColorByName(c.nombre)" [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">{{ c.nombre }}</option>
      </select>
    </div>
    <div>
      <label for="edit_unidad">Unidad</label>
      <select id="edit_unidad" [(ngModel)]="editFormData.unidad_id" name="edit_unidad">
        <option [ngValue]="''">Seleccione unidad</option>
        <option *ngFor="let u of unidades" [value]="u.id">{{ u.nombre }}</option>
      </select>
    </div>
    <div>
      <label for="edit_estado">Estado</label>
      <select id="edit_estado" [(ngModel)]="editFormData.estado_id" name="edit_estado">
        <option [ngValue]="''">Seleccione estado</option>
        <option *ngFor="let e of estado" [value]="e.id">{{ e.nombre }}</option>
      </select>
    </div>
    <div>
      <label for="edit_recipiente">Recipiente</label>
      <select id="edit_recipiente" [(ngModel)]="editFormData.tipo_recipiente_id" name="edit_recipiente">
        <option [ngValue]="''">Seleccione recipiente</option>
        <option *ngFor="let rtp of recipiente" [value]="rtp.id">{{ rtp.nombre }}</option>
      </select>
    </div>
    <div>
      <label for="edit_almacen">Almacenamiento</label>
      <select id="edit_almacen" [(ngModel)]="editFormData.almacenamiento_id" name="edit_almacen">
        <option [ngValue]="''">Seleccione almacenamiento</option>
        <option *ngFor="let a of almacen" [value]="a.id">{{ a.nombre }}</option>
      </select>
    </div>
    <div class="full-row">
      <label for="edit_obs">Observaciones</label>
      <textarea id="edit_obs" [(ngModel)]="editFormData.observaciones" name="edit_obs" rows="2"></textarea>
    </div>
    <div class="actions">
      <button type="submit">Guardar cambios</button>
    </div>
  </form>
  
</div>

