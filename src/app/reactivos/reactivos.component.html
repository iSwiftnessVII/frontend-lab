<div class="liba-theme container reactivos-page">
  <h2>Crear nuevo reactivo en Catalogo</h2>
  <section>
    <form class="form-grid" #catalogoForm="ngForm" (ngSubmit)="crearCatalogo($event, catalogoForm)">
      <div>
        <label for="catCodigo">C√≥digo</label>
        <input id="catCodigo" [(ngModel)]="catCodigo" name="catCodigo" #catCodigoCtrl="ngModel" required
          [class.invalid]="catCodigoCtrl.invalid && (catCodigoCtrl.touched || submittedCatalogo)" placeholder="Ej: H2SO4" />
        @if (catCodigoCtrl.invalid && (catCodigoCtrl.touched || submittedCatalogo)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="catNombre">Nombre</label>
        <input id="catNombre" [(ngModel)]="catNombre" name="catNombre" #catNombreCtrl="ngModel" required
          [class.invalid]="catNombreCtrl.invalid && (catNombreCtrl.touched || submittedCatalogo)" placeholder="Ej: √Åcido ac√©tico" />
        @if (catNombreCtrl.invalid && (catNombreCtrl.touched || submittedCatalogo)) {
        <span class="field-error">Requerido</span>
        }
      </div>
      <div>
        <label for="catTipo">Tipo reactivo</label>
        <select id="catTipo" [(ngModel)]="catTipo" name="catTipo" #catTipoCtrl="ngModel" required
          [class.invalid]="catTipoCtrl.invalid && (catTipoCtrl.touched || submittedCatalogo)">
          <option [ngValue]="''">Seleccione tipo</option>
          @for (t of tipos; track t) {
          <option [value]="t.nombre">{{ t.nombre }}</option>
          }
        </select>
        @if (catTipoCtrl.invalid && (catTipoCtrl.touched || submittedCatalogo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>
      <div>
        <label for="catClasificacion">Clasificaci√≥n SGA</label>
        <select id="catClasificacion" [(ngModel)]="catClasificacion" name="catClasificacion" #catClasifCtrl="ngModel"
          required [class.invalid]="catClasifCtrl.invalid && (catClasifCtrl.touched || submittedCatalogo)"
          [ngStyle]="getSelectStyleForName(catClasificacion)">
          <option [ngValue]="''">Seleccione clasificaci√≥n</option>
          @for (c of clasif; track c) {
          <option [value]="c.nombre" [style.backgroundColor]="getClasifColorByName(c.nombre)"
            [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">
            {{ c.nombre }}
          </option>
          }
        </select>
        @if (catClasifCtrl.invalid && (catClasifCtrl.touched || submittedCatalogo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>
      <div class="full-row">
        <label for="catDescripcion">Descripci√≥n</label>
        <textarea id="catDescripcion" [(ngModel)]="catDescripcion" name="catDescripcion" rows="2"></textarea>
      </div>
      <div><button type="submit">Agregar al cat√°logo</button></div>
    </form>

    <!-- Transient toast (used for upload/delete feedback) -->
    @if (toastMsg) {
    <div class="toast" role="status" aria-live="polite">{{ toastMsg }}</div>
    }
  </section>

  <h2>Catalogo de Reactivos</h2>
  <section>
    <div>
      <div class="filters-grid catalogo-filters">
        <div>
          <label for="catalogoCodigoQ">Filtrar por c√≥digo</label>
          <input id="catalogoCodigoQ" [(ngModel)]="codigoFiltro" (input)="filtrarCatalogoPorCampos()"
            placeholder="Ej: H2SO4" />
        </div>
        <div>
          <label for="catalogoNombreQ">Filtrar por nombre</label>
          <input id="catalogoNombreQ" [(ngModel)]="nombreFiltro" (input)="filtrarCatalogoPorCampos()"
            placeholder="Ej: √°cido ac√©tico" />
        </div>
        <div class="reset-cell">
          <button type="button" class="btn-load-more" (click)="cargarMasCatalogo()"
            [disabled]="catalogoResultados.length >= (catalogoTotal || 0)" aria-label="Cargar m√°s reactivos">Cargar m√°s
            reactivos</button>
        </div>
      </div>

      <div class="cards-container">
        @if (catalogoCargando) {
        <p>Cargando cat√°logo...</p>
        }

        @if (!catalogoCargando && catalogoResultados.length) {
        <div class="catalogo-stats">
          <span>üß™ Mostrando {{ catalogoResultados.length }} de {{ catalogoTotal || catalogoBase.length }}
            reactivos</span>
        </div>
        }

        <div class="catalogo-cards">
          @for (c of catalogoResultados; track trackByCatalogo($index, c)) {
          <article class="catalog-card">
            <div class="card-top">
              <div class="tags">
                <span class="tag"><strong>C√≥digo: </strong> <span
                    [innerHTML]="highlightField(c.codigo, 'codigo')"></span></span>
                <span class="tag"><strong>Tipo: </strong> <span
                    [innerHTML]="highlightField(c.tipo_reactivo, 'otro')"></span></span>
                <span class="tag"><strong>Clasificaci√≥n: </strong> <span
                    [innerHTML]="highlightField(c.clasificacion_sga, 'otro')"></span></span>
              </div>
              @if (canDelete()) {
                <button
                  type="button"
                  class="pdf-btn delete"
                  title="Eliminar del cat√°logo"
                  aria-label="Eliminar del cat√°logo"
                  (click)="onDeleteCatalogo(c, $event)"
                  [disabled]="isDeleteCatalogoLoading(c)"
                  [attr.aria-busy]="isDeleteCatalogoLoading(c) ? 'true' : null">
                  <i class="fas fa-trash" aria-hidden="true"></i>
                </button>
              }
            </div>
            <div class="card-name" [title]="c.nombre">
              <span [innerHTML]="highlightField(c.nombre, 'nombre')"></span>
            </div>
          </article>
          }
        </div>

        @if (!catalogoCargando && !catalogoResultados.length) {
        <p>No hay elementos en el cat√°logo.</p>
        }
      </div>
    </div>
  </section>

  <!-- Inventario de reactivos -->
  <h2>Crear reactivo</h2>
  <section>
    <!-- Formulario de creaci√≥n -->
    <form class="form-grid" #reactivoForm="ngForm" (ngSubmit)="crearReactivo($event, reactivoForm)">
      <div class="field-sm field-autocomplete">
        <label for="lote">Lote</label>
        <input id="lote" [(ngModel)]="lote" name="lote" #loteCtrl="ngModel" required
          [class.invalid]="loteCtrl.invalid && (loteCtrl.touched || submittedReactivo)" />
        @if (loteCtrl.invalid && (loteCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div class="field-autocomplete">
        <label for="codigo">C√≥digo (cat√°logo)</label>
        <input id="codigo" [(ngModel)]="codigo" name="codigo" #codigoCtrl="ngModel" (input)="onCodigoInput()"
          (focus)="onCodigoFocus()" (blur)="onCodigoBlur()" required
          [class.invalid]="codigoCtrl.invalid && (codigoCtrl.touched || submittedReactivo)" />
        @if (codigoCtrl.invalid && (codigoCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }

        @if (isCodigoFocused && (codigo.trim().length>=1) && catalogoSugerencias.length &&
        catalogoFiltroCampo==='codigo') {
        <div class="autocomplete-panel" role="listbox">
          @for (s of catalogoSugerencias | slice:0:8; track s) {
          <button type="button" class="autocomplete-item" role="option" (mousedown)="$event.preventDefault()"
            (click)="seleccionarCatalogo(s)" [title]="s.nombre">
            <span class="code">{{ s.codigo }}</span>
            <span class="name">{{ s.nombre }}</span>
          </button>
          }
        </div>
        }
      </div>

      <div class="field-autocomplete">
        <label for="nombre">Nombre (cat√°logo)</label>
        <input id="nombre" [(ngModel)]="nombre" name="nombre" #nombreCtrl="ngModel" (input)="onNombreInput()"
          (focus)="onNombreFocus()" (blur)="onNombreBlur()" required
          [class.invalid]="nombreCtrl.invalid && (nombreCtrl.touched || submittedReactivo)" />
        @if (nombreCtrl.invalid && (nombreCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }

        @if (isNombreFocused && (nombre.trim().length>=1) && catalogoSugerencias.length &&
        catalogoFiltroCampo==='nombre') {
        <div class="autocomplete-panel" role="listbox">
          @for (s of catalogoSugerencias | slice:0:8; track s) {
          <button type="button" class="autocomplete-item" role="option" (mousedown)="$event.preventDefault()"
            (click)="seleccionarCatalogo(s)" [title]="s.nombre">
            <span class="code">{{ s.codigo }}</span>
            <span class="name">{{ s.nombre }}</span>
          </button>
          }
        </div>
        }
      </div>

      <div>
        <label for="marca">Marca</label>
        <input id="marca" [(ngModel)]="marca" name="marca" #marcaCtrl="ngModel" required
          [class.invalid]="marcaCtrl.invalid && (marcaCtrl.touched || submittedReactivo)" />
        @if (marcaCtrl.invalid && (marcaCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="referencia">Referencia</label>
        <input id="referencia" [(ngModel)]="referencia" name="referencia" #referenciaCtrl="ngModel" required
          [class.invalid]="referenciaCtrl.invalid && (referenciaCtrl.touched || submittedReactivo)" />
        @if (referenciaCtrl.invalid && (referenciaCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="cas">CAS</label>
        <input id="cas" [(ngModel)]="cas" name="cas" #casCtrl="ngModel" required title="Formato: 64-17-5"
          (blur)="onCasBlur()" [class.invalid]="casCtrl.invalid && (casCtrl.touched || submittedReactivo)" />
        @if (casCtrl.errors?.['required'] && (casCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
        @if (casCtrl.errors?.['pattern'] && (casCtrl.touched || submittedReactivo)) {
        <span class="field-error">Formato CAS inv√°lido (ej: 64-17-5)</span>
        }
      </div>

      <div class="field-sm">
        <label for="presentacion">Presentaci√≥n</label>
        <input id="presentacion" type="number" [(ngModel)]="presentacion" name="presentacion" min="0" step="any"
          required #presentacionCtrl="ngModel" (input)="calcularCantidadTotal()"
          [class.invalid]="presentacionCtrl.invalid && (presentacionCtrl.touched || submittedReactivo)" />

        @if (presentacionCtrl.errors?.['required'] && (presentacionCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }

        @if (presentacionCtrl.errors?.['min'] && (presentacionCtrl.touched || submittedReactivo)) {
        <span class="field-error">No puede ser negativo</span>
        }
      </div>

      <div>
        <label for="unidad_id">Unidad</label>
        <select id="unidad_id" [(ngModel)]="unidad_id" name="unidad_id" #unidadCtrl="ngModel" required
          [class.invalid]="unidadCtrl.invalid && (unidadCtrl.touched || submittedReactivo)">
          <option [ngValue]="''">Seleccione unidad</option>
          @for (u of unidades; track u) {
          <option [value]="u.id">{{ u.nombre }}</option>
          }
        </select>
        @if (unidadCtrl.invalid && (unidadCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div class="field-sm">
        <label for="presentacion_cant">Cantidad x presentaci√≥n</label>
        <input id="presentacion_cant" type="number" [(ngModel)]="presentacion_cant" name="presentacion_cant" min="0"
          step="any" required #presentCantCtrl="ngModel" (input)="calcularCantidadTotal()"
          [class.invalid]="presentCantCtrl.invalid && (presentCantCtrl.touched || submittedReactivo)" />
        @if (presentCantCtrl.errors?.['required'] && (presentCantCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
        @if (presentCantCtrl.errors?.['min'] && (presentCantCtrl.touched || submittedReactivo)) {
        <span class="field-error">No puede ser negativo</span>
        }
      </div>

      <div class="field-sm">
        <label for="cantidad_total">Cantidad total</label>
        <input id="cantidad_total" type="number" [(ngModel)]="cantidad_total" name="cantidad_total" readonly />
      </div>

      <div>
        <label for="fecha_adquisicion">Fecha de adquisici√≥n</label>
        <input id="fecha_adquisicion" type="date" [(ngModel)]="fecha_adquisicion" name="fecha_adquisicion"
          #fechaAdqCtrl="ngModel" required
          [class.invalid]="fechaAdqCtrl.invalid && (fechaAdqCtrl.touched || submittedReactivo)" />
        @if (fechaAdqCtrl.invalid && (fechaAdqCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="fecha_vencimiento">Fecha de vencimiento</label>
        <input id="fecha_vencimiento" type="date" [(ngModel)]="fecha_vencimiento" name="fecha_vencimiento"
          #fechaVencCtrl="ngModel" required
          [class.invalid]="(fechaVencCtrl.invalid && (fechaVencCtrl.touched || submittedReactivo)) || fechasInconsistentes()" />
        @if (fechaVencCtrl.invalid && (fechaVencCtrl.touched || submittedReactivo)) {
        <span class="field-error">Requerido</span>
        }
        @if (!fechaVencCtrl.invalid && fechasInconsistentes()) {
        <span class="field-error">Vencimiento no puede ser anterior a adquisici√≥n</span>
        }
      </div>

      <div class="full-row">
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" [(ngModel)]="observaciones" name="observaciones" rows="2"></textarea>
      </div>

      <!-- PDF uploads for reactivo creation: SDS (Hoja de seguridad) and CoA (Certificado de an√°lisis) -->
      <div>
        <label for="sdsFile">Hoja de seguridad (SDS)</label>
        <input id="sdsFile" type="file" accept="application/pdf" (change)="onSdsSelected($event)" />
      </div>

      <div>
        <label for="coaFile">Certificado de an√°lisis (CoA)</label>
        <input id="coaFile" type="file" accept="application/pdf" (change)="onCoaSelected($event)" />
      </div>

      <div>
        <label for="tipo_id">Tipo reactivo</label>
        <select id="tipo_id" [(ngModel)]="tipo_id" name="tipo_id" #tipoIdCtrl="ngModel" required
          [class.invalid]="tipoIdCtrl.invalid && (tipoIdCtrl.touched || submittedReactivo)">
          <option [ngValue]="''">Seleccione tipo</option>
          @for (t of tipos; track t) {
          <option [value]="t.id">{{ t.nombre }}</option>
          }
        </select>
        @if (tipoIdCtrl.invalid && (tipoIdCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div>
        <label for="clasificacion_id">Clasificaci√≥n SGA</label>
        <select id="clasificacion_id" [(ngModel)]="clasificacion_id" name="clasificacion_id" #clasifIdCtrl="ngModel"
          required [class.invalid]="clasifIdCtrl.invalid && (clasifIdCtrl.touched || submittedReactivo)"
          [ngStyle]="getSelectStyleForId(clasificacion_id)">
          <option [ngValue]="''">Seleccione clasificaci√≥n</option>
          @for (c of clasif; track c) {
          <option [value]="c.id" [style.backgroundColor]="getClasifColorByName(c.nombre)"
            [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">
            {{ c.nombre }}
          </option>
          }
        </select>
        @if (clasifIdCtrl.invalid && (clasifIdCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div>
        <label for="estado_id">Estado</label>
        <select id="estado_id" [(ngModel)]="estado_id" name="estado_id" #estadoIdCtrl="ngModel" required
          [class.invalid]="estadoIdCtrl.invalid && (estadoIdCtrl.touched || submittedReactivo)">
          <option [ngValue]="''">Seleccione estado</option>
          @for (e of estado; track e) {
          <option [value]="e.id">{{ e.nombre }}</option>
          }
        </select>
        @if (estadoIdCtrl.invalid && (estadoIdCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div>
        <label for="tipo_recipiente_id">Tipo de recipiente</label>
        <select id="tipo_recipiente_id" [(ngModel)]="tipo_recipiente_id" name="tipo_recipiente_id"
          #recipienteIdCtrl="ngModel" required
          [class.invalid]="recipienteIdCtrl.invalid && (recipienteIdCtrl.touched || submittedReactivo)">
          <option [ngValue]="''">Seleccione recipiente</option>
          @for (r of recipiente; track r) {
          <option [value]="r.id">{{ r.nombre }}</option>
          }
        </select>
        @if (recipienteIdCtrl.invalid && (recipienteIdCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div>
        <label for="almacenamiento_id">Almacenamiento</label>
        <select id="almacenamiento_id" [(ngModel)]="almacenamiento_id" name="almacenamiento_id" #almacenIdCtrl="ngModel"
          required [class.invalid]="almacenIdCtrl.invalid && (almacenIdCtrl.touched || submittedReactivo)">
          <option [ngValue]="''">Seleccione almacenamiento</option>
          @for (a of almacen; track a) {
          <option [value]="a.id">{{ a.nombre }}</option>
          }
        </select>
        @if (almacenIdCtrl.invalid && (almacenIdCtrl.touched || submittedReactivo)) {
        <span class="field-error">Seleccione una opci√≥n</span>
        }
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-create">{{ editMode ? 'Guardar cambios' : 'Crear reactivo' }}</button>
        @if (editMode) {
        <button type="button" (click)="resetReactivoForm()"
          style="margin-left:8px; background:#777; color:#fff; border:1px solid #666;">Cancelar</button>
        }
      </div>
    </form>

    <!-- Mensajes inline eliminados: usar snackbars globales -->
  </section>

  <h2>Inventario de Reactivos</h2>
  <section>
    <!-- Lista y b√∫squeda de reactivos existentes -->
    <div>
      <div class="filters-row reactivos-filters">
        <div>
          <label for="reactLoteQ">Filtrar por Lote</label>
          <input id="reactLoteQ" [(ngModel)]="reactivosLoteQ" (input)="filtrarReactivos()" />
        </div>
        <div>
          <label for="reactCodigoQ">Filtrar por C√≥digo</label>
          <input id="reactCodigoQ" [(ngModel)]="reactivosCodigoQ" (input)="filtrarReactivos()" />
        </div>
        <div>
          <label for="reactNombreQ">Filtrar por Nombre</label>
          <input id="reactNombreQ" [(ngModel)]="reactivosNombreQ" (input)="filtrarReactivos()" />
        </div>
      </div>

      <div class="cards-container">
        @if (reactivos && reactivos.length) {
        <div class="catalogo-stats">
          <span>üß™ Mostrando {{ reactivosFiltrados.length }} de {{ reactivos.length }} reactivos</span>
        </div>
        }

        <div class="catalogo-cards">
          @for (r of reactivosFiltrados; track trackByReactivo($index, r)) {
          <article class="catalog-card reactivo-card" (click)="toggleExpand(r)" [attr.aria-expanded]="isExpanded(r)"
            tabindex="0">
            <div class="card-top">
              <div class="tags">
                <span class="tag"><strong>C√≥digo:</strong> {{ r.codigo }}</span>
                <span class="tag"><strong>Lote:</strong> {{ r.lote }}</span>
                <span class="tag"><strong>Estado:</strong> {{ obtenerNombreEstado(r.estado_id) }}</span>
                <span class="tag"><strong>Marca:</strong> {{ r.marca || '‚Äî' }}</span>
                <span class="tag" [style.borderColor]="getClasifColor(r.clasificacion_id)"><strong>SGA:</strong> {{
                  obtenerNombreClasificacion(r.clasificacion_id) }}</span>

                @if (getVencimientoInfo(r.fecha_vencimiento); as v) {
                <span class="tag" [style.backgroundColor]="v.bg" [style.color]="v.fg" [attr.title]="v.title">
                  {{ v.text }}
                </span>
                }
              </div>

              <div class="pdf-actions" aria-label="Acciones del reactivo" (click)="$event.stopPropagation()">
                <div class="pdf-group">
                  <button type="button" class="pdf-btn view" title="Editar reactivo" aria-label="Editar reactivo"
                    (click)="openEditModal(r)">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Z" fill="currentColor" />
                      <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"
                        fill="currentColor" />
                    </svg>
                  </button>
                  <button type="button" class="pdf-btn delete" *ngIf="canDelete()" title="Eliminar reactivo"
                    aria-label="Eliminar reactivo" (click)="eliminarReactivo(r.lote)">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="card-name" [title]="r.nombre">
              <div class="name-line">{{ r.nombre }}</div>

              <!-- Botones y etiquetas PDF a la derecha -->
              <div class="name-pdfs" (click)="$event.stopPropagation()">
                <div class="pdf-box pdf-sds" role="group" aria-label="SDS controls">
                  <!-- SDS combinado: icono archivo + estado habilitado/inhabilitado -->
                  <button
                    *ngIf="reactivoPdfStatusSig()[r.lote] && reactivoPdfStatusSig()[r.lote].hoja===true"
                    type="button"
                    class="btn pdf-existe"
                    title="Ver hoja de seguridad (SDS)"
                    aria-label="Ver hoja de seguridad (SDS)"
                    (click)="$event.stopPropagation(); onVerHojaReactivo(r.lote)">
                    <span class="pdf-acronym" aria-hidden="true">SDS</span>
                  </button>
                  <span
                    *ngIf="!(reactivoPdfStatusSig()[r.lote] && reactivoPdfStatusSig()[r.lote].hoja===true)"
                    class="tag pdf-no-existe"
                    aria-label="Hoja de seguridad no disponible">
                    <span class="pdf-acronym" aria-hidden="true">SDS</span>
                  </span>
                  <button type="button" class="pdf-btn delete" *ngIf="canDelete()" title="Eliminar hoja de seguridad"
                    aria-label="Eliminar hoja de seguridad"
                    (click)="$event.stopPropagation(); onEliminarHojaReactivo(r.lote)">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </button>
                  <input type="file" accept="application/pdf" (change)="onSubirHojaReactivo($event, r.lote)" #sdsInput
                    style="display:none" />
                  <button type="button" class="pdf-btn upload" title="Subir hoja de seguridad"
                    aria-label="Subir hoja de seguridad" (click)="$event.stopPropagation(); sdsInput.click()">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                      <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                  </button>
                </div>

                <div class="pdf-box pdf-coa" role="group" aria-label="CoA controls">
                  <!-- CoA combinado: icono archivo + estado habilitado/inhabilitado -->
                  <button
                    *ngIf="reactivoPdfStatusSig()[r.lote] && reactivoPdfStatusSig()[r.lote].cert===true"
                    type="button"
                    class="btn pdf-existe"
                    title="Ver certificado de an√°lisis (CoA)"
                    aria-label="Ver certificado de an√°lisis (CoA)"
                    (click)="$event.stopPropagation(); onVerCertReactivo(r.lote)">
                    <span class="pdf-acronym" aria-hidden="true">CoA</span>
                  </button>
                  <span
                    *ngIf="!(reactivoPdfStatusSig()[r.lote] && reactivoPdfStatusSig()[r.lote].cert===true)"
                    class="tag pdf-no-existe"
                    aria-label="Certificado de an√°lisis no disponible">
                    <span class="pdf-acronym" aria-hidden="true">CoA</span>
                  </span>
                  <button type="button" class="pdf-btn delete" *ngIf="canDelete()"
                    title="Eliminar certificado de an√°lisis" aria-label="Eliminar certificado de an√°lisis"
                    (click)="$event.stopPropagation(); onEliminarCertReactivo(r.lote)">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </button>
                  <input type="file" accept="application/pdf" (change)="onSubirCertReactivo($event, r.lote)" #coaInput
                    style="display:none" />
                  <button type="button" class="pdf-btn upload" title="Subir certificado de an√°lisis"
                    aria-label="Subir certificado de an√°lisis" (click)="$event.stopPropagation(); coaInput.click()">
                    <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                      <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                      <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                  </button>
                </div>
              </div>

              <div class="meta-line">
                <span class="chip">{{ obtenerNombreTipo(r.tipo_id) }}</span>
                <span class="chip">{{ 'Cantidad Total:' }} {{ r.cantidad_total }} {{ obtenerNombreUnidad(r.unidad_id) }}</span>
                <span class="chip">Vence: {{ formatearFecha(r.fecha_vencimiento) }}</span>
              </div>

              <span class="toggle-icon" [class.open]="isExpanded(r)" aria-hidden="true">‚ñæ</span>
            </div>

            @if (isExpanded(r)) {
            <div class="card-expand" (click)="$event.stopPropagation()">
              <div class="details-grid">
                <div class="detail-card">
                  <div class="detail-label">Referencia</div>
                  <div class="detail-value">{{ r.referencia || '‚Äî' }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">CAS</div>
                  <div class="detail-value">{{ r.cas || '‚Äî' }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Presentaci√≥n</div>
                  <div class="detail-value">{{ r.presentacion || '‚Äî' }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Cant. x presentaci√≥n</div>
                  <div class="detail-value">{{ r.presentacion_cant || '‚Äî' }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Unidad</div>
                  <div class="detail-value">{{ obtenerNombreUnidad(r.unidad_id) }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Almacenamiento</div>
                  <div class="detail-value">{{ obtenerNombreAlmacenamiento(r.almacenamiento_id) }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Recipiente</div>
                  <div class="detail-value">{{ obtenerNombreTipoRecipiente(r.tipo_recipiente_id) }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Adquisici√≥n</div>
                  <div class="detail-value">{{ formatearFecha(r.fecha_adquisicion) }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">Vencimiento</div>
                  <div class="detail-value">{{ formatearFecha(r.fecha_vencimiento) }}</div>
                </div>

                @if (r.observaciones) {
                <div class="detail-card detail-full">
                  <div class="detail-label">Observaciones</div>
                  <div class="detail-value">{{ r.observaciones }}</div>
                </div>
                }
              </div>
            </div>
            }
          </article>
          }
        </div>

        @if (reactivosFiltrados && reactivosFiltrados.length === 0) {
        <p>No hay reactivos que coincidan con los filtros.</p>
        }
        @if (reactivos && reactivos.length === 0) {
        <p>No hay reactivos cargados.</p>
        }
      </div>
    </div>
  </section>

  <!-- Modal de edici√≥n de reactivo -->
  @if (editModalOpen) {
  <div class="modal-backdrop" (click)="closeEditModal()"></div>
  <div class="modal" role="dialog" aria-modal="true" aria-label="Editar reactivo" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <button type="button" class="close-btn" (click)="closeEditModal()" aria-label="Cerrar">√ó</button>
    </div>
    <form class="form-grid" #editForm="ngForm" (ngSubmit)="guardarEdicion(editForm)">
      <div class="field-sm">
        <label for="edit_lote">Lote</label>
        <input id="edit_lote" [(ngModel)]="editFormData.lote" name="edit_lote" #editLoteCtrl="ngModel" required
          [class.invalid]="editLoteCtrl.invalid && (editLoteCtrl.touched || editSubmitted)" />
        @if (editLoteCtrl.invalid && (editLoteCtrl.touched || editSubmitted)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="edit_codigo">C√≥digo (cat√°logo)</label>
        <input id="edit_codigo" [(ngModel)]="editFormData.codigo" name="edit_codigo" #editCodigoCtrl="ngModel" required
          [class.invalid]="editCodigoCtrl.invalid && (editCodigoCtrl.touched || editSubmitted)" />
        @if (editCodigoCtrl.invalid && (editCodigoCtrl.touched || editSubmitted)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="edit_nombre">Nombre (cat√°logo)</label>
        <input id="edit_nombre" [(ngModel)]="editFormData.nombre" name="edit_nombre" #editNombreCtrl="ngModel" required
          [class.invalid]="editNombreCtrl.invalid && (editNombreCtrl.touched || editSubmitted)" />
        @if (editNombreCtrl.invalid && (editNombreCtrl.touched || editSubmitted)) {
        <span class="field-error">Requerido</span>
        }
      </div>

      <div>
        <label for="edit_marca">Marca</label>
        <input id="edit_marca" [(ngModel)]="editFormData.marca" name="edit_marca" />
      </div>

      <div>
        <label for="edit_referencia">Referencia</label>
        <input id="edit_referencia" [(ngModel)]="editFormData.referencia" name="edit_referencia" />
      </div>

      <div>
        <label for="edit_cas">CAS</label>
        <input id="edit_cas" [(ngModel)]="editFormData.cas" name="edit_cas" title="Formato: 64-17-5"
          #editCasCtrl="ngModel" (blur)="onEditCasBlur()"
          [class.invalid]="editCasCtrl.invalid && (editCasCtrl.touched || editSubmitted)" />
        @if (editCasCtrl.errors?.['pattern'] && (editCasCtrl.touched || editSubmitted)) {
        <span class="field-error">Formato CAS inv√°lido</span>
        }
      </div>

      <div class="field-sm">
        <label for="edit_presentacion">Presentaci√≥n</label>
        <input id="edit_presentacion" type="number" [(ngModel)]="editFormData.presentacion" name="edit_presentacion"
          min="0" step="any" />
      </div>

      <div class="field-sm">
        <label for="edit_presentacion_cant">Cantidad x presentaci√≥n</label>
        <input id="edit_presentacion_cant" type="number" [(ngModel)]="editFormData.presentacion_cant"
          name="edit_presentacion_cant" min="0" step="any" />
      </div>

      <div class="field-sm">
        <label for="edit_cantidad_total">Cantidad total</label>
        <input id="edit_cantidad_total" type="number" [(ngModel)]="editFormData.cantidad_total"
          name="edit_cantidad_total" readonly />
      </div>

      <div>
        <label for="edit_fecha_adq">Fecha de adquisici√≥n</label>
        <input id="edit_fecha_adq" type="date" [(ngModel)]="editFormData.fecha_adquisicion" name="edit_fecha_adq" />
      </div>

      <div>
        <label for="edit_fecha_venc">Fecha de vencimiento</label>
        <input id="edit_fecha_venc" type="date" [(ngModel)]="editFormData.fecha_vencimiento" name="edit_fecha_venc" />
      </div>

      <div>
        <label for="edit_tipo">Tipo reactivo</label>
        <select id="edit_tipo" [(ngModel)]="editFormData.tipo_id" name="edit_tipo">
          <option [ngValue]="''">Seleccione tipo</option>
          @for (t of tipos; track t) {
          <option [value]="t.id">{{ t.nombre }}</option>
          }
        </select>
      </div>

      <div>
        <label for="edit_clasif">Clasificaci√≥n SGA</label>
        <select id="edit_clasif" [(ngModel)]="editFormData.clasificacion_id" name="edit_clasif"
          [ngStyle]="getSelectStyleForId(editFormData.clasificacion_id)">
          <option [ngValue]="''">Seleccione clasificaci√≥n</option>
          @for (c of clasif; track c) {
          <option [value]="c.id" [style.backgroundColor]="getClasifColorByName(c.nombre)"
            [style.color]="getClasifTextColor(getClasifColorByName(c.nombre))">{{ c.nombre }}</option>
          }
        </select>
      </div>

      <div>
        <label for="edit_unidad">Unidad</label>
        <select id="edit_unidad" [(ngModel)]="editFormData.unidad_id" name="edit_unidad">
          <option [ngValue]="''">Seleccione unidad</option>
          @for (u of unidades; track u) {
          <option [value]="u.id">{{ u.nombre }}</option>
          }
        </select>
      </div>

      <div>
        <label for="edit_estado">Estado</label>
        <select id="edit_estado" [(ngModel)]="editFormData.estado_id" name="edit_estado">
          <option [ngValue]="''">Seleccione estado</option>
          @for (e of estado; track e) {
          <option [value]="e.id">{{ e.nombre }}</option>
          }
        </select>
      </div>

      <div>
        <label for="edit_recipiente">Recipiente</label>
        <select id="edit_recipiente" [(ngModel)]="editFormData.tipo_recipiente_id" name="edit_recipiente">
          <option [ngValue]="''">Seleccione recipiente</option>
          @for (rtp of recipiente; track rtp) {
          <option [value]="rtp.id">{{ rtp.nombre }}</option>
          }
        </select>
      </div>

      <div>
        <label for="edit_almacen">Almacenamiento</label>
        <select id="edit_almacen" [(ngModel)]="editFormData.almacenamiento_id" name="edit_almacen">
          <option [ngValue]="''">Seleccione almacenamiento</option>
          @for (a of almacen; track a) {
          <option [value]="a.id">{{ a.nombre }}</option>
          }
        </select>
      </div>

      <div class="full-row">
        <label for="edit_obs">Observaciones</label>
        <textarea id="edit_obs" [(ngModel)]="editFormData.observaciones" name="edit_obs" rows="2"></textarea>
      </div>

      <div class="actions">
        <button type="submit">Guardar cambios</button>
      </div>
    </form>

  </div>
  }
  
</div>