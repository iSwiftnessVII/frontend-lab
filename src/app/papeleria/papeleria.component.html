<div class="liba-theme container papeleria-page">
  <h1>
    <i class="fas fa-paperclip"></i>
    | Gestión de Papelería
  </h1>

  <div class="dashboard-cards">
    <div class="action-card" (click)="toggleFormulario('crear')" [class.active]="formularioActivo === 'crear'">
      <i class="fas fa-plus-circle"></i>
      <span>Registrar Papelería</span>
    </div>
  </div>

  @if (formularioActivo === 'crear' && !esAuxiliar) {
    <div class="form-section">
      <h2>
        <i class="fas fa-plus-circle"></i>
        | Registrar Papelería
      </h2>
      <section>
        <form class="form-grid" (submit)="submitPapeleria($event)">
          <div>
            <label for="pap_nombre">Nombre *</label>
            <input id="pap_nombre" name="pap_nombre" [(ngModel)]="nombre" required placeholder="Ej: Marcador permanente" />
          </div>

          <div>
            <label for="pap_presentacion">Presentación *</label>
            <select id="pap_presentacion" name="pap_presentacion" [(ngModel)]="presentacion" required>
              <option [ngValue]="''">Seleccione</option>
              @for (p of presentaciones; track p) {
                <option [ngValue]="p">{{ p }}</option>
              }
            </select>
          </div>

          <div>
            <label for="pap_cant_adq">Cantidad adquirida *</label>
            <input id="pap_cant_adq" name="pap_cant_adq" type="number" min="0" step="1" [(ngModel)]="cantidad_adquirida" required placeholder="Ej: 10" />
          </div>

          <div>
            <label for="pap_cant_exist">Cantidad existente *</label>
            <input id="pap_cant_exist" name="pap_cant_exist" type="number" min="0" step="1" [(ngModel)]="cantidad_existente" required placeholder="Ej: 7" />
          </div>

          <div>
            <label for="pap_marca">Marca</label>
            <input id="pap_marca" name="pap_marca" [(ngModel)]="marca" placeholder="Ej: Sharpie" />
          </div>

          <div>
            <label for="pap_fecha">Fecha de adquisición</label>
            <input id="pap_fecha" name="pap_fecha" type="date" [(ngModel)]="fecha_adquisicion" />
          </div>

          <div>
            <label for="pap_ubicacion">Ubicación</label>
            <input id="pap_ubicacion" name="pap_ubicacion" [(ngModel)]="ubicacion" placeholder="Ej: Almacén 1 / Estante A" />
          </div>

          <div>
            <label for="pap_imagen">Imagen</label>
            <input id="pap_imagen" name="pap_imagen" type="file" accept="image/*" (change)="onImagenChange($event)" />
            @if (imagenPreviewUrl) {
              <div class="image-preview">
                <img [src]="imagenPreviewUrl" alt="Vista previa" />
              </div>
            }
          </div>

          <div class="full-row">
            <label for="pap_descripcion">Descripción</label>
            <textarea id="pap_descripcion" name="pap_descripcion" rows="2" [(ngModel)]="descripcion" placeholder="Detalle del insumo de papelería"></textarea>
          </div>

          <div class="full-row">
            <label for="pap_observaciones">Observaciones</label>
            <textarea id="pap_observaciones" name="pap_observaciones" rows="2" [(ngModel)]="observaciones"></textarea>
          </div>

          <div class="actions">
            <button class="btn-compact" type="submit">Registrar</button>
          </div>
        </form>
      </section>
    </div>
  }

  <div class="list-section">
    <div class="list-top">
      <div class="search">
        <label for="pap_q">Buscar</label>
        <input id="pap_q" name="pap_q" [(ngModel)]="papeleriaQ" placeholder="Nombre, marca, ubicación..." />
      </div>
      <div class="actions">
        <button class="btn-compact" type="button" (click)="cargarPapeleria()" [disabled]="cargando()">Recargar</button>
      </div>
    </div>

    @if (cargando()) {
      <div class="sin-equipos">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando papelería...</p>
      </div>
    } @else {
      @if (papeleriaFiltrada().length === 0) {
        <p class="sin-equipos">No hay papelería para mostrar</p>
      } @else {
        <div class="equipos-grid">
          <div class="fade-in">
            @for (p of papeleriaFiltrada(); track papeleriaKey(p, $index)) {
              @let key = papeleriaKey(p, $index);
              @let img = resolvePapeleriaImageUrl(p);
              <article
                class="equipo-card papeleria-card"
                (click)="togglePapeleriaDetails(key)"
                [attr.aria-expanded]="detallesVisibles[key] ? 'true' : 'false'"
                tabindex="0"
              >
                <div class="papeleria-card-row">
                  <div class="papeleria-card-image">
                    @if (img) {
                      <img [src]="img" [alt]="'Imagen de ' + (p?.nombre || 'papelería')" />
                    } @else {
                      <div class="papeleria-card-image-fallback" aria-hidden="true">
                        <i class="fas fa-image"></i>
                      </div>
                    }
                  </div>

                  <div class="papeleria-card-main">
                    <div class="card-top">
                      <div class="tags">
                        <span class="tag"><strong>ID:</strong> {{ key }}</span>
                        <span class="tag"><strong>Existente:</strong> {{ p?.cantidad_existente ?? '—' }}</span>
                        <span class="tag"><strong>Presentación:</strong> {{ p?.presentacion || '—' }}</span>
                        <span class="tag"><strong>Marca:</strong> {{ p?.marca || '—' }}</span>
                      </div>
                      <div class="pdf-actions">
                        @if (canDelete()) {
                          <button type="button" class="pdf-btn edit"
                                  title="Editar papelería"
                                  aria-label="Editar papelería"
                                  (click)="$event.stopPropagation(); editPapeleria(p)">
                            <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Z" fill="currentColor" />
                              <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z" fill="currentColor" />
                            </svg>
                          </button>
                          <button type="button" class="pdf-btn delete"
                                  title="Eliminar papelería"
                                  aria-label="Eliminar papelería"
                                  (click)="$event.stopPropagation(); deletePapeleria(p)">
                            <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                              <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            </svg>
                          </button>
                        }
                      </div>
                    </div>

                    <div class="card-name">
                      <div class="name-line">{{ p?.nombre || '—' }}</div>
                      <div class="meta-line">
                        <span class="chip">Ubicación: {{ p?.ubicacion || '—' }}</span>
                        <span class="chip">Adquisición: {{ limpiarFecha(p?.fecha_adquisicion) }}</span>
                      </div>
                      <div class="card-right-controls" (click)="$event.stopPropagation()">
                        <div class="qty-field">
                          <input class="qty-input" type="number" min="1" step="1" [(ngModel)]="reduceCantidadByKey[key]" placeholder="0" />
                          <button type="button" class="pdf-btn delete qty-reduce-btn" [disabled]="isReduciendo(key)" (click)="reducirExistencias(p, key, $event)" title="Reducir existencias" aria-label="Reducir existencias">
                            <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
                              <rect x="3" y="3" width="18" height="18" rx="6" fill="none" stroke="currentColor" stroke-width="1.6"></rect>
                              <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                      <span class="toggle-icon" [class.open]="detallesVisibles[key]" aria-hidden="true">▾</span>
                    </div>

                    @if (detallesVisibles[key]) {
                      <div class="equipo-detalles" (click)="$event.stopPropagation()">
                        <div class="detalle-grid-compacto">
                          <div class="detalle-item">
                            <div class="detalle-label">Cantidad adquirida</div>
                            <span>{{ p?.cantidad_adquirida ?? '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Cantidad existente</div>
                            <span>{{ p?.cantidad_existente ?? '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Presentación</div>
                            <span>{{ p?.presentacion || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Marca</div>
                            <span>{{ p?.marca || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Ubicación</div>
                            <span>{{ p?.ubicacion || '—' }}</span>
                          </div>
                          <div class="detalle-item">
                            <div class="detalle-label">Fecha adquisición</div>
                            <span>{{ limpiarFecha(p?.fecha_adquisicion) }}</span>
                          </div>
                          <div class="detalle-item detalle-item-full">
                            <div class="detalle-label">Descripción</div>
                            <span>{{ p?.descripcion || '—' }}</span>
                          </div>
                          <div class="detalle-item detalle-item-full">
                            <div class="detalle-label">Observaciones</div>
                            <span>{{ p?.observaciones || '—' }}</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </article>
            }
          </div>
        </div>
      }
    }
  </div>
</div>

@if (editPapeleriaModalOpen || editPapeleriaModalClosing) {
  <div class="modal-overlay" [class.closing]="editPapeleriaModalClosing" (click)="closeEditPapeleriaModal()">
    <div class="edit-modal" [class.closing]="editPapeleriaModalClosing" (click)="$event.stopPropagation()">
      <h3>Editar papelería #{{ editPapeleriaId }}</h3>

      <div class="edit-modal-body">
        <div class="form-grid">
          <div>
            <label>Nombre *</label>
            <input [(ngModel)]="editNombre" />
          </div>
          <div>
            <label>Presentación *</label>
            <select [(ngModel)]="editPresentacion">
              <option [ngValue]="''">Seleccione</option>
              @for (p of presentaciones; track p) {
                <option [ngValue]="p">{{ p }}</option>
              }
            </select>
          </div>
          <div>
            <label>Cantidad adquirida *</label>
            <input type="number" min="0" step="1" [(ngModel)]="editCantidadAdquirida" />
          </div>
          <div>
            <label>Marca</label>
            <input [(ngModel)]="editMarca" />
          </div>
          <div>
            <label>Fecha de adquisición</label>
            <input type="date" [(ngModel)]="editFechaAdquisicion" />
          </div>
          <div>
            <label>Ubicación</label>
            <input [(ngModel)]="editUbicacion" />
          </div>
          <div>
            <label>Imagen</label>
            <input type="file" accept="image/*" (change)="onEditImagenChange($event)" />
            @if (editImagenPreviewUrl) {
              <div class="image-preview">
                <img [src]="editImagenPreviewUrl" alt="Vista previa" />
              </div>
            }
          </div>
          <div class="full-row">
            <label>Descripción</label>
            <textarea rows="2" [(ngModel)]="editDescripcion"></textarea>
          </div>
          <div class="full-row">
            <label>Observaciones</label>
            <textarea rows="2" [(ngModel)]="editObservaciones"></textarea>
          </div>
        </div>
      </div>

      <div class="edit-modal-actions">
        <button type="button" class="btn-compact" (click)="saveEditPapeleria()">Guardar</button>
        <button type="button" class="btn-compact" (click)="closeEditPapeleriaModal()">Cancelar</button>
      </div>
    </div>
  </div>
}
