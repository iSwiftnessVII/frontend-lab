<div class="container dashboard-page">
  @if (esAuxiliar) {
    <div class="auxiliar-label">(Solo visualización)</div>
  }

  <!-- Estado de carga -->
  @if (cargando()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando datos del dashboard...</p>
    </div>
  }

  <!-- Métricas Principales -->
  @if (!cargando()) {
    <div class="metrics-grid metrics-grid--primary">
      <div class="metric-pie-card metric-pie-card--xl metric-pie-card--reactivos metric-pie-card--ghost">
        <div class="reactivos-grid">
          <div class="reactivos-col reactivos-col--donut">
            <div class="metric-pie metric-pie--donut" [style.background]="getReactivosPieStyle()">
              <div class="metric-pie-center">
                <div class="metric-pie-center-value">{{ formatearNumero(metricas().totalReactivos) }}</div>
                <div class="metric-pie-center-label">Total de Reactivos</div>
              </div>
            </div>
            <div class="metric-pie-legend metric-pie-legend--center">
              @if (getReactivosPieSegments(); as segs) {
                @if (segs.length) {
                  @for (seg of segs; track seg.label) {
                    <div class="metric-pie-item notif-row">
                      <span class="metric-pie-line" [style.background]="seg.color"></span>
                      <span class="metric-pie-label-text">{{ seg.label }}</span>
                      <span class="metric-pie-value">{{ formatearNumero(seg.value) }}</span>
                    </div>
                  }
                } @else {
                  <div class="metric-pie-empty">Sin datos</div>
                }
              }
            </div>
          </div>
          <div class="reactivos-col reactivos-col--legend"></div>
          <div class="reactivos-col reactivos-col--consumo">
            <div class="metric-pie-top">
              <div class="metric-pie-icon consumo"><i class="fas fa-syringe"></i></div>
              <div class="metric-pie-title">Consumo de Reactivos</div>
              <div class="metric-pie-total">{{ formatearNumero(getConsumoTotal()) }}</div>
            </div>
            <div class="consumo-scroll">
              @if (consumoData(); as consumos) {
                @if (consumos.length) {
                  <div class="notif-list consumo-scroll-track">
                    @for (c of consumos; track $index) {
                      <div class="notif-row">
                        <div class="notif-main">
                          <span class="notif-name" [title]="c.nombre || 'Sin nombre'">{{ c.nombre || 'Sin nombre' }}</span>
                          <span class="notif-code" [title]="c.codigo || '—'">{{ c.codigo || '—' }}</span>
                          <span class="notif-lote" [title]="c.lote || '—'">{{ c.lote || '—' }}</span>
                        </div>
                        <div class="notif-date">Consumido: {{ formatearNumero(c.cantidad || 0) }} {{ c.unidad_simbolo || c.unidad || '' }}</div>
                      </div>
                    }
                    @for (c of consumos; track $index) {
                      <div class="notif-row">
                        <div class="notif-main">
                          <span class="notif-name" [title]="c.nombre || 'Sin nombre'">{{ c.nombre || 'Sin nombre' }}</span>
                          <span class="notif-code" [title]="c.codigo || '—'">{{ c.codigo || '—' }}</span>
                          <span class="notif-lote" [title]="c.lote || '—'">{{ c.lote || '—' }}</span>
                        </div>
                        <div class="notif-date">Consumido: {{ formatearNumero(c.cantidad || 0) }} {{ c.unidad_simbolo || c.unidad || '' }}</div>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="consumo-empty">Sin consumos</div>
                }
              }
            </div>
            <div class="metric-pie-foot">
              <div class="metric-foot-item">
                <span class="metric-foot-label">Registros</span>
                <span class="metric-foot-value">{{ formatearNumero(getConsumoTotal()) }}</span>
              </div>
              <div class="metric-foot-item">
                <span class="metric-foot-label">Ultimo</span>
                <span class="metric-foot-value">
                  @if (getConsumoUltimaFecha(); as fecha) {
                    {{ fecha | date:'dd/MM/yyyy' }}
                  } @else {
                    —
                  }
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    @if (!esAuxiliar) {
      <section class="submetrics-section">
        <h2 class="submetrics-title">
          <i class="fas fa-clipboard-check"></i>
          Métricas de Solicitudes
        </h2>

        <div class="solicitudes-charts">
          <article class="chart-card">
            <div class="chart-header">
              <span>Viabilidad</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="bar-chart">
                <div class="bar-item">
                  <div class="bar bar-viable" [style.--bar]="getPctRounded(contarSolicitudesViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesViable()) }}</span>
                  </div>
                  <div class="bar-label">Viables {{ getPctRounded(contarSolicitudesViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-no-viable" [style.--bar]="getPctRounded(contarSolicitudesNoViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesNoViable()) }}</span>
                  </div>
                  <div class="bar-label">No viables {{ getPctRounded(contarSolicitudesNoViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-revision" [style.--bar]="getPctRounded(contarSolicitudesRevisionPendiente()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesRevisionPendiente()) }}</span>
                  </div>
                  <div class="bar-label">Revision {{ getPctRounded(contarSolicitudesRevisionPendiente()) }}%</div>
                </div>
              </div>
            }
          </article>

          <article class="chart-card">
            <div class="chart-header">
              <span>Ofertas</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="pie-wrap">
                <div class="pie-chart" [style.background]="getOfertaPieStyle()"></div>
                <div class="pie-legend">
                  <div class="legend-item">
                    <span class="legend-dot dot-oferta"></span>
                    Con oferta {{ getPctRounded(contarSolicitudesConOferta()) }}%
                  </div>
                  <div class="legend-item">
                    <span class="legend-dot dot-sin-oferta"></span>
                    Sin oferta {{ getPctRounded(contarSolicitudesSinOferta()) }}%
                  </div>
                  <div class="legend-item">
                    <span class="legend-dot dot-oferta-pendiente"></span>
                    Pendiente {{ getPctRounded(contarSolicitudesOfertaPendiente()) }}%
                  </div>
                </div>
              </div>
            }
          </article>

          <article class="chart-card">
            <div class="chart-header">
              <span>Avance del proceso</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="bar-chart">
                <div class="bar-item">
                  <div class="bar bar-total" [style.--bar]="'100%'">
                    <span class="bar-value">{{ formatearNumero(getSolicitudesTotal()) }}</span>
                  </div>
                  <div class="bar-label">Total 100%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-viable" [style.--bar]="getPctRounded(contarSolicitudesViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesViable()) }}</span>
                  </div>
                  <div class="bar-label">Viables {{ getPctRounded(contarSolicitudesViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-oferta" [style.--bar]="getPctRounded(contarSolicitudesConOferta()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesConOferta()) }}</span>
                  </div>
                  <div class="bar-label">Con oferta {{ getPctRounded(contarSolicitudesConOferta()) }}%</div>
                </div>
              </div>
            }
          </article>
        </div>
      </section>
    }
  }

</div>
