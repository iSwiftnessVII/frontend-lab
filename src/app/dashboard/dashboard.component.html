<div class="container dashboard-page">
  <h1>
    <i class="fas fa-chart-line"></i>
    Dashboard del Laboratorio
    @if (esAuxiliar) {
      <span class="auxiliar-label">(Solo visualización)</span>
    }
  </h1>

  <!-- Estado de carga -->
  @if (cargando()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando datos del dashboard...</p>
    </div>
  }

  <!-- Métricas Principales -->
  @if (!cargando()) {
    <div class="metrics-grid">
      <!-- Tarjeta Insumos -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/insumos')">
          <div class="metric-icon insumos">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalInsumos) }}</div>
            <div class="metric-label">Total Insumos</div>
            <div class="metric-subtitle">Inventario actual</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon insumos">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalInsumos) }}</div>
            <div class="metric-label">Total Insumos</div>
            <div class="metric-subtitle">Inventario actual</div>
          </div>
        </div>
      }

      <!-- Tarjeta Reactivos -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/reactivos')">
          <div class="metric-icon reactivos">
            <i class="fas fa-flask"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalReactivos) }}</div>
            <div class="metric-label">Total Reactivos</div>
            <div class="metric-subtitle">
              @if (reactivosProximosVencer().length > 0) {
                <span class="warning-badge">
                  <i class="fas fa-clock"></i>
                  {{ reactivosProximosVencer().length }} por vencer
                </span>
              } @else {
                <span class="success-badge">
                  <i class="fas fa-check-circle"></i>
                  Al día
                </span>
              }
            </div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon reactivos">
            <i class="fas fa-flask"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalReactivos) }}</div>
            <div class="metric-label">Total Reactivos</div>
            <div class="metric-subtitle">
              @if (reactivosProximosVencer().length > 0) {
                <span class="warning-badge">
                  <i class="fas fa-clock"></i>
                  {{ reactivosProximosVencer().length }} por vencer
                </span>
              } @else {
                <span class="success-badge">
                  <i class="fas fa-check-circle"></i>
                  Al día
                </span>
              }
            </div>
          </div>
        </div>
      }

      <!-- Tarjeta Solicitudes -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/solicitudes')">
          <div class="metric-icon solicitudes">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalSolicitudes) }}</div>
            <div class="metric-label">Total Solicitudes</div>
            <div class="metric-subtitle">
              {{ contarSolicitudesViable() }} viables • {{ contarSolicitudesConOferta() }} con oferta
            </div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon solicitudes">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalSolicitudes) }}</div>
            <div class="metric-label">Total Solicitudes</div>
            <div class="metric-subtitle">
              {{ contarSolicitudesViable() }} viables • {{ contarSolicitudesConOferta() }} con oferta
            </div>
          </div>
        </div>
      }

      <!-- Tarjeta Clientes -->
      @if (!esAuxiliar) {
        <div class="metric-card">
          <div class="metric-icon clientes">
            <i class="fas fa-users"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalClientes) }}</div>
            <div class="metric-label">Total Clientes</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon clientes">
            <i class="fas fa-users"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalClientes) }}</div>
            <div class="metric-label">Total Clientes</div>
          </div>
        </div>
      }

      <!-- Tarjeta Papelería -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/papeleria')">
          <div class="metric-icon papeleria">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalPapeleria) }}</div>
            <div class="metric-label">Total Papelería</div>
            <div class="metric-subtitle">Ítems de catálogo</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon papeleria">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalPapeleria) }}</div>
            <div class="metric-label">Total Papelería</div>
            <div class="metric-subtitle">Ítems de catálogo</div>
          </div>
        </div>
      }

      <!-- Tarjeta Equipos -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/equipos')">
          <div class="metric-icon equipos">
            <i class="fas fa-microscope"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalEquipos) }}</div>
            <div class="metric-label">Total Equipos</div>
            <div class="metric-subtitle">Instrumentos registrados</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon equipos">
            <i class="fas fa-microscope"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalEquipos) }}</div>
            <div class="metric-label">Total Equipos</div>
            <div class="metric-subtitle">Instrumentos registrados</div>
          </div>
        </div>
      }

      <!-- Tarjeta Materiales Volumétricos -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/materiales-volumetricos')">
          <div class="metric-icon volumetricos">
            <i class="fas fa-vial"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalVolumetricos) }}</div>
            <div class="metric-label">Materiales Volumétricos</div>
            <div class="metric-subtitle">Unidades registradas</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon volumetricos">
            <i class="fas fa-vial"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalVolumetricos) }}</div>
            <div class="metric-label">Materiales Volumétricos</div>
            <div class="metric-subtitle">Unidades registradas</div>
          </div>
        </div>
      }

      <!-- Tarjeta Materiales Referencia -->
      @if (!esAuxiliar) {
        <div class="metric-card" (click)="navigate('/materiales-referencia')">
          <div class="metric-icon referencia">
            <i class="fas fa-weight"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalReferencia) }}</div>
            <div class="metric-label">Materiales Referencia</div>
            <div class="metric-subtitle">Unidades registradas</div>
          </div>
        </div>
      } @else {
        <div class="metric-card">
          <div class="metric-icon referencia">
            <i class="fas fa-weight"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatearNumero(metricas().totalReferencia) }}</div>
            <div class="metric-label">Materiales Referencia</div>
            <div class="metric-subtitle">Unidades registradas</div>
          </div>
        </div>
      }
    </div>

    <section class="submetrics-section">
      <h2 class="submetrics-title">
        <i class="fas fa-clipboard-check"></i>
        Métricas de Solicitudes
      </h2>

      <div class="submetrics-grid">
        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon viable">
            <i class="fas fa-check"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesViable()) }}</div>
            <div class="submetric-label">Viables</div>
          </div>
        </div>

        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon no-viable">
            <i class="fas fa-times"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesNoViable()) }}</div>
            <div class="submetric-label">No viables</div>
          </div>
        </div>

        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon revision">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesRevisionPendiente()) }}</div>
            <div class="submetric-label">Revisión pendiente</div>
          </div>
        </div>

        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon oferta">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesConOferta()) }}</div>
            <div class="submetric-label">Con oferta</div>
          </div>
        </div>

        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon sin-oferta">
            <i class="fas fa-file-invoice"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesSinOferta()) }}</div>
            <div class="submetric-label">Sin oferta</div>
          </div>
        </div>

        <div class="submetric-card" [class.clickable]="!esAuxiliar" (click)="navigate('/solicitudes')">
          <div class="submetric-icon oferta-pendiente">
            <i class="fas fa-clock"></i>
          </div>
          <div class="submetric-content">
            <div class="submetric-value">{{ formatearNumero(contarSolicitudesOfertaPendiente()) }}</div>
            <div class="submetric-label">Oferta pendiente</div>
          </div>
        </div>
      </div>
    </section>
  }

  <!-- Sección de Alertas Expandibles -->
  @if (!cargando() && (reactivosProximosVencer().length > 0 || reactivosVencidos().length > 0)) {
    <div class="alert-section">
      <h2>
        <i class="fas fa-exclamation-triangle"></i>
        Alertas Importantes
      </h2>

      <div class="expandible-alerts-container">
        <!-- Tarjeta expandible para Reactivos Próximos a Vencer -->
        @if (reactivosProximosVencer().length > 0) {
          <div class="expandible-card" [class.expanded]="proximosVencerExpanded">
            <div class="expandible-header" (click)="toggleProximosVencer()">
              <div class="expandible-title">
                <i class="fas fa-clock"></i>
                <h3>Reactivos Próximos a Vencer</h3>
                <span class="alert-count warning">{{ reactivosProximosVencer().length }}</span>
              </div>
              <i class="fas fa-chevron-down expand-icon" [class.rotated]="proximosVencerExpanded"></i>
            </div>
            
            <div class="expandible-content" [class.visible]="proximosVencerExpanded">
              <div class="alert-card warning">
                <div class="alert-content">
                  <p>Tienes <strong>{{ reactivosProximosVencer().length }}</strong> reactivos que vencen en los próximos 30 días:</p>
                  <div class="reactivos-list">
                    @for (reactivo of reactivosProximosVencer(); track $index) {
                      <div class="reactivo-item">
                        <div class="reactivo-header">
                          <i class="fas fa-flask reactivo-icon"></i>
                          <span class="reactivo-name">{{ reactivo.nombre }}</span>
                        </div>
                        <div class="reactivo-footer">
                          <div class="reactivo-lote-container">
                            <i class="fas fa-barcode"></i>
                            <span class="lote-label">Lote:</span>
                            <span class="lote-value">{{ reactivo.lote }}</span>
                          </div>
                          <div class="reactivo-fecha-container advertencia">
                            <i class="fas fa-calendar-exclamation"></i>
                            <span class="fecha-label">Vence:</span>
                            <span class="fecha-value">{{ reactivo.fecha_vencimiento | date:'dd/MM/yyyy' }}</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Tarjeta expandible para Reactivos Vencidos -->
        @if (reactivosVencidos().length > 0) {
          <div class="expandible-card" [class.expanded]="vencidosExpanded">
            <div class="expandible-header" (click)="toggleVencidos()">
              <div class="expandible-title">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Reactivos Vencidos</h3>
                <span class="alert-count danger">{{ reactivosVencidos().length }}</span>
              </div>
              <i class="fas fa-chevron-down expand-icon" [class.rotated]="vencidosExpanded"></i>
            </div>
            
            <div class="expandible-content" [class.visible]="vencidosExpanded">
              <div class="alert-card danger">
                <div class="alert-content">
                  <p>Hay <strong>{{ reactivosVencidos().length }}</strong> reactivos vencidos:</p>
                  <div class="reactivos-list">
                    @for (reactivo of reactivosVencidos(); track $index) {
                      <div class="reactivo-item">
                        <div class="reactivo-header">
                          <i class="fas fa-flask reactivo-icon"></i>
                          <span class="reactivo-name">{{ reactivo.nombre }}</span>
                        </div>
                        <div class="reactivo-footer">
                          <div class="reactivo-lote-container">
                            <i class="fas fa-barcode"></i>
                            <span class="lote-label">Lote:</span>
                            <span class="lote-value">{{ reactivo.lote }}</span>
                          </div>
                          <div class="reactivo-fecha-container peligro">
                            <span class="fecha-label">Vencido:</span>
                            <span class="fecha-value">{{ reactivo.fecha_vencimiento | date:'dd/MM/yyyy' }}</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }



</div>
