<div class="container dashboard-page">
  @if (esAuxiliar) {
    <div class="auxiliar-label">(Solo visualización)</div>
  }

  <!-- Estado de carga -->
  @if (cargando()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando datos del dashboard...</p>
    </div>
  }

  <!-- Métricas Principales -->
  @if (!cargando()) {
    <div class="metrics-grid metrics-grid--primary">
      <div class="metric-pie-card metric-pie-card--xl" [class.clickable]="!esAuxiliar" (click)="navigate('/reactivos')">
        <div class="metric-pie-top">
          <div class="metric-pie-icon reactivos"><i class="fas fa-flask"></i></div>
          <div class="metric-pie-title">Reactivos</div>
          <div class="metric-pie-total">{{ formatearNumero(metricas().totalReactivos) }}</div>
        </div>
        <div class="metric-pie-body">
          <div class="metric-pie" [style.background]="getReactivosPieStyle()"></div>
          <div class="metric-pie-legend">
            @if (getReactivosPieSegments(); as segs) {
              @if (segs.length) {
                @for (seg of segs; track seg.label) {
                  <div class="metric-pie-item">
                    <span class="metric-pie-dot" [style.background]="seg.color"></span>
                    <span class="metric-pie-label">{{ seg.label }}</span>
                    <span class="metric-pie-value">{{ formatearNumero(seg.value) }}</span>
                  </div>
                }
              } @else {
                <div class="metric-pie-empty">Sin datos</div>
              }
            }
          </div>
        </div>
        <div class="metric-pie-foot">
          <div class="metric-foot-item">
            <span class="metric-foot-label">Vencidos</span>
            <span class="metric-foot-value">{{ formatearNumero(reactivosVencidos().length) }}</span>
          </div>
          <div class="metric-foot-item">
            <span class="metric-foot-label">Por vencer</span>
            <span class="metric-foot-value">{{ formatearNumero(reactivosProximosVencer().length) }}</span>
          </div>
        </div>
      </div>

      <div class="metric-pie-card metric-pie-card--xl">
        <div class="metric-pie-top">
          <div class="metric-pie-icon consumo"><i class="fas fa-syringe"></i></div>
          <div class="metric-pie-title">Consumo de Reactivos</div>
          <div class="metric-pie-total">{{ formatearNumero(getConsumoTotal()) }}</div>
        </div>
        <div class="metric-pie-body">
          <div class="metric-pie" [style.background]="getConsumoPieStyle()"></div>
          <div class="metric-pie-legend">
            @if (getConsumoPieSegments(); as segs) {
              @if (segs.length) {
                @for (seg of segs; track seg.label) {
                  <div class="metric-pie-item">
                    <span class="metric-pie-dot" [style.background]="seg.color"></span>
                    <span class="metric-pie-label">{{ seg.label }}</span>
                    <span class="metric-pie-value">{{ formatearNumero(seg.value) }}</span>
                  </div>
                }
              } @else {
                <div class="metric-pie-empty">Sin datos</div>
              }
            }
          </div>
        </div>
        <div class="metric-pie-foot">
          <div class="metric-foot-item">
            <span class="metric-foot-label">Registros</span>
            <span class="metric-foot-value">{{ formatearNumero(getConsumoTotal()) }}</span>
          </div>
          <div class="metric-foot-item">
            <span class="metric-foot-label">Ultimo</span>
            <span class="metric-foot-value">
              @if (getConsumoUltimaFecha(); as fecha) {
                {{ fecha | date:'dd/MM/yyyy' }}
              } @else {
                —
              }
            </span>
          </div>
        </div>
      </div>
    </div>

    @if (!esAuxiliar) {
      <section class="submetrics-section">
        <h2 class="submetrics-title">
          <i class="fas fa-clipboard-check"></i>
          Métricas de Solicitudes
        </h2>

        <div class="solicitudes-charts">
          <article class="chart-card">
            <div class="chart-header">
              <span>Viabilidad</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="bar-chart">
                <div class="bar-item">
                  <div class="bar bar-viable" [style.--bar]="getPctRounded(contarSolicitudesViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesViable()) }}</span>
                  </div>
                  <div class="bar-label">Viables {{ getPctRounded(contarSolicitudesViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-no-viable" [style.--bar]="getPctRounded(contarSolicitudesNoViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesNoViable()) }}</span>
                  </div>
                  <div class="bar-label">No viables {{ getPctRounded(contarSolicitudesNoViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-revision" [style.--bar]="getPctRounded(contarSolicitudesRevisionPendiente()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesRevisionPendiente()) }}</span>
                  </div>
                  <div class="bar-label">Revision {{ getPctRounded(contarSolicitudesRevisionPendiente()) }}%</div>
                </div>
              </div>
            }
          </article>

          <article class="chart-card">
            <div class="chart-header">
              <span>Ofertas</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="pie-wrap">
                <div class="pie-chart" [style.background]="getOfertaPieStyle()"></div>
                <div class="pie-legend">
                  <div class="legend-item">
                    <span class="legend-dot dot-oferta"></span>
                    Con oferta {{ getPctRounded(contarSolicitudesConOferta()) }}%
                  </div>
                  <div class="legend-item">
                    <span class="legend-dot dot-sin-oferta"></span>
                    Sin oferta {{ getPctRounded(contarSolicitudesSinOferta()) }}%
                  </div>
                  <div class="legend-item">
                    <span class="legend-dot dot-oferta-pendiente"></span>
                    Pendiente {{ getPctRounded(contarSolicitudesOfertaPendiente()) }}%
                  </div>
                </div>
              </div>
            }
          </article>

          <article class="chart-card">
            <div class="chart-header">
              <span>Avance del proceso</span>
              <span class="chart-total">{{ formatearNumero(getSolicitudesTotal()) }} total</span>
            </div>
            @if (getSolicitudesTotal() === 0) {
              <p class="chart-empty">Sin solicitudes para graficar.</p>
            } @else {
              <div class="bar-chart">
                <div class="bar-item">
                  <div class="bar bar-total" [style.--bar]="'100%'">
                    <span class="bar-value">{{ formatearNumero(getSolicitudesTotal()) }}</span>
                  </div>
                  <div class="bar-label">Total 100%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-viable" [style.--bar]="getPctRounded(contarSolicitudesViable()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesViable()) }}</span>
                  </div>
                  <div class="bar-label">Viables {{ getPctRounded(contarSolicitudesViable()) }}%</div>
                </div>
                <div class="bar-item">
                  <div class="bar bar-oferta" [style.--bar]="getPctRounded(contarSolicitudesConOferta()) + '%'">
                    <span class="bar-value">{{ formatearNumero(contarSolicitudesConOferta()) }}</span>
                  </div>
                  <div class="bar-label">Con oferta {{ getPctRounded(contarSolicitudesConOferta()) }}%</div>
                </div>
              </div>
            }
          </article>
        </div>
      </section>
    }
  }

</div>
