<div class="liba-theme container referencia-page">
  <header class="page-head">
    <div>
      <h1><i class="fas fa-vials"></i> | Material de Referencia</h1>
      <p>Inventario, historial, intervalos y documentos.</p>
    </div>
    <div class="head-actions">
      <button class="ghost" type="button" (click)="cargarMateriales()">Refrescar</button>
      <button class="primary" type="button" (click)="nuevoMaterial()">Nuevo material</button>
    </div>
  </header>

  <div class="dashboard-cards">
    <div class="action-card" (click)="togglePanel('material')" [class.active]="panelActivo === 'material'">
      <i class="fas fa-boxes"></i>
      <span>Registrar / editar material</span>
    </div>
    <div class="action-card" (click)="togglePanel('historial')" [class.active]="panelActivo === 'historial'">
      <i class="fas fa-history"></i>
      <span>Registrar historial</span>
    </div>
    <div class="action-card" (click)="togglePanel('intervalo')" [class.active]="panelActivo === 'intervalo'">
      <i class="fas fa-calendar-alt"></i>
      <span>Registrar intervalo</span>
    </div>
  </div>

  <section class="form-section" *ngIf="panelActivo === 'material'">
    <div class="section-title">
      <h2><i class="fas fa-vial"></i> Material de referencia</h2>
      <div class="inline-actions" *ngIf="selectedMaterial">
        <button type="button" class="danger ghost" (click)="eliminarMaterial(selectedMaterial.codigo_id)">Eliminar</button>
      </div>
    </div>
    <form class="form-grid" (ngSubmit)="guardarMaterial()">
      <div><label>Código *</label><input type="number" [(ngModel)]="formMaterial.codigo_id" name="codigo_id" required /></div>
      <div><label>Nombre *</label><input [(ngModel)]="formMaterial.nombre_material" name="nombre_material" required /></div>
      <div><label>Rango medición</label><input [(ngModel)]="formMaterial.rango_medicion" name="rango_medicion" /></div>
      <div><label>Marca</label><input [(ngModel)]="formMaterial.marca" name="marca" /></div>
      <div><label>Serie</label><input [(ngModel)]="formMaterial.serie" name="serie" /></div>
      <div><label>Error máx permitido</label><input type="number" step="0.000001" [(ngModel)]="formMaterial.error_max_permitido" name="error_max_permitido" /></div>
      <div><label>Modelo</label><input [(ngModel)]="formMaterial.modelo" name="modelo" /></div>
      <div class="full actions">
        <button type="button" class="ghost" (click)="nuevoMaterial()">Limpiar</button>
        <button type="submit" class="primary">Guardar</button>
      </div>
    </form>
  </section>

  <section class="form-section" *ngIf="panelActivo === 'historial'">
    <div class="section-title"><h2><i class="fas fa-history"></i> Historial</h2></div>
    <form class="form-grid" (ngSubmit)="guardarHistorial()">
      <div><label>Código *</label><input type="number" [(ngModel)]="formHistorial.codigo_material" name="codigo_hist" required /></div>
      <div><label>Consecutivo</label><input type="number" [(ngModel)]="formHistorial.consecutivo" name="consec_hist" /></div>
      <div><label>Fecha</label><input type="date" [(ngModel)]="formHistorial.fecha" name="fecha_hist" /></div>
      <div><label>Tipo historial</label><input [(ngModel)]="formHistorial.tipo_historial_instrumento" name="tipo_hist" /></div>
      <div><label>Código registro</label><input [(ngModel)]="formHistorial.codigo_registro" name="codigo_registro" /></div>
      <div><label>Realizó</label><input [(ngModel)]="formHistorial.realizo" name="realizo" /></div>
      <div><label>Supervisó</label><input [(ngModel)]="formHistorial.superviso" name="superviso" /></div>
      <div class="actions full">
        <button type="submit" class="primary">Agregar historial</button>
      </div>
    </form>
    <div class="records-list" *ngIf="historial.length">
      <div class="record-row" *ngFor="let h of historial">
        <div>
          <strong>#{{ h.consecutivo }}</strong> · {{ h.fecha || 'Sin fecha' }}
          <p>{{ h.tipo_historial_instrumento || 'Sin tipo' }} | Reg: {{ h.codigo_registro || '—' }} | {{ h.realizo || '¿quién?' }} / {{ h.superviso || '¿supervisor?' }}</p>
        </div>
      </div>
    </div>
  </section>

  <section class="form-section" *ngIf="panelActivo === 'intervalo'">
    <div class="section-title"><h2><i class="fas fa-calendar-alt"></i> Intervalos</h2></div>
    <form class="form-grid" (ngSubmit)="guardarIntervalo()">
      <div><label>Código *</label><input type="number" [(ngModel)]="formIntervalo.codigo_material" name="codigo_int" required /></div>
      <div><label>Consecutivo</label><input type="number" [(ngModel)]="formIntervalo.consecutivo" name="consec_int" /></div>
      <div><label>Valor nominal *</label><input type="number" step="0.001" [(ngModel)]="formIntervalo.valor_nominal" name="valor_nominal" required /></div>
      <div><label>Fecha Cal. 1 *</label><input type="date" [(ngModel)]="formIntervalo.fecha_c1" name="fecha_c1" required /></div>
      <div><label>Error Cal. 1 *</label><input type="number" step="0.000001" [(ngModel)]="formIntervalo.error_c1" name="error_c1" required /></div>
      <div><label>Fecha Cal. 2 *</label><input type="date" [(ngModel)]="formIntervalo.fecha_c2" name="fecha_c2" required /></div>
      <div><label>Error Cal. 2 *</label><input type="number" step="0.000001" [(ngModel)]="formIntervalo.error_c2" name="error_c2" required /></div>
      <div><label>Tolerancia</label><input type="number" step="0.000001" [(ngModel)]="formIntervalo.tolerancia" name="tolerancia" /></div>
      <div><label>Incertidumbre exp.</label><input type="number" step="0.000001" [(ngModel)]="formIntervalo.incertidumbre_exp" name="incertidumbre" /></div>
      <div class="full"><label>Deriva</label><input type="number" step="0.0000000001" [(ngModel)]="formIntervalo.deriva" name="deriva" /></div>
      <div><label>Dif. días</label><input type="number" [(ngModel)]="formIntervalo.diferencia_tiempo_dias" name="dif_dias" /></div>
      <div><label>Desv. abs</label><input type="number" step="0.00000001" [(ngModel)]="formIntervalo.desviacion_abs" name="desv_abs" /></div>
      <div><label>Intervalo (días)</label><input type="number" step="0.01" [(ngModel)]="formIntervalo.intervalo_calibracion_dias" name="intervalo_dias" /></div>
      <div><label>Intervalo (años)</label><input type="number" step="0.000001" [(ngModel)]="formIntervalo.intervalo_calibracion_anos" name="intervalo_anos" /></div>
      <div class="actions full">
        <button type="submit" class="primary">Agregar intervalo</button>
      </div>
    </form>
    <div class="records-list" *ngIf="intervalos.length">
      <div class="record-row" *ngFor="let i of intervalos">
        <div>
          <strong>#{{ i.consecutivo }}</strong> · Valor nominal: {{ i.valor_nominal }}
          <p>{{ i.fecha_c1 }} / {{ i.fecha_c2 }} | Error: {{ i.error_c1 }} / {{ i.error_c2 }}</p>
          <p>Tolerancia: {{ i.tolerancia || '—' }} | Intervalo días: {{ i.intervalo_calibracion_dias || '—' }}</p>
        </div>
      </div>
    </div>
  </section>

  <section class="form-section">
    <div class="section-title">
      <h2><i class="fas fa-list"></i> Materiales registrados</h2>
      <div class="filters">
        <input type="search" placeholder="Buscar por código, nombre, marca, modelo" [(ngModel)]="filtro" name="filtro" />
      </div>
    </div>

    <div *ngIf="loading" class="empty-state"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>
    <div *ngIf="!loading && !materialesFiltrados().length" class="empty-state"><i class="fas fa-inbox"></i> Sin materiales</div>

    <div class="inventory-cards" *ngIf="!loading && materialesFiltrados().length">
      <article class="inventory-card" *ngFor="let m of materialesFiltrados()" (click)="seleccionarMaterial(m)">
        <button class="inventory-delete-btn" title="Eliminar" (click)="eliminarMaterial(m.codigo_id, $event)">&times;</button>
        <div class="inventory-card-body">
          <div class="inventory-card-header">
            <div class="inventory-title-row">
              <h3 class="inventory-title">{{ m.nombre_material }}</h3>
              <span class="inventory-item-tag">{{ m.codigo_id }}</span>
            </div>
            <div class="inventory-brand">{{ m.marca || 'Sin marca' }}</div>
          </div>
          <div class="inventory-stats">
            <span>Rango: <strong>{{ m.rango_medicion || '—' }}</strong></span>
            <span>Serie: <strong>{{ m.serie || '—' }}</strong></span>
            <span>Error máx: <strong>{{ m.error_max_permitido || '—' }}</strong></span>
          </div>
          <div class="card-actions">
            <button class="ghost" type="button" (click)="seleccionarMaterial(m, $event)">Ver detalle</button>
            <button class="ghost" type="button" (click)="togglePanel('material'); seleccionarMaterial(m, $event)">Editar</button>
          </div>
        </div>
      </article>
    </div>
  </section>

  <section class="detail-section" *ngIf="selectedMaterial">
    <div class="detail-header">
      <div>
        <h2>{{ selectedMaterial.nombre_material }}</h2>
        <p>Código {{ selectedMaterial.codigo_id }} · {{ selectedMaterial.marca || 'Sin marca' }}</p>
      </div>
      <div class="badge muted">Modelo: {{ selectedMaterial.modelo || '—' }}</div>
    </div>

    <div class="detail-grid">
      <div class="card mini">
        <header><h3>Historial</h3><span class="pill">{{ historial.length }}</span></header>
        <div class="card-body compact" *ngIf="historial.length; else noHist">
          <div class="record-row" *ngFor="let h of historial">
            <div>
              <strong>#{{ h.consecutivo }}</strong> · {{ h.fecha || 'Sin fecha' }}
              <p>{{ h.tipo_historial_instrumento || 'Sin tipo' }} | {{ h.realizo || '¿quién?' }} / {{ h.superviso || '¿supervisor?' }}</p>
            </div>
          </div>
        </div>
        <ng-template #noHist><div class="empty-state small">Sin historial</div></ng-template>
      </div>

      <div class="card mini">
        <header><h3>Intervalos</h3><span class="pill">{{ intervalos.length }}</span></header>
        <div class="card-body compact" *ngIf="intervalos.length; else noInt">
          <div class="record-row" *ngFor="let i of intervalos">
            <div>
              <strong>#{{ i.consecutivo }}</strong> · Valor: {{ i.valor_nominal }}
              <p>{{ i.fecha_c1 }} / {{ i.fecha_c2 }} | Err: {{ i.error_c1 }} / {{ i.error_c2 }}</p>
              <p>Tolerancia: {{ i.tolerancia || '—' }} | Intervalo días: {{ i.intervalo_calibracion_dias || '—' }}</p>
            </div>
          </div>
        </div>
        <ng-template #noInt><div class="empty-state small">Sin intervalos</div></ng-template>
      </div>

      <div class="card mini">
        <header><h3>Documentos</h3><span class="pill">{{ pdfs.length }}</span></header>
        <div class="card-body compact">
          <div class="form-grid">
            <div><label>Categoría</label>
              <select [(ngModel)]="uploadCategoria" name="categoria_pdf">
                <option value="general">General</option>
                <option value="certificado">Certificado</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="full"><label>Archivo PDF</label><input type="file" (change)="onFileChange($event)" /></div>
            <div class="actions full"><button class="primary" type="button" (click)="subirPdf()">Subir PDF</button></div>
          </div>
          <div class="records-list" *ngIf="pdfs.length; else noPdf">
            <div class="record-row" *ngFor="let p of pdfs">
              <div>
                <strong>{{ p.nombre }}</strong>
                <p>{{ p.categoria || 'Sin categoría' }}</p>
              </div>
              <div class="row-actions">
                <a [href]="p.url" target="_blank" class="ghost">Ver</a>
                <button class="danger ghost" type="button" (click)="eliminarPdf(p.id)">Eliminar</button>
              </div>
            </div>
          </div>
          <ng-template #noPdf><div class="empty-state small">Sin documentos</div></ng-template>
        </div>
      </div>
    </div>
  </section>

  <div class="alerts" *ngIf="error || success">
    <div class="alert error" *ngIf="error">{{ error }}</div>
    <div class="alert success" *ngIf="success">{{ success }}</div>
  </div>
</div>
